"use strict";(self["webpackChunk_N_E"]=self["webpackChunk_N_E"]||[]).push([[135],{9745:(e,t,n)=>{n.d(t,{H9:()=>lp,aU:()=>lN,x7:()=>h1});var r=n(1055);var s=n(2881);var i=n(6702);var o=n(1280);var a=n(2107);var c=n(927);var u=n(7358);var l=n(9641)["Buffer"];const h="@firebase/firestore",d="4.9.2";class f{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}f.UNAUTHENTICATED=new f(null),f.GOOGLE_CREDENTIALS=new f("google-credentials-uid"),f.FIRST_PARTY=new f("first-party-uid"),f.MOCK_USER=new f("mock-user");let m="12.3.0";const g=new i.Vy("@firebase/firestore");function p(){return g.logLevel}function y(e){g.setLogLevel(e)}function w(e,...t){if(g.logLevel<=i.$b.DEBUG){const n=t.map(_);g.debug(`Firestore (${m}): ${e}`,...n)}}function v(e,...t){if(g.logLevel<=i.$b.ERROR){const n=t.map(_);g.error(`Firestore (${m}): ${e}`,...n)}}function I(e,...t){if(g.logLevel<=i.$b.WARN){const n=t.map(_);g.warn(`Firestore (${m}): ${e}`,...n)}}function _(e){if("string"==typeof e)return e;try{return function e(e){return JSON.stringify(e)}(e)}catch(t){return e}}function b(e,t,n){let r="Unexpected state";"string"==typeof t?r=t:n=t,T(e,r,n)}function T(e,t,n){let r=`FIRESTORE (${m}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==n)try{r+=" CONTEXT: "+JSON.stringify(n)}catch(e){r+=" CONTEXT: "+n}throw v(r),new Error(r)}function E(e,t,n,r){let s="Unexpected state";"string"==typeof n?s=n:r=n,e||T(t,s,r)}function S(e,t){e||b(57014,t)}function x(e,t){return e}const N={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class D extends o.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class C{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class A{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class k{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(f.UNAUTHENTICATED))}shutdown(){}}class R{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class M{constructor(e){this.t=e,this.currentUser=f.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){E(void 0===this.o,42304);let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new C;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new C,e.enqueueRetryable(()=>r(this.currentUser))};const i=()=>{const t=s;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},o=e=>{w("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),i())};this.t.onInit(e=>o(e)),setTimeout(()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(w("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new C)}},0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(w("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(E("string"==typeof t.accessToken,31837,{l:t}),new A(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return E(null===e||"string"==typeof e,2055,{h:e}),new f(e)}}class V{constructor(e,t,n){this.P=e,this.T=t,this.I=n,this.type="FirstParty",this.user=f.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class O{constructor(e,t,n){this.P=e,this.T=t,this.I=n}getToken(){return Promise.resolve(new V(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(f.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class F{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class P{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,(0,r.xZ)(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){E(void 0===this.o,3512);const n=e=>{null!=e.error&&w("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.m;return this.m=e.token,w("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};const r=e=>{w("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){const e=this.V.getImmediate({optional:!0});e?r(e):w("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new F(this.p));const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(E("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new F(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class L{getToken(){return Promise.resolve(new F(""))}invalidateToken(){}start(e,t){}shutdown(){}}function q(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class U{static newId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=62*Math.floor(256/62);let n="";for(;n.length<20;){const r=q(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%62))}return n}}function B(e,t){return e<t?-1:e>t?1:0}function z(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.charAt(r),s=t.charAt(r);if(n!==s)return K(n)===K(s)?B(n,s):K(n)?1:-1}return B(e.length,t.length)}const $=55296,G=57343;function K(e){const t=e.charCodeAt(0);return t>=$&&t<=G}function j(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}function Q(e){return e+"\0"}const W="__name__";class J{constructor(e,t,n){void 0===t?t=0:t>e.length&&b(637,{offset:t,range:e.length}),void 0===n?n=e.length-t:n>e.length-t&&b(1746,{length:n,range:e.length-t}),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===J.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof J?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=J.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return B(e.length,t.length)}static compareSegments(e,t){const n=J.isNumericId(e),r=J.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?J.extractNumericId(e).compare(J.extractNumericId(t)):z(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return a.jz.fromString(e.substring(4,e.length-2))}}class H extends J{construct(e,t,n){return new H(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new D(N.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new H(t)}static emptyPath(){return new H([])}}const Y=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class X extends J{construct(e,t,n){return new X(e,t,n)}static isValidIdentifier(e){return Y.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),X.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===W}static keyField(){return new X([W])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new D(N.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new D(N.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new D(N.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new D(N.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new X(t)}static emptyPath(){return new X([])}}class Z{constructor(e){this.path=e}static fromPath(e){return new Z(H.fromString(e))}static fromName(e){return new Z(H.fromString(e).popFirst(5))}static empty(){return new Z(H.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===H.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return H.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Z(new H(e.slice()))}}function ee(e,t,n){if(!n)throw new D(N.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function et(e,t,n,r){if(!0===t&&!0===r)throw new D(N.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function en(e){if(!Z.isDocumentKey(e))throw new D(N.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function er(e){if(Z.isDocumentKey(e))throw new D(N.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function es(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function ei(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function e(e){if(e.constructor)return e.constructor.name;return null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":b(12329,{type:typeof e})}function eo(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new D(N.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=ei(e);throw new D(N.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function ea(e,t){if(t<=0)throw new D(N.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}function ec(e,t){const n={typeString:e};return t&&(n.value=t),n}function eu(e,t){if(!es(e))throw new D(N.INVALID_ARGUMENT,"JSON must be an object");let n;for(const r in t)if(t[r]){const s=t[r].typeString,i="value"in t[r]?{value:t[r].value}:void 0;if(!(r in e)){n=`JSON missing required field: '${r}'`;break}const o=e[r];if(s&&typeof o!==s){n=`JSON field '${r}' must be a ${s}.`;break}if(void 0!==i&&o!==i.value){n=`Expected '${r}' field to equal '${i.value}'`;break}}if(n)throw new D(N.INVALID_ARGUMENT,n);return!0}const el=-0xe7791f700,eh=1e6;class ed{static now(){return ed.fromMillis(Date.now())}static fromDate(e){return ed.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*eh);return new ed(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new D(N.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new D(N.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<el)throw new D(N.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=0x3afff44180)throw new D(N.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/eh}_compareTo(e){return this.seconds===e.seconds?B(this.nanoseconds,e.nanoseconds):B(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:ed._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(eu(e,ed._jsonSchema))return new ed(e.seconds,e.nanoseconds)}valueOf(){const e=this.seconds-el;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}ed._jsonSchemaVersion="firestore/timestamp/1.0",ed._jsonSchema={type:ec("string",ed._jsonSchemaVersion),seconds:ec("number"),nanoseconds:ec("number")};class ef{static fromTimestamp(e){return new ef(e)}static min(){return new ef(new ed(0,0))}static max(){return new ef(new ed(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}const em=-1;class eg{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function ep(e){return e.fields.find(e=>2===e.kind)}function ey(e){return e.fields.filter(e=>2!==e.kind)}function ew(e,t){let n=B(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(n=eI(e.fields[r],t.fields[r]),0!==n)return n;return B(e.fields.length,t.fields.length)}eg.UNKNOWN_ID=-1;class ev{constructor(e,t){this.fieldPath=e,this.kind=t}}function eI(e,t){const n=X.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:B(e.kind,t.kind)}class e_{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new e_(0,eE.min())}}function eb(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=ef.fromTimestamp(1e9===r?new ed(n+1,0):new ed(n,r));return new eE(s,Z.empty(),t)}function eT(e){return new eE(e.readTime,e.key,em)}class eE{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new eE(ef.min(),Z.empty(),em)}static max(){return new eE(ef.max(),Z.empty(),em)}}function eS(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Z.comparator(e.documentKey,t.documentKey),0!==n?n:B(e.largestBatchId,t.largestBatchId))}const ex="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class eN{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function eD(e){if(e.code!==N.FAILED_PRECONDITION||e.message!==ex)throw e;w("LocalStore","Unexpectedly lost primary lease")}class eC{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&b(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new eC((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{const t=e();return t instanceof eC?t:eC.resolve(t)}catch(e){return eC.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):eC.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):eC.reject(t)}static resolve(e){return new eC((t,n)=>{t(e)})}static reject(e){return new eC((t,n)=>{n(e)})}static waitFor(e){return new eC((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=eC.resolve(!1);for(const n of e)t=t.next(e=>e?eC.resolve(e):n());return t}static forEach(e,t){const n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new eC((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const c=a;t(e[c]).next(e=>{i[c]=e,++o,o===s&&n(i)},e=>r(e))}})}static doWhile(e,t){return new eC((n,r)=>{const s=()=>{!0===e()?t().next(()=>{s()},r):n()};s()})}}const eA="SimpleDb";class ek{static open(e,t,n,r){try{return new ek(t,e.transaction(r,n))}catch(e){throw new eO(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new C,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new eO(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{const n=eU(t.target.error);this.S.reject(new eO(e,n))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(w(eA,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}C(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new eP(t)}}class eR{static delete(e){w(eA,"Removing database:",e);return eL((0,o.mS)().indexedDB.deleteDatabase(e)).toPromise()}static v(){if(!(0,o.zW)())return!1;if(eR.F())return!0;const e=(0,o.ZQ)(),t=eR.M(e),n=0<t&&t<10,r=eM(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static F(){return"undefined"!=typeof u&&"YES"===u.__PRIVATE_env?.__PRIVATE_USE_MOCK_PERSISTENCE}static O(e,t){return e.store(t)}static M(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}constructor(e,t,n){this.name=e,this.version=t,this.N=n,this.B=null;12.2===eR.M((0,o.ZQ)())&&v("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async L(e){return this.db||(w(eA,"Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new eO(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new D(N.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new D(N.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new eO(e,r))},r.onupgradeneeded=e=>{w(eA,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.N.k(t,r.transaction,e.oldVersion,this.version).next(()=>{w(eA,"Database upgrade to version "+this.version+" complete")})}})),this.q&&(this.db.onversionchange=e=>this.q(e)),this.db}$(e){this.q=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.L(e);const t=ek.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.C(),e)).catch(e=>(t.abort(e),eC.reject(e))).toPromise();return i.catch(()=>{}),await t.D,i}catch(n){const e=n,t="FirebaseError"!==e.name&&i<3;if(w(eA,"Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eM(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class eV{constructor(e){this.U=e,this.K=!1,this.W=null}get isDone(){return this.K}get G(){return this.W}set cursor(e){this.U=e}done(){this.K=!0}j(e){this.W=e}delete(){return eL(this.U.delete())}}class eO extends D{constructor(e,t){super(N.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eF(e){return"IndexedDbTransactionError"===e.name}class eP{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(w(eA,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(w(eA,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eL(n)}add(e){w(eA,"ADD",this.store.name,e,e);return eL(this.store.add(e))}get(e){return eL(this.store.get(e)).next(t=>(void 0===t&&(t=null),w(eA,"GET",this.store.name,e,t),t))}delete(e){w(eA,"DELETE",this.store.name,e);return eL(this.store.delete(e))}count(){w(eA,"COUNT",this.store.name);return eL(this.store.count())}J(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new eC((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{const e=this.cursor(n),t=[];return this.H(e,(e,n)=>{t.push(n)}).next(()=>t)}}Y(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new eC((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}Z(e,t){w(eA,"DELETE ALL",this.store.name);const n=this.options(e,t);n.X=!1;const r=this.cursor(n);return this.H(r,(e,t,n)=>n.delete())}ee(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.H(r,t)}te(e){const t=this.cursor({});return new eC((n,r)=>{t.onerror=e=>{const t=eU(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}H(e,t){const n=[];return new eC((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new eV(s),o=t(s.primaryKey,s.value,i);if(o instanceof eC){const e=o.catch(e=>(i.done(),eC.reject(e)));n.push(e)}i.isDone?r():null===i.G?s.continue():s.continue(i.G)}}).next(()=>eC.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eL(e){return new eC((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=eU(e.target.error);n(t)}})}let eq=!1;function eU(e){const t=eR.M((0,o.ZQ)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new D("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eq||(eq=!0,setTimeout(()=>{throw e},0)),e}}return e}const eB="IndexBackfiller";class ez{constructor(e,t){this.asyncQueue=e,this.ne=t,this.task=null}start(){this.re(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}re(e){w(eB,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{const e=await this.ne.ie();w(eB,`Documents written: ${e}`)}catch(e){eF(e)?w(eB,"Ignoring IndexedDB error during index backfill: ",e):await eD(e)}await this.re(6e4)})}}class e${constructor(e,t){this.localStore=e,this.persistence=t}async ie(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.se(t,e))}se(e,t){const n=new Set;let r=t,s=!0;return eC.doWhile(()=>!0===s&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return w(eB,`Processing collection: ${t}`),this.oe(e,t,r).next(e=>{r-=e,n.add(t)});s=!1})).next(()=>t-r)}oe(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next(()=>this._e(r,n)).next(n=>(w(eB,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>s.size)}))}_e(e,t){let n=e;return t.changes.forEach((e,t)=>{const r=eT(t);eS(r,n)>0&&(n=r)}),new eE(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eG{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ae(e),this.ue=e=>t.writeSequenceNumber(e))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ue&&this.ue(e),e}}eG.ce=-1;const eK=-1;function ej(e){return null==e}function eQ(e){return 0===e&&1/e==-1/0}function eW(e){return"number"==typeof e&&Number.isInteger(e)&&!eQ(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const eJ="\x01";function eH(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=eX(t)),t=eY(e.get(n),t);return eX(t)}function eY(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case eJ:n+="\x01\x11";break;default:n+=r}}return n}function eX(e){return e+eJ+"\x01"}function eZ(e){const t=e.length;if(E(t>=2,64408,{path:e}),2===t)return E(e.charAt(0)===eJ&&"\x01"===e.charAt(1),56145,{path:e}),H.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf(eJ,i);(t<0||t>n)&&b(50515,{path:e});switch(e.charAt(t+1)){case"\x01":const o=e.substring(i,t);let a;0===s.length?a=o:(s+=o,a=s,s=""),r.push(a);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:b(61167,{path:e})}i=t+2}return new H(r)}const e0="remoteDocuments",e1="owner",e2="owner",e4="mutationQueues",e3="userId",e6="mutations",e5="batchId",e8="userMutationsIndex",e9=["userId","batchId"];function e7(e,t){return[e,eH(t)]}function te(e,t,n){return[e,eH(t),n]}const tt={},tn="documentMutations",tr="remoteDocumentsV14",ts=["prefixPath","collectionGroup","readTime","documentId"],ti="documentKeyIndex",to=["prefixPath","collectionGroup","documentId"],ta="collectionGroupIndex",tc=["collectionGroup","readTime","prefixPath","documentId"],tu="remoteDocumentGlobal",tl="remoteDocumentGlobalKey",th="targets",td="queryTargetsIndex",tf=["canonicalId","targetId"],tm="targetDocuments",tg=["targetId","path"],tp="documentTargetsIndex",ty=["path","targetId"],tw="targetGlobalKey",tv="targetGlobal",tI="collectionParents",t_=["collectionId","parent"],tb="clientMetadata",tT="clientId",tE="bundles",tS="bundleId",tx="namedQueries",tN="name",tD="indexConfiguration",tC="indexId",tA="collectionGroupIndex",tk="collectionGroup",tR="indexState",tM=["indexId","uid"],tV="sequenceNumberIndex",tO=["uid","sequenceNumber"],tF="indexEntries",tP=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tL="documentKeyIndex",tq=["indexId","uid","orderedDocumentKey"],tU="documentOverlays",tB=["userId","collectionPath","documentId"],tz="collectionPathOverlayIndex",t$=["userId","collectionPath","largestBatchId"],tG="collectionGroupOverlayIndex",tK=["userId","collectionGroup","largestBatchId"],tj="globals",tQ="name",tW=[...[...[...[...[e4,e6,tn,e0,th,e1,tv,tm],tb],tu],tI],tE,tx],tJ=[...tW,tU],tH=[e4,e6,tn,tr,th,e1,tv,tm,tb,tu,tI,tE,tx,tU],tY=tH,tX=[...tY,tD,tR,tF],tZ=tX,t0=[...tX,tj],t1=t0;class t2 extends eN{constructor(e,t){super(),this.le=e,this.currentSequenceNumber=t}}function t4(e,t){const n=x(e);return eR.O(n.le,t)}function t3(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function t6(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function t5(e,t){const n=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function t8(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class t9{constructor(e,t){this.comparator=e,this.root=t||ne.EMPTY}insert(e,t){return new t9(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,ne.BLACK,null,null))}remove(e){return new t9(this.comparator,this.root.remove(e,this.comparator).copy(null,null,ne.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){const e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new t7(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new t7(this.root,e,this.comparator,!1)}getReverseIterator(){return new t7(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new t7(this.root,e,this.comparator,!0)}}class t7{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class ne{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:ne.RED,this.left=null!=r?r:ne.EMPTY,this.right=null!=s?s:ne.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new ne(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return ne.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return ne.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,ne.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,ne.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw b(43730,{key:this.key,value:this.value});if(this.right.isRed())throw b(14113,{key:this.key,value:this.value});const e=this.left.check();if(e!==this.right.check())throw b(27949);return e+(this.isRed()?0:1)}}ne.EMPTY=null,ne.RED=!0,ne.BLACK=!1;ne.EMPTY=new class e{constructor(){this.size=0}get key(){throw b(57766)}get value(){throw b(16141)}get color(){throw b(16727)}get left(){throw b(29726)}get right(){throw b(36894)}copy(e,t,n,r,s){return this}insert(e,t,n){return new ne(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class nt{constructor(e){this.comparator=e,this.data=new t9(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();){if(!e(n.getNext().key))return}}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new nn(this.data.getIterator())}getIteratorFrom(e){return new nn(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof nt))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new nt(this.comparator);return t.data=e,t}}class nn{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function nr(e){return e.hasNext()?e.getNext():void 0}class ns{constructor(e){this.fields=e,e.sort(X.comparator)}static empty(){return new ns([])}unionWith(e){let t=new nt(X.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ns(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return j(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ni extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function no(){return"undefined"!=typeof atob}class na{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function e(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ni("Invalid base64 string: "+e):e}}(e);return new na(t)}static fromUint8Array(e){const t=function e(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new na(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function e(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function e(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return B(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}na.EMPTY_BYTE_STRING=new na("");const nc=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function nu(e){if(E(!!e,39018),"string"==typeof e){let t=0;const n=nc.exec(e);if(E(!!n,46558,{timestamp:e}),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:nl(e.seconds),nanos:nl(e.nanos)}}function nl(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function nh(e){return"string"==typeof e?na.fromBase64String(e):na.fromUint8Array(e)}const nd="server_timestamp",nf="__type__",nm="__previous_value__",ng="__local_write_time__";function np(e){const t=(e?.mapValue?.fields||{})[nf]?.stringValue;return t===nd}function ny(e){const t=e.mapValue.fields[nm];return np(t)?ny(t):t}function nw(e){const t=nu(e.mapValue.fields[ng].timestampValue);return new ed(t.seconds,t.nanos)}class nv{constructor(e,t,n,r,s,i,o,a,c,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=c,this.isUsingEmulator=u}}const nI="(default)";class n_{constructor(e,t){this.projectId=e,this.database=t||nI}static empty(){return new n_("","")}get isDefaultDatabase(){return this.database===nI}isEqual(e){return e instanceof n_&&e.projectId===this.projectId&&e.database===this.database}}const nb="__type__",nT="__max__",nE={mapValue:{fields:{__type__:{stringValue:nT}}}},nS="__vector__",nx="value",nN={nullValue:"NULL_VALUE"};function nD(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?np(e)?4:nK(e)?0x1fffffffffffff:n$(e)?10:11:b(28295,{value:e})}function nC(e,t){if(e===t)return!0;const n=nD(e);if(n!==nD(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return nw(e).isEqual(nw(t));case 3:return function e(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=nu(e.timestampValue),r=nu(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function e(e,t){return nh(e.bytesValue).isEqual(nh(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function e(e,t){return nl(e.geoPointValue.latitude)===nl(t.geoPointValue.latitude)&&nl(e.geoPointValue.longitude)===nl(t.geoPointValue.longitude)}(e,t);case 2:return function e(e,t){if("integerValue"in e&&"integerValue"in t)return nl(e.integerValue)===nl(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=nl(e.doubleValue),r=nl(t.doubleValue);return n===r?eQ(n)===eQ(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return j(e.arrayValue.values||[],t.arrayValue.values||[],nC);case 10:case 11:return function e(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(t3(n)!==t3(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!nC(n[e],r[e])))return!1;return!0}(e,t);default:return b(52216,{left:e})}}function nA(e,t){return void 0!==(e.values||[]).find(e=>nC(e,t))}function nk(e,t){if(e===t)return 0;const n=nD(e),r=nD(t);if(n!==r)return B(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return B(e.booleanValue,t.booleanValue);case 2:return function e(e,t){const n=nl(e.integerValue||e.doubleValue),r=nl(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return nR(e.timestampValue,t.timestampValue);case 4:return nR(nw(e),nw(t));case 5:return z(e.stringValue,t.stringValue);case 6:return function e(e,t){const n=nh(e),r=nh(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function e(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=B(n[e],r[e]);if(0!==t)return t}return B(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function e(e,t){const n=B(nl(e.latitude),nl(t.latitude));if(0!==n)return n;return B(nl(e.longitude),nl(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return nM(e.arrayValue,t.arrayValue);case 10:return function e(e,t){const n=e.fields||{},r=t.fields||{},s=n[nx]?.arrayValue,i=r[nx]?.arrayValue,o=B(s?.values?.length||0,i?.values?.length||0);if(0!==o)return o;return nM(s,i)}(e.mapValue,t.mapValue);case 11:return function e(e,t){if(e===nE.mapValue&&t===nE.mapValue)return 0;if(e===nE.mapValue)return 1;if(t===nE.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let e=0;e<r.length&&e<i.length;++e){const t=z(r[e],i[e]);if(0!==t)return t;const o=nk(n[r[e]],s[i[e]]);if(0!==o)return o}return B(r.length,i.length)}(e.mapValue,t.mapValue);default:throw b(23264,{he:n})}}function nR(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return B(e,t);const n=nu(e),r=nu(t),s=B(n.seconds,r.seconds);return 0!==s?s:B(n.nanos,r.nanos)}function nM(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=nk(n[e],r[e]);if(t)return t}return B(n.length,r.length)}function nV(e){return nO(e)}function nO(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function e(e){const t=nu(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function e(e){return nh(e).toBase64()}(e.bytesValue):"referenceValue"in e?function e(e){return Z.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function e(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function e(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=nO(r);return t+"]"}(e.arrayValue):"mapValue"in e?function e(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${nO(e.fields[s])}`;return n+"}"}(e.mapValue):b(61005,{value:e})}function nF(e){switch(nD(e)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=ny(e);return t?16+nF(t):16;case 5:return 2*e.stringValue.length;case 6:return nh(e.bytesValue).approximateByteSize();case 7:return e.referenceValue.length;case 9:return function e(e){return(e.values||[]).reduce((e,t)=>e+nF(t),0)}(e.arrayValue);case 10:case 11:return function e(e){let t=0;return t6(e.fields,(e,n)=>{t+=e.length+nF(n)}),t}(e.mapValue);default:throw b(13486,{value:e})}}function nP(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function nL(e){return!!e&&"integerValue"in e}function nq(e){return!!e&&"arrayValue"in e}function nU(e){return!!e&&"nullValue"in e}function nB(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nz(e){return!!e&&"mapValue"in e}function n$(e){const t=(e?.mapValue?.fields||{})[nb]?.stringValue;return t===nS}function nG(e){if(e.geoPointValue)return{geoPointValue:{...e.geoPointValue}};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:{...e.timestampValue}};if(e.mapValue){const t={mapValue:{fields:{}}};return t6(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nG(n)),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nG(e.arrayValue.values[n]);return t}return{...e}}function nK(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===nT}const nj={mapValue:{fields:{[nb]:{stringValue:nS},[nx]:{arrayValue:{}}}}};function nQ(e){return"nullValue"in e?nN:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?nP(n_.empty(),Z.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?n$(e)?nj:{mapValue:{}}:b(35942,{value:e})}function nW(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?nP(n_.empty(),Z.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?nj:"mapValue"in e?n$(e)?{mapValue:{}}:nE:b(61959,{value:e})}function nJ(e,t){const n=nk(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function nH(e,t){const n=nk(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class nY{constructor(e){this.value=e}static empty(){return new nY({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!nz(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nG(t)}setAll(e){let t=X.emptyPath(),n={},r=[];e.forEach((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=nG(e):r.push(s.lastSegment())});const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());nz(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return nC(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nz(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){t6(t,(t,n)=>e[t]=n);for(const t of n)delete e[t]}clone(){return new nY(nG(this.value))}}function nX(e){const t=[];return t6(e.fields,(e,n)=>{const r=new X([e]);if(nz(n)){const e=nX(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)}),new ns(t)}class nZ{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new nZ(e,0,ef.min(),ef.min(),ef.min(),nY.empty(),0)}static newFoundDocument(e,t,n,r){return new nZ(e,1,t,ef.min(),n,r,0)}static newNoDocument(e,t){return new nZ(e,2,t,ef.min(),ef.min(),nY.empty(),0)}static newUnknownDocument(e,t){return new nZ(e,3,t,ef.min(),ef.min(),nY.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(ef.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nY.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nY.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ef.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof nZ&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new nZ(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class n0{constructor(e,t){this.position=e,this.inclusive=t}}function n1(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(i.field.isKeyField())r=Z.comparator(Z.fromName(o.referenceValue),n.key);else{r=nk(o,n.data.field(i.field))}if("desc"===i.dir&&(r*=-1),0!==r)break}return r}function n2(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++){if(!nC(e.position[n],t.position[n]))return!1}return!0}class n4{constructor(e,t="asc"){this.field=e,this.dir=t}}function n3(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class n6{}class n5 extends n6{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new ro(e,t,n):"array-contains"===t?new rl(e,n):"in"===t?new rh(e,n):"not-in"===t?new rd(e,n):"array-contains-any"===t?new rf(e,n):new n5(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new ra(e,n):new rc(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(nk(t,this.value)):null!==t&&nD(this.value)===nD(t)&&this.matchesComparison(nk(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return b(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class n8 extends n6{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new n8(e,t)}matches(e){return n9(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Pe||(this.Pe=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}}function n9(e){return"and"===e.op}function n7(e){return"or"===e.op}function re(e){return rt(e)&&n9(e)}function rt(e){for(const t of e.filters)if(t instanceof n8)return!1;return!0}function rn(e){if(e instanceof n5)return e.field.canonicalString()+e.op.toString()+nV(e.value);if(re(e))return e.filters.map(e=>rn(e)).join(",");{const t=e.filters.map(e=>rn(e)).join(",");return`${e.op}(${t})`}}function rr(e,t){return e instanceof n5?function e(e,t){return t instanceof n5&&e.op===t.op&&e.field.isEqual(t.field)&&nC(e.value,t.value)}(e,t):e instanceof n8?function e(e,t){if(t instanceof n8&&e.op===t.op&&e.filters.length===t.filters.length){return e.filters.reduce((e,n,r)=>e&&rr(n,t.filters[r]),!0)}return!1}(e,t):void b(19439)}function rs(e,t){const n=e.filters.concat(t);return n8.create(n,e.op)}function ri(e){return e instanceof n5?function e(e){return`${e.field.canonicalString()} ${e.op} ${nV(e.value)}`}(e):e instanceof n8?function e(e){return e.op.toString()+" {"+e.getFilters().map(ri).join(" ,")+"}"}(e):"Filter"}class ro extends n5{constructor(e,t,n){super(e,t,n),this.key=Z.fromName(n.referenceValue)}matches(e){const t=Z.comparator(e.key,this.key);return this.matchesComparison(t)}}class ra extends n5{constructor(e,t){super(e,"in",t),this.keys=ru("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class rc extends n5{constructor(e,t){super(e,"not-in",t),this.keys=ru("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function ru(e,t){return(t.arrayValue?.values||[]).map(e=>Z.fromName(e.referenceValue))}class rl extends n5{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return nq(t)&&nA(t.arrayValue,this.value)}}class rh extends n5{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&nA(this.value.arrayValue,t)}}class rd extends n5{constructor(e,t){super(e,"not-in",t)}matches(e){if(nA(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!nA(this.value.arrayValue,t)}}class rf extends n5{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!nq(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>nA(this.value.arrayValue,e))}}class rm{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.Te=null}}function rg(e,t=null,n=[],r=[],s=null,i=null,o=null){return new rm(e,t,n,r,s,i,o)}function rp(e){const t=x(e);if(null===t.Te){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>rn(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>(function e(e){return e.field.canonicalString()+e.dir})(e)).join(","),ej(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>nV(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>nV(e)).join(",")),t.Te=e}return t.Te}function ry(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!n3(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!rr(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!n2(e.startAt,t.startAt)&&n2(e.endAt,t.endAt)}function rw(e){return Z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function rv(e,t){return e.filters.filter(e=>e instanceof n5&&e.field.isEqual(t))}function rI(e,t,n){let r=nN,s=!0;for(const n of rv(e,t)){let e=nN,t=!0;switch(n.op){case"<":case"<=":e=nQ(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=nN}nJ({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i){if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];nJ({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}}return{value:r,inclusive:s}}function r_(e,t,n){let r=nE,s=!0;for(const n of rv(e,t)){let e=nE,t=!0;switch(n.op){case">=":case">":e=nW(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=nE}nH({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i){if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];nH({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}}return{value:r,inclusive:s}}class rb{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.Ie=null,this.Ee=null,this.de=null,this.startAt,this.endAt}}function rT(e,t,n,r,s,i,o,a){return new rb(e,t,n,r,s,i,o,a)}function rE(e){return new rb(e)}function rS(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function rx(e){return null!==e.collectionGroup}function rN(e){const t=x(e);if(null===t.Ie){t.Ie=[];const e=new Set;for(const n of t.explicitOrderBy)t.Ie.push(n),e.add(n.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function e(e){let t=new nt(X.comparator);return e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t}(t);r.forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Ie.push(new n4(r,n))}),e.has(X.keyField().canonicalString())||t.Ie.push(new n4(X.keyField(),n))}return t.Ie}function rD(e){const t=x(e);return t.Ee||(t.Ee=rA(t,rN(e))),t.Ee}function rC(e){const t=x(e);return t.de||(t.de=rA(t,e.explicitOrderBy)),t.de}function rA(e,t){if("F"===e.limitType)return rg(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{const t="desc"===e.dir?"asc":"desc";return new n4(e.field,t)});const n=e.endAt?new n0(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new n0(e.startAt.position,e.startAt.inclusive):null;return rg(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function rk(e,t){const n=e.filters.concat([t]);return new rb(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function rR(e,t,n){return new rb(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function rM(e,t){return ry(rD(e),rD(t))&&e.limitType===t.limitType}function rV(e){return`${rp(rD(e))}|lt:${e.limitType}`}function rO(e){return`Query(target=${function e(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map(e=>ri(e)).join(", ")}]`),ej(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map(e=>(function e(e){return`${e.field.canonicalString()} (${e.dir})`})(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>nV(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>nV(e)).join(",")),`Target(${t})`}(rD(e))}; limitType=${e.limitType})`}function rF(e,t){return t.isFoundDocument()&&function e(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Z.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function e(e,t){for(const n of rN(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function e(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function e(e,t){if(e.startAt&&!function e(e,t,n){const r=n1(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,rN(e),t))return!1;if(e.endAt&&!function e(e,t,n){const r=n1(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,rN(e),t))return!1;return!0}(e,t)}function rP(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function rL(e){return(t,n)=>{let r=!1;for(const s of rN(e)){const e=rq(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function rq(e,t,n){const r=e.field.isKeyField()?Z.comparator(t.key,n.key):function e(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?nk(r,s):b(42886)}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return b(19790,{direction:e.dir})}}class rU{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(const[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){t6(this.inner,(t,n)=>{for(const[t,r]of n)e(t,r)})}isEmpty(){return t8(this.inner)}size(){return this.innerSize}}const rB=new t9(Z.comparator);function rz(){return rB}const r$=new t9(Z.comparator);function rG(...e){let t=r$;for(const n of e)t=t.insert(n.key,n);return t}function rK(e){let t=r$;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function rj(){return rW()}function rQ(){return rW()}function rW(){return new rU(e=>e.toString(),(e,t)=>e.isEqual(t))}const rJ=new t9(Z.comparator);const rH=new nt(Z.comparator);function rY(...e){let t=rH;for(const n of e)t=t.add(n);return t}const rX=new nt(B);function rZ(){return rX}function r0(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eQ(t)?"-0":t}}function r1(e){return{integerValue:""+e}}function r2(e,t){return eW(t)?r1(t):r0(e,t)}class r4{constructor(){this._=void 0}}function r3(e,t,n){return e instanceof r8?function e(e,t){const n={fields:{[nf]:{stringValue:nd},[ng]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&np(t)&&(t=ny(t)),t&&(n.fields[nm]=t),{mapValue:n}}(n,t):e instanceof r9?r7(e,t):e instanceof se?st(e,t):function e(e,t){const n=r5(e,t),r=sr(n)+sr(e.Ae);return nL(n)&&nL(e.Ae)?r1(r):r0(e.serializer,r)}(e,t)}function r6(e,t,n){return e instanceof r9?r7(e,t):e instanceof se?st(e,t):n}function r5(e,t){return e instanceof sn?function e(e){return nL(e)||function e(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class r8 extends r4{}class r9 extends r4{constructor(e){super(),this.elements=e}}function r7(e,t){const n=ss(t);for(const t of e.elements)n.some(e=>nC(e,t))||n.push(t);return{arrayValue:{values:n}}}class se extends r4{constructor(e){super(),this.elements=e}}function st(e,t){let n=ss(t);for(const t of e.elements)n=n.filter(e=>!nC(e,t));return{arrayValue:{values:n}}}class sn extends r4{constructor(e,t){super(),this.serializer=e,this.Ae=t}}function sr(e){return nl(e.integerValue||e.doubleValue)}function ss(e){return nq(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class si{constructor(e,t){this.field=e,this.transform=t}}function so(e,t){return e.field.isEqual(t.field)&&function e(e,t){return e instanceof r9&&t instanceof r9||e instanceof se&&t instanceof se?j(e.elements,t.elements,nC):e instanceof sn&&t instanceof sn?nC(e.Ae,t.Ae):e instanceof r8&&t instanceof r8}(e.transform,t.transform)}class sa{constructor(e,t){this.version=e,this.transformResults=t}}class sc{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new sc}static exists(e){return new sc(void 0,e)}static updateTime(e){return new sc(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function su(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class sl{}function sh(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new s_(e.key,sc.none()):new sp(e.key,e.data,sc.none());{const n=e.data,r=nY.empty();let s=new nt(X.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new sy(e.key,r,new ns(s.toArray()),sc.none())}}function sd(e,t,n){e instanceof sp?function e(e,t,n){const r=e.value.clone(),s=sv(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof sy?function e(e,t,n){if(!su(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=sv(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(sw(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function e(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function sf(e,t,n,r){return e instanceof sp?function e(e,t,n,r){if(!su(e.precondition,t))return n;const s=e.value.clone(),i=sI(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof sy?function e(e,t,n,r){if(!su(e.precondition,t))return n;const s=sI(e.fieldTransforms,r,t),i=t.data;if(i.setAll(sw(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n)return null;return n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):function e(e,t,n){if(su(e.precondition,t))return t.convertToNoDocument(t.version).setHasLocalMutations(),null;return n}(e,t,n)}function sm(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=r5(r.transform,e||null);null!=s&&(null===n&&(n=nY.empty()),n.set(r.field,s))}return n||null}function sg(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function e(e,t){return void 0===e&&void 0===t||!(!e||!t)&&j(e,t,(e,t)=>so(e,t))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class sp extends sl{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class sy extends sl{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function sw(e){const t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}}),t}function sv(e,t,n){const r=new Map;E(e.length===n.length,32656,{Re:n.length,Ve:e.length});for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,r6(o,a,n[s]))}return r}function sI(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,r3(e,i,t))}return r}class s_ extends sl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class sb extends sl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class sT{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];if(r.key.isEqual(e.key)){sd(r,e,n[t])}}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=sf(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=sf(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=rQ();return this.mutations.forEach(r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=sh(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(ef.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),rY())}isEqual(e){return this.batchId===e.batchId&&j(this.mutations,e.mutations,(e,t)=>sg(e,t))&&j(this.baseMutations,e.baseMutations,(e,t)=>sg(e,t))}}class sE{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){E(e.mutations.length===n.length,58842,{me:e.mutations.length,fe:n.length});let r=function e(){return rJ}();const s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new sE(e,t,n,r)}}class sS{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class sx{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class sN{constructor(e,t){this.count=e,this.unchangedNames=t}}var sD,sC;function sA(e){switch(e){case N.OK:return b(64938);case N.CANCELLED:case N.UNKNOWN:case N.DEADLINE_EXCEEDED:case N.RESOURCE_EXHAUSTED:case N.INTERNAL:case N.UNAVAILABLE:case N.UNAUTHENTICATED:return!1;case N.INVALID_ARGUMENT:case N.NOT_FOUND:case N.ALREADY_EXISTS:case N.PERMISSION_DENIED:case N.FAILED_PRECONDITION:case N.ABORTED:case N.OUT_OF_RANGE:case N.UNIMPLEMENTED:case N.DATA_LOSS:return!0;default:return b(15467,{code:e})}}function sk(e){if(void 0===e)return v("GRPC error has no .code"),N.UNKNOWN;switch(e){case sD.OK:return N.OK;case sD.CANCELLED:return N.CANCELLED;case sD.UNKNOWN:return N.UNKNOWN;case sD.DEADLINE_EXCEEDED:return N.DEADLINE_EXCEEDED;case sD.RESOURCE_EXHAUSTED:return N.RESOURCE_EXHAUSTED;case sD.INTERNAL:return N.INTERNAL;case sD.UNAVAILABLE:return N.UNAVAILABLE;case sD.UNAUTHENTICATED:return N.UNAUTHENTICATED;case sD.INVALID_ARGUMENT:return N.INVALID_ARGUMENT;case sD.NOT_FOUND:return N.NOT_FOUND;case sD.ALREADY_EXISTS:return N.ALREADY_EXISTS;case sD.PERMISSION_DENIED:return N.PERMISSION_DENIED;case sD.FAILED_PRECONDITION:return N.FAILED_PRECONDITION;case sD.ABORTED:return N.ABORTED;case sD.OUT_OF_RANGE:return N.OUT_OF_RANGE;case sD.UNIMPLEMENTED:return N.UNIMPLEMENTED;case sD.DATA_LOSS:return N.DATA_LOSS;default:return b(39323,{code:e})}}(sC=sD||(sD={}))[sC.OK=0]="OK",sC[sC.CANCELLED=1]="CANCELLED",sC[sC.UNKNOWN=2]="UNKNOWN",sC[sC.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",sC[sC.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",sC[sC.NOT_FOUND=5]="NOT_FOUND",sC[sC.ALREADY_EXISTS=6]="ALREADY_EXISTS",sC[sC.PERMISSION_DENIED=7]="PERMISSION_DENIED",sC[sC.UNAUTHENTICATED=16]="UNAUTHENTICATED",sC[sC.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",sC[sC.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",sC[sC.ABORTED=10]="ABORTED",sC[sC.OUT_OF_RANGE=11]="OUT_OF_RANGE",sC[sC.UNIMPLEMENTED=12]="UNIMPLEMENTED",sC[sC.INTERNAL=13]="INTERNAL",sC[sC.UNAVAILABLE=14]="UNAVAILABLE",sC[sC.DATA_LOSS=15]="DATA_LOSS";let sR=null;function sM(){return new TextEncoder}const sV=new a.jz([0xffffffff,0xffffffff],0);function sO(e){const t=sM().encode(e),n=new a.VV;return n.update(t),new Uint8Array(n.digest())}function sF(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.jz([n,r],0),new a.jz([s,i],0)]}class sP{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new sL(`Invalid padding: ${t}`);if(n<0)throw new sL(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new sL(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new sL(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=a.jz.fromNumber(this.ge)}ye(e,t,n){let r=e.add(t.multiply(a.jz.fromNumber(n)));return 1===r.compare(sV)&&(r=new a.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.ge)return!1;const t=sO(e),[n,r]=sF(t);for(let e=0;e<this.hashCount;e++){const t=this.ye(n,r,e);if(!this.we(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new sP(s,r,t);return n.forEach(e=>i.insert(e)),i}insert(e){if(0===this.ge)return;const t=sO(e),[n,r]=sF(t);for(let e=0;e<this.hashCount;e++){const t=this.ye(n,r,e);this.Se(t)}}Se(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class sL extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class sq{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,sU.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new sq(ef.min(),r,new t9(B),rz(),rY())}}class sU{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new sU(n,t,rY(),rY(),rY())}}class sB{constructor(e,t,n,r){this.be=e,this.removedTargetIds=t,this.key=n,this.De=r}}class sz{constructor(e,t){this.targetId=e,this.Ce=t}}class s${constructor(e,t,n=na.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class sG{constructor(){this.ve=0,this.Fe=sQ(),this.Me=na.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return 0!==this.ve}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=rY(),t=rY(),n=rY();return this.Fe.forEach((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:b(38017,{changeType:s})}}),new sU(this.Me,this.xe,e,t,n)}qe(){this.Oe=!1,this.Fe=sQ()}Qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}$e(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}Ue(){this.ve+=1}Ke(){this.ve-=1,E(this.ve>=0,3241,{ve:this.ve})}We(){this.Oe=!0,this.xe=!0}}class sK{constructor(e){this.Ge=e,this.ze=new Map,this.je=rz(),this.Je=sj(),this.He=sj(),this.Ye=new t9(B)}Ze(e){for(const t of e.be)e.De&&e.De.isFoundDocument()?this.Xe(t,e.De):this.et(t,e.key,e.De);for(const t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,t=>{const n=this.nt(t);switch(e.state){case 0:this.rt(t)&&n.Le(e.resumeToken);break;case 1:n.Ke(),n.Ne||n.qe(),n.Le(e.resumeToken);break;case 2:n.Ke(),n.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(n.We(),n.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),n.Le(e.resumeToken));break;default:b(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach((e,n)=>{this.rt(n)&&t(n)})}st(e){const t=e.targetId,n=e.Ce.count,r=this.ot(t);if(r){const s=r.target;if(rw(s))if(0===n){const e=new Z(s.path);this.et(t,e,nZ.newNoDocument(e,ef.min()))}else E(1===n,20013,{expectedCount:n});else{const r=this._t(t);if(r!==n){const n=this.ut(e),s=n?this.ct(n,e,r):1;if(0!==s){this.it(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ye=this.Ye.insert(t,e)}sR?.lt(function e(e,t,n,r,s){const i={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},o=t.unchangedNames;o&&(i.bloomFilter={applied:0===s,hashCount:o?.hashCount??0,bitmapLength:o?.bits?.bitmap?.length??0,padding:o?.bits?.padding??0,mightContain:e=>r?.mightContain(e)??!1});return i}(r,e.Ce,this.Ge.ht(),n,s))}}}}ut(e){const t=e.Ce.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=t;let i,o;try{i=nh(n).toUint8Array()}catch(e){if(e instanceof ni)return I("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{o=new sP(i,r,s)}catch(e){return I(e instanceof sL?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===o.ge?null:o}ct(e,t,n){return t.Ce.count===n-this.Pt(e,t.targetId)?0:2}Pt(e,t){const n=this.Ge.getRemoteKeysForTarget(t);let r=0;return n.forEach(n=>{const s=this.Ge.ht(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.et(t,n,null),r++)}),r}Tt(e){const t=new Map;this.ze.forEach((n,r)=>{const s=this.ot(r);if(s){if(n.current&&rw(s.target)){const t=new Z(s.target.path);this.It(t).has(r)||this.Et(r,t)||this.et(r,t,nZ.newNoDocument(t,e))}n.Be&&(t.set(r,n.ke()),n.qe())}});let n=rY();this.He.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{const t=this.ot(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.je.forEach((t,n)=>n.setReadTime(e));const r=new sq(e,t,this.Ye,this.je,n);return this.je=rz(),this.Je=sj(),this.He=sj(),this.Ye=new t9(B),r}Xe(e,t){if(!this.rt(e))return;const n=this.Et(e,t.key)?2:0;this.nt(e).Qe(t.key,n),this.je=this.je.insert(t.key,t),this.Je=this.Je.insert(t.key,this.It(t.key).add(e)),this.He=this.He.insert(t.key,this.dt(t.key).add(e))}et(e,t,n){if(!this.rt(e))return;const r=this.nt(e);this.Et(e,t)?r.Qe(t,1):r.$e(t),this.He=this.He.insert(t,this.dt(t).delete(e)),this.He=this.He.insert(t,this.dt(t).add(e)),n&&(this.je=this.je.insert(t,n))}removeTarget(e){this.ze.delete(e)}_t(e){const t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ue(e){this.nt(e).Ue()}nt(e){let t=this.ze.get(e);return t||(t=new sG,this.ze.set(e,t)),t}dt(e){let t=this.He.get(e);return t||(t=new nt(B),this.He=this.He.insert(e,t)),t}It(e){let t=this.Je.get(e);return t||(t=new nt(B),this.Je=this.Je.insert(e,t)),t}rt(e){const t=null!==this.ot(e);return t||w("WatchChangeAggregator","Detected inactive target",e),t}ot(e){const t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new sG);this.Ge.getRemoteKeysForTarget(e).forEach(t=>{this.et(e,t,null)})}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}}function sj(){return new t9(Z.comparator)}function sQ(){return new t9(Z.comparator)}const sW=(()=>{const e={asc:"ASCENDING",desc:"DESCENDING"};return e})(),sJ=(()=>{const e={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};return e})(),sH=(()=>{const e={and:"AND",or:"OR"};return e})();class sY{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function sX(e,t){return e.useProto3Json||ej(t)?t:{value:t}}function sZ(e,t){if(e.useProto3Json){return`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`}return{seconds:""+t.seconds,nanos:t.nanoseconds}}function s0(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function s1(e,t){return sZ(e,t.toTimestamp())}function s2(e){return E(!!e,49232),ef.fromTimestamp(function e(e){const t=nu(e);return new ed(t.seconds,t.nanos)}(e))}function s4(e,t){return s3(e,t).canonicalString()}function s3(e,t){const n=(function e(e){return new H(["projects",e.projectId,"databases",e.database])})(e).child("documents");return void 0===t?n:n.child(t)}function s6(e){const t=H.fromString(e);return E(iE(t),10190,{key:t.toString()}),t}function s5(e,t){return s4(e.databaseId,t.path)}function s8(e,t){const n=s6(t);if(n.get(1)!==e.databaseId.projectId)throw new D(N.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new D(N.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Z(it(n))}function s9(e,t){return s4(e.databaseId,t)}function s7(e){const t=s6(e);return 4===t.length?H.emptyPath():it(t)}function ie(e){return new H(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function it(e){return E(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function ir(e,t,n){return{name:s5(e,t),fields:n.value.mapValue.fields}}function is(e,t,n){const r=s8(e,t.name),s=s2(t.updateTime),i=t.createTime?s2(t.createTime):ef.min(),o=new nY({mapValue:{fields:t.fields}}),a=nZ.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function ii(e,t){return"found"in t?function e(e,t){E(!!t.found,43571),t.found.name,t.found.updateTime;const n=s8(e,t.found.name),r=s2(t.found.updateTime),s=t.found.createTime?s2(t.found.createTime):ef.min(),i=new nY({mapValue:{fields:t.found.fields}});return nZ.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function e(e,t){E(!!t.missing,3894),E(!!t.readTime,22933);const n=s8(e,t.missing),r=s2(t.readTime);return nZ.newNoDocument(n,r)}(e,t):b(7234,{result:t})}function io(e,t){let n;if("targetChange"in t){t.targetChange;const r=function e(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:b(39313,{state:e})}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function e(e,t){return e.useProto3Json?(E(void 0===t||"string"==typeof t,58123),na.fromBase64String(t||"")):(E(void 0===t||t instanceof l||t instanceof Uint8Array,16193),na.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function e(e){const t=void 0===e.code?N.UNKNOWN:sk(e.code);return new D(t,e.message||"")}(o);n=new s$(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=s8(e,r.document.name),i=s2(r.document.updateTime),o=r.document.createTime?s2(r.document.createTime):ef.min(),a=new nY({mapValue:{fields:r.document.fields}}),c=nZ.newFoundDocument(s,i,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new sB(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=s8(e,r.document),i=r.readTime?s2(r.readTime):ef.min(),o=nZ.newNoDocument(s,i),a=r.removedTargetIds||[];n=new sB([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=s8(e,r.document),i=r.removedTargetIds||[];n=new sB([],i,s,null)}else{if(!("filter"in t))return b(11601,{Rt:t});{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new sN(r,s),o=e.targetId;n=new sz(o,i)}}return n}function ia(e,t){let n;if(t instanceof sp)n={update:ir(e,t.key,t.value)};else if(t instanceof s_)n={delete:s5(e,t.key)};else if(t instanceof sy)n={update:ir(e,t.key,t.data),updateMask:iT(t.fieldMask)};else{if(!(t instanceof sb))return b(16599,{Vt:t.type});n={verify:s5(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map(e=>(function e(e,t){const n=t.transform;if(n instanceof r8)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof r9)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof se)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof sn)return{fieldPath:t.field.canonicalString(),increment:n.Ae};throw b(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(n.currentDocument=function e(e,t){return void 0!==t.updateTime?{updateTime:s1(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:b(27497)}(e,t.precondition)),n}function ic(e,t){const n=t.currentDocument?function e(e){return void 0!==e.updateTime?sc.updateTime(s2(e.updateTime)):void 0!==e.exists?sc.exists(e.exists):sc.none()}(t.currentDocument):sc.none(),r=t.updateTransforms?t.updateTransforms.map(t=>(function e(e,t){let n=null;if("setToServerValue"in t)E("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),n=new r8;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new r9(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new se(e)}else"increment"in t?n=new sn(e,t.increment):b(16584,{proto:t});const r=X.fromServerFormat(t.fieldPath);return new si(r,n)})(e,t)):[];if(t.update){t.update.name;const s=s8(e,t.update.name),i=new nY({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function e(e){const t=e.fieldPaths||[];return new ns(t.map(e=>X.fromServerFormat(e)))}(t.updateMask);return new sy(s,i,e,n,r)}return new sp(s,i,n,r)}if(t.delete){const r=s8(e,t.delete);return new s_(r,n)}if(t.verify){const r=s8(e,t.verify);return new sb(r,n)}return b(1463,{proto:t})}function iu(e,t){return e&&e.length>0?(E(void 0!==t,14353),e.map(e=>(function e(e,t){let n=e.updateTime?s2(e.updateTime):s2(t);return n.isEqual(ef.min())&&(n=s2(t)),new sa(n,e.transformResults||[])})(e,t))):[]}function il(e,t){return{documents:[s9(e,t.path)]}}function ih(e,t){const n={structuredQuery:{}},r=t.path;let s;null!==t.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=s9(e,s);const i=function e(e){if(0===e.length)return;return ib(n8.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const o=function e(e){if(0===e.length)return;return e.map(e=>(function e(e){return{field:iI(e.field),direction:iy(e.dir)}})(e))}(t.orderBy);o&&(n.structuredQuery.orderBy=o);const a=sX(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function e(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function e(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{ft:n,parent:s}}function id(e,t,n,r){const{ft:s,parent:i}=ih(e,t),o={},a=[];let c=0;return n.forEach(e=>{const t=r?e.alias:"aggregate_"+c++;o[t]=e.alias,"count"===e.aggregateType?a.push({alias:t,count:{}}):"avg"===e.aggregateType?a.push({alias:t,avg:{field:iI(e.fieldPath)}}):"sum"===e.aggregateType&&a.push({alias:t,sum:{field:iI(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:a,structuredQuery:s.structuredQuery},parent:s.parent},gt:o,parent:i}}function im(e){let t=s7(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){E(1===r,65062);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function e(e){const t=ip(e);if(t instanceof n8&&re(t))return t.getFilters();return[t]}(n.where));let o=[];n.orderBy&&(o=function e(e){return e.map(e=>(function e(e){return new n4(i_(e.field),function e(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))})(e))}(n.orderBy));let a=null;n.limit&&(a=function e(e){let t;return t="object"==typeof e?e.value:e,ej(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function e(e){const t=!!e.before,n=e.values||[];return new n0(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function e(e){const t=!e.before,n=e.values||[];return new n0(n,t)}(n.endAt)),rT(t,s,o,i,a,"F",c,u)}function ig(e,t){const n=function e(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return b(28987,{purpose:e})}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}function ip(e){return void 0!==e.unaryFilter?function e(e){switch(e.unaryFilter.op){case"IS_NAN":const t=i_(e.unaryFilter.field);return n5.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=i_(e.unaryFilter.field);return n5.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=i_(e.unaryFilter.field);return n5.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=i_(e.unaryFilter.field);return n5.create(s,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return b(61313);default:return b(60726)}}(e):void 0!==e.fieldFilter?function e(e){return n5.create(i_(e.fieldFilter.field),function e(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return b(58110);default:return b(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function e(e){return n8.create(e.compositeFilter.filters.map(e=>ip(e)),function e(e){switch(e){case"AND":return"and";case"OR":return"or";default:return b(1026)}}(e.compositeFilter.op))}(e):b(30097,{filter:e})}function iy(e){return sW[e]}function iw(e){return sJ[e]}function iv(e){return sH[e]}function iI(e){return{fieldPath:e.canonicalString()}}function i_(e){return X.fromServerFormat(e.fieldPath)}function ib(e){return e instanceof n5?function e(e){if("=="===e.op){if(nB(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NAN"}};if(nU(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(nB(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NOT_NAN"}};if(nU(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iI(e.field),op:iw(e.op),value:e.value}}}(e):e instanceof n8?function e(e){const t=e.getFilters().map(e=>ib(e));if(1===t.length)return t[0];return{compositeFilter:{op:iv(e.op),filters:t}}}(e):b(54877,{filter:e})}function iT(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function iE(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class iS{constructor(e,t,n,r,s=ef.min(),i=ef.min(),o=na.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new iS(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iS(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iS(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iS(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class ix{constructor(e){this.yt=e}}function iN(e,t){let n;if(t.document)n=is(e.yt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=Z.fromSegments(t.noDocument.path),r=ik(t.noDocument.readTime);n=nZ.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return b(56709);{const e=Z.fromSegments(t.unknownDocument.path),r=ik(t.unknownDocument.version);n=nZ.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function e(e){const t=new ed(e[0],e[1]);return ef.fromTimestamp(t)}(t.readTime)),n}function iD(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:iC(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function e(e,t){return{name:s5(e,t.key),fields:t.data.value.mapValue.fields,updateTime:sZ(e,t.version.toTimestamp()),createTime:sZ(e,t.createTime.toTimestamp())}}(e.yt,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:iA(t.version)};else{if(!t.isUnknownDocument())return b(57904,{document:t});r.unknownDocument={path:n.path.toArray(),version:iA(t.version)}}return r}function iC(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iA(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ik(e){const t=new ed(e.seconds,e.nanoseconds);return ef.fromTimestamp(t)}function iR(e,t){const n=(t.baseMutations||[]).map(t=>ic(e.yt,t));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map(t=>ic(e.yt,t)),s=ed.fromMillis(t.localWriteTimeMs);return new sT(t.batchId,s,n,r)}function iM(e){const t=ik(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?ik(e.lastLimboFreeSnapshotVersion):ef.min();let r;return r=function e(e){return void 0!==e.documents}(e.query)?function e(e){const t=e.documents.length;return E(1===t,1966,{count:t}),rD(rE(s7(e.documents[0])))}(e.query):function e(e){return rD(im(e))}(e.query),new iS(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,na.fromBase64String(e.resumeToken))}function iV(e,t){const n=iA(t.snapshotVersion),r=iA(t.lastLimboFreeSnapshotVersion);let s;s=rw(t.target)?il(e.yt,t.target):ih(e.yt,t.target).ft;const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:rp(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function iO(e){const t=im({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?rR(t,t.limit,"L"):t}function iF(e,t){return new sS(t.largestBatchId,ic(e.yt,t.overlayMutation))}function iP(e,t){const n=t.path.lastSegment();return[e,eH(t.path.popLast()),n]}function iL(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:iA(r.readTime),documentKey:eH(r.documentKey.path),largestBatchId:r.largestBatchId}}class iq{getBundleMetadata(e,t){return iU(e).get(t).next(e=>{if(e)return function e(e){return{id:e.bundleId,createTime:ik(e.createTime),version:e.version}}(e)})}saveBundleMetadata(e,t){return iU(e).put(function e(e){return{bundleId:e.id,createTime:iA(s2(e.createTime)),version:e.version}}(t))}getNamedQuery(e,t){return iB(e).get(t).next(e=>{if(e)return function e(e){return{name:e.name,query:iO(e.bundledQuery),readTime:ik(e.readTime)}}(e)})}saveNamedQuery(e,t){return iB(e).put(function e(e){return{name:e.name,readTime:iA(s2(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function iU(e){return t4(e,tE)}function iB(e){return t4(e,tx)}class iz{constructor(e,t){this.serializer=e,this.userId=t}static wt(e,t){const n=t.uid||"";return new iz(e,n)}getOverlay(e,t){return i$(e).get(iP(this.userId,t)).next(e=>e?iF(this.serializer,e):null)}getOverlays(e,t){const n=rj();return eC.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){const r=[];return n.forEach((n,s)=>{const i=new sS(t,s);r.push(this.St(e,i))}),eC.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach(e=>r.add(eH(e.getCollectionPath())));const s=[];return r.forEach(t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(i$(e).Z(tz,r))}),eC.waitFor(s)}getOverlaysForCollection(e,t,n){const r=rj(),s=eH(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return i$(e).J(tz,i).next(e=>{for(const t of e){const e=iF(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){const s=rj();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return i$(e).ee({index:tG,range:o},(e,t,n)=>{const o=iF(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()}).next(()=>s)}St(e,t){return i$(e).put(function e(e,t,n){const[r,s,i]=iP(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ia(e.yt,n.mutation)}}(this.serializer,this.userId,t))}}function i$(e){return t4(e,tU)}class iG{bt(e){return t4(e,tj)}getSessionToken(e){return this.bt(e).get("sessionToken").next(e=>{const t=e?.value;return t?na.fromUint8Array(t):na.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.bt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iK{constructor(){}Dt(e,t){this.Ct(e,t),t.vt()}Ct(e,t){if("nullValue"in e)this.Ft(t,5);else if("booleanValue"in e)this.Ft(t,10),t.Mt(e.booleanValue?1:0);else if("integerValue"in e)this.Ft(t,15),t.Mt(nl(e.integerValue));else if("doubleValue"in e){const n=nl(e.doubleValue);isNaN(n)?this.Ft(t,13):(this.Ft(t,15),eQ(n)?t.Mt(0):t.Mt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Ft(t,20),"string"==typeof n&&(n=nu(n)),t.xt(`${n.seconds||""}`),t.Mt(n.nanos||0)}else if("stringValue"in e)this.Ot(e.stringValue,t),this.Nt(t);else if("bytesValue"in e)this.Ft(t,30),t.Bt(nh(e.bytesValue)),this.Nt(t);else if("referenceValue"in e)this.Lt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.Ft(t,45),t.Mt(n.latitude||0),t.Mt(n.longitude||0)}else"mapValue"in e?nK(e)?this.Ft(t,Number.MAX_SAFE_INTEGER):n$(e)?this.kt(e.mapValue,t):(this.qt(e.mapValue,t),this.Nt(t)):"arrayValue"in e?(this.Qt(e.arrayValue,t),this.Nt(t)):b(19022,{$t:e})}Ot(e,t){this.Ft(t,25),this.Ut(e,t)}Ut(e,t){t.xt(e)}qt(e,t){const n=e.fields||{};this.Ft(t,55);for(const e of Object.keys(n))this.Ot(e,t),this.Ct(n[e],t)}kt(e,t){const n=e.fields||{};this.Ft(t,53);const r=nx,s=n[r].arrayValue?.values?.length||0;this.Ft(t,15),t.Mt(nl(s)),this.Ot(r,t),this.Ct(n[r],t)}Qt(e,t){const n=e.values||[];this.Ft(t,50);for(const e of n)this.Ct(e,t)}Lt(e,t){this.Ft(t,37);Z.fromName(e).path.forEach(e=>{this.Ft(t,60),this.Ut(e,t)})}Ft(e,t){e.Mt(t)}Nt(e){e.Mt(2)}}iK.Kt=new iK;const ij=255;function iQ(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}function iW(e){const t=64-function e(e){let t=0;for(let n=0;n<8;++n){const r=iQ(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}class iJ{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Wt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Gt(n.value),n=t.next();this.zt()}jt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Jt(n.value),n=t.next();this.Ht()}Yt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Gt(e);else if(e<2048)this.Gt(960|e>>>6),this.Gt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Gt(480|e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e);else{const e=t.codePointAt(0);this.Gt(240|e>>>18),this.Gt(128|63&e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e)}}this.zt()}Zt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Jt(e);else if(e<2048)this.Jt(960|e>>>6),this.Jt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Jt(480|e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e);else{const e=t.codePointAt(0);this.Jt(240|e>>>18),this.Jt(128|63&e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e)}}this.Ht()}Xt(e){const t=this.en(e),n=iW(t);this.tn(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}nn(e){const t=this.en(e),n=iW(t);this.tn(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}rn(){this.sn(ij),this.sn(255)}_n(){this.an(ij),this.an(255)}reset(){this.position=0}seed(e){this.tn(e.length),this.buffer.set(e,this.position),this.position+=e.length}un(){return this.buffer.slice(0,this.position)}en(e){const t=function e(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Gt(e){const t=255&e;0===t?(this.sn(0),this.sn(255)):t===ij?(this.sn(ij),this.sn(0)):this.sn(t)}Jt(e){const t=255&e;0===t?(this.an(0),this.an(255)):t===ij?(this.an(ij),this.an(0)):this.an(e)}zt(){this.sn(0),this.sn(1)}Ht(){this.an(0),this.an(1)}sn(e){this.tn(1),this.buffer[this.position++]=e}an(e){this.tn(1),this.buffer[this.position++]=~e}tn(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iH{constructor(e){this.cn=e}Bt(e){this.cn.Wt(e)}xt(e){this.cn.Yt(e)}Mt(e){this.cn.Xt(e)}vt(){this.cn.rn()}}class iY{constructor(e){this.cn=e}Bt(e){this.cn.jt(e)}xt(e){this.cn.Zt(e)}Mt(e){this.cn.nn(e)}vt(){this.cn._n()}}class iX{constructor(){this.cn=new iJ,this.ln=new iH(this.cn),this.hn=new iY(this.cn)}seed(e){this.cn.seed(e)}Pn(e){return 0===e?this.ln:this.hn}un(){return this.cn.un()}reset(){this.cn.reset()}}class iZ{constructor(e,t,n,r){this.Tn=e,this.In=t,this.En=n,this.dn=r}An(){const e=this.dn.length,t=0===e||255===this.dn[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.dn,0),t!==e?n.set([0],this.dn.length):++n[n.length-1],new iZ(this.Tn,this.In,this.En,n)}Rn(e,t,n){return{indexId:this.Tn,uid:e,arrayValue:i2(this.En),directionalValue:i2(this.dn),orderedDocumentKey:i2(t),documentKey:n.path.toArray()}}Vn(e,t,n){const r=this.Rn(e,t,n);return[r.indexId,r.uid,r.arrayValue,r.directionalValue,r.orderedDocumentKey,r.documentKey]}}function i0(e,t){let n=e.Tn-t.Tn;return 0!==n?n:(n=i1(e.En,t.En),0!==n?n:(n=i1(e.dn,t.dn),0!==n?n:Z.comparator(e.In,t.In)))}function i1(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function i2(e){return(0,o.Ov)()?function e(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}(e):e}function i4(e){return"string"!=typeof e?e:function e(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)}class i3{constructor(e){this.mn=new nt((e,t)=>X.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.fn=e.orderBy,this.gn=[];for(const t of e.filters){const e=t;e.isInequality()?this.mn=this.mn.add(e):this.gn.push(e)}}get pn(){return this.mn.size>1}yn(e){if(E(e.collectionGroup===this.collectionId,49279),this.pn)return!1;const t=ep(e);if(void 0!==t&&!this.wn(t))return!1;const n=ey(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.wn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.mn.size>0){const e=this.mn.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.Sn(e,t)||!this.bn(this.fn[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.fn.length||!this.bn(this.fn[i++],e))return!1}return!0}Dn(){if(this.pn)return null;let e=new nt(X.comparator);const t=[];for(const n of this.gn){if(n.field.isKeyField())continue;if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new ev(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new ev(n.field,0))}}for(const n of this.fn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new ev(n.field,"asc"===n.dir?0:1)));return new eg(eg.UNKNOWN_ID,this.collectionId,t,e_.empty())}wn(e){for(const t of this.gn)if(this.Sn(t,e))return!0;return!1}Sn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}bn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function i6(e){if(E(e instanceof n5||e instanceof n8,20012),e instanceof n5){if(e instanceof rh){const t=e.value.arrayValue?.values?.map(t=>n5.create(e.field,"==",t))||[];return n8.create(t,"or")}return e}const t=e.filters.map(e=>i6(e));return n8.create(t,e.op)}function i5(e){if(0===e.getFilters().length)return[];const t=oe(i6(e));return E(i7(t),7391),i8(t)||i9(t)?[t]:t.getFilters()}function i8(e){return e instanceof n5}function i9(e){return e instanceof n8&&re(e)}function i7(e){return i8(e)||i9(e)||function e(e){if(e instanceof n8&&n7(e)){for(const t of e.getFilters())if(!i8(t)&&!i9(t))return!1;return!0}return!1}(e)}function oe(e){if(E(e instanceof n5||e instanceof n8,34018),e instanceof n5)return e;if(1===e.filters.length)return oe(e.filters[0]);const t=e.filters.map(e=>oe(e));let n=n8.create(t,e.op);return n=or(n),i7(n)?n:(E(n instanceof n8,64498),E(n9(n),40251),E(n.filters.length>1,57927),n.filters.reduce((e,t)=>ot(e,t)))}function ot(e,t){let n;return E(e instanceof n5||e instanceof n8,38388),E(t instanceof n5||t instanceof n8,25473),n=e instanceof n5?t instanceof n5?function e(e,t){return n8.create([e,t],"and")}(e,t):on(e,t):t instanceof n5?on(t,e):function e(e,t){if(E(e.filters.length>0&&t.filters.length>0,48005),n9(e)&&n9(t))return rs(e,t.getFilters());const n=n7(e)?e:t,r=n7(e)?t:e,s=n.filters.map(e=>ot(e,r));return n8.create(s,"or")}(e,t),or(n)}function on(e,t){if(n9(t))return rs(t,e.getFilters());{const n=t.filters.map(t=>ot(e,t));return n8.create(n,"or")}}function or(e){if(E(e instanceof n5||e instanceof n8,11850),e instanceof n5)return e;const t=e.getFilters();if(1===t.length)return or(t[0]);if(rt(e))return e;const n=t.map(e=>or(e)),r=[];return n.forEach(t=>{t instanceof n5?r.push(t):t instanceof n8&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:n8.create(r,e.op)}class os{constructor(){this.Cn=new oi}addToCollectionParentIndex(e,t){return this.Cn.add(t),eC.resolve()}getCollectionParents(e,t){return eC.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return eC.resolve()}deleteFieldIndex(e,t){return eC.resolve()}deleteAllFieldIndexes(e){return eC.resolve()}createTargetIndexes(e,t){return eC.resolve()}getDocumentsMatchingTarget(e,t){return eC.resolve(null)}getIndexType(e,t){return eC.resolve(0)}getFieldIndexes(e,t){return eC.resolve([])}getNextCollectionGroupToUpdate(e){return eC.resolve(null)}getMinOffset(e,t){return eC.resolve(eE.min())}getMinOffsetFromCollectionGroup(e,t){return eC.resolve(eE.min())}updateCollectionGroup(e,t,n){return eC.resolve()}updateIndexEntries(e,t){return eC.resolve()}}class oi{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new nt(H.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new nt(H.comparator)).toArray()}}const oo="IndexedDbIndexManager",oa=new Uint8Array(0);class oc{constructor(e,t){this.databaseId=t,this.vn=new oi,this.Fn=new rU(e=>rp(e),(e,t)=>ry(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.vn.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.vn.add(t)});const s={collectionId:n,parent:eH(r)};return ou(e).put(s)}return eC.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[Q(t),""],!1,!0);return ou(e).J(r).next(e=>{for(const r of e){if(r.collectionId!==t)break;n.push(eZ(r.parent))}return n})}addFieldIndex(e,t){const n=oh(e),r=function e(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=od(e);return s.next(e=>{n.put(iL(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=oh(e),r=od(e),s=ol(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=oh(e),n=ol(e),r=od(e);return t.Z().next(()=>n.Z()).next(()=>r.Z())}createTargetIndexes(e,t){return eC.forEach(this.Mn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){const n=new i3(t).Dn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){const n=ol(e);let r=!0;const s=new Map;return eC.forEach(this.Mn(t),t=>this.xn(e,t).next(e=>{r&&(r=!!e),s.set(t,e)})).next(()=>{if(r){let e=rY();const r=[];return eC.forEach(s,(s,i)=>{w(oo,`Using index ${function e(e){return`id=${e.indexId}|cg=${e.collectionGroup}|f=${e.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`}(s)} to execute ${rp(t)}`);const o=function e(e,t){const n=ep(t);if(void 0===n)return null;for(const t of rv(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(i,s),a=function e(e,t){const n=new Map;for(const r of ey(t))for(const t of rv(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),c=function e(e,t){const n=[];let r=!0;for(const s of ey(t)){const t=0===s.kind?rI(e,s.fieldPath,e.startAt):r_(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new n0(n,r)}(i,s),u=function e(e,t){const n=[];let r=!0;for(const s of ey(t)){const t=0===s.kind?r_(e,s.fieldPath,e.endAt):rI(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new n0(n,r)}(i,s),l=this.On(s,i,c),h=this.On(s,i,u),d=this.Nn(s,i,a),f=this.Bn(s.indexId,o,l,c.inclusive,h,u.inclusive,d);return eC.forEach(f,s=>n.Y(s,t.limit).next(t=>{t.forEach(t=>{const n=Z.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return eC.resolve(null)})}Mn(e){let t=this.Fn.get(e);if(t)return t;if(0===e.filters.length)t=[e];else{t=i5(n8.create(e.filters,"and")).map(t=>rg(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))}return this.Fn.set(e,t),t}Bn(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),c=a/(null!=t?t.length:1),u=[];for(let l=0;l<a;++l){const a=t?this.Ln(t[l/c]):oa,h=this.kn(e,a,n[l%c],r),d=this.qn(e,a,s[l%c],i),f=o.map(t=>this.kn(e,a,t,!0));u.push(...this.createRange(h,d,f))}return u}kn(e,t,n,r){const s=new iZ(e,Z.empty(),t,n);return r?s:s.An()}qn(e,t,n,r){const s=new iZ(e,Z.empty(),t,n);return r?s.An():s}xn(e,t){const n=new i3(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(const r of e){n.yn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r)}return t})}getIndexType(e,t){let n=2;const r=this.Mn(t);return eC.forEach(r,t=>this.xn(e,t).next(e=>{e?0!==n&&e.fields.length<function e(e){let t=new nt(X.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>(function e(e){return null!==e.limit})(t)&&r.length>1&&2===n?1:n)}Qn(e,t){const n=new iX;for(const r of ey(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Pn(r.kind);iK.Kt.Dt(e,s)}return n.un()}Ln(e){const t=new iX;return iK.Kt.Dt(e,t.Pn(0)),t.un()}$n(e,t){const n=new iX;return iK.Kt.Dt(nP(this.databaseId,t),n.Pn(function e(e){const t=ey(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.un()}Nn(e,t,n){if(null===n)return[];let r=[];r.push(new iX);let s=0;for(const i of ey(e)){const e=n[s++];for(const n of r)if(this.Un(t,i.fieldPath)&&nq(e))r=this.Kn(r,i,e);else{const t=n.Pn(i.kind);iK.Kt.Dt(e,t)}}return this.Wn(r)}On(e,t,n){return this.Nn(e,t,n.position)}Wn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].un();return t}Kn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new iX;r.seed(n.un()),iK.Kt.Dt(e,r.Pn(t.kind)),s.push(r)}return s}Un(e,t){return!!e.filters.find(e=>e instanceof n5&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=oh(e),r=od(e);return(t?n.J(tA,IDBKeyRange.bound(t,t)):n.J()).next(e=>{const t=[];return eC.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function e(e,t){const n=t?new e_(t.sequenceNumber,new eE(ik(t.readTime),new Z(eZ(t.documentKey)),t.largestBatchId)):e_.empty(),r=e.fields.map(([e,t])=>new ev(X.fromServerFormat(e),t));return new eg(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:B(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){const r=oh(e),s=od(e);return this.Gn(e).next(e=>r.J(tA,IDBKeyRange.bound(t,t)).next(t=>eC.forEach(t,t=>s.put(iL(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){const n=new Map;return eC.forEach(t,(t,r)=>{const s=n.get(t.collectionGroup);return(s?eC.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next(s=>(n.set(t.collectionGroup,s),eC.forEach(s,n=>this.zn(e,t,n).next(t=>{const s=this.jn(r,n);return t.isEqual(s)?eC.resolve():this.Jn(e,r,n,t,s)}))))})}Hn(e,t,n,r){return ol(e).put(r.Rn(this.uid,this.$n(n,t.key),t.key))}Yn(e,t,n,r){return ol(e).delete(r.Vn(this.uid,this.$n(n,t.key),t.key))}zn(e,t,n){const r=ol(e);let s=new nt(i0);return r.ee({index:tL,range:IDBKeyRange.only([n.indexId,this.uid,i2(this.$n(n,t))])},(e,r)=>{s=s.add(new iZ(n.indexId,t,i4(r.arrayValue),i4(r.directionalValue)))}).next(()=>s)}jn(e,t){let n=new nt(i0);const r=this.Qn(t,e);if(null==r)return n;const s=ep(t);if(null!=s){const i=e.data.field(s.fieldPath);if(nq(i))for(const s of i.arrayValue.values||[])n=n.add(new iZ(t.indexId,e.key,this.Ln(s),r))}else n=n.add(new iZ(t.indexId,e.key,oa,r));return n}Jn(e,t,n,r,s){w(oo,"Updating index entries for document '%s'",t.key);const i=[];return function e(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=nr(i),c=nr(o);for(;a||c;){let e=!1,t=!1;if(a&&c){const r=n(a,c);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(c),c=nr(o)):t?(s(a),a=nr(i)):(a=nr(i),c=nr(o))}}(r,s,i0,r=>{i.push(this.Hn(e,t,n,r))},r=>{i.push(this.Yn(e,t,n,r))}),eC.waitFor(i)}Gn(e){let t=1;return od(e).ee({index:tV,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>i0(e,t)).filter((e,t,n)=>!t||0!==i0(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=i0(s,e),i=i0(s,t);if(0===n)r[0]=e.An();else if(n>0&&i<0)r.push(s),r.push(s.An());else if(i>0)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.Zn(r[e],r[e+1]))return[];const t=r[e].Vn(this.uid,oa,Z.empty()),n=r[e+1].Vn(this.uid,oa,Z.empty());s.push(IDBKeyRange.bound(t,n))}return s}Zn(e,t){return i0(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(of)}getMinOffset(e,t){return eC.mapArray(this.Mn(t),t=>this.xn(e,t).next(e=>e||b(44426))).next(of)}}function ou(e){return t4(e,tI)}function ol(e){return t4(e,tF)}function oh(e){return t4(e,tD)}function od(e){return t4(e,tR)}function of(e){E(0!==e.length,28825);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;eS(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new eE(t.readTime,t.documentKey,n)}const om={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},og=0x2800000;class op{static withCacheSize(e){return new op(e,op.DEFAULT_COLLECTION_PERCENTILE,op.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function oy(e,t,n){const r=e.store(e6),s=e.store(tn),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.ee({range:o},(e,t,n)=>(a++,n.delete()));i.push(c.next(()=>{E(1===a,47070,{batchId:n.batchId})}));const u=[];for(const e of n.mutations){const r=te(t,e.key.path,n.batchId);i.push(s.delete(r)),u.push(e.key)}return eC.waitFor(i).next(()=>u)}function ow(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw b(14731);t=e.noDocument}return JSON.stringify(t).length}op.DEFAULT_COLLECTION_PERCENTILE=10,op.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,op.DEFAULT=new op(og,op.DEFAULT_COLLECTION_PERCENTILE,op.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),op.DISABLED=new op(-1,0,0);class ov{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Xn={}}static wt(e,t,n,r){E(""!==e.uid,64387);const s=e.isAuthenticated()?e.uid:"";return new ov(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return o_(e).ee({index:e8,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){const s=ob(e),i=o_(e);return i.add({}).next(o=>{E("number"==typeof o,49019);const a=new sT(o,t,n,r),c=function e(e,t,n){const r=n.baseMutations.map(t=>ia(e.yt,t)),s=n.mutations.map(t=>ia(e.yt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),u=[];let l=new nt((e,t)=>B(e.canonicalString(),t.canonicalString()));for(const e of r){const t=te(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),u.push(i.put(c)),u.push(s.put(t,tt))}return l.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Xn[o]=a.keys()}),eC.waitFor(u).next(()=>a)})}lookupMutationBatch(e,t){return o_(e).get(t).next(e=>e?(E(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),iR(this.serializer,e)):null)}er(e,t){return this.Xn[t]?eC.resolve(this.Xn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){const n=e.keys();return this.Xn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return o_(e).ee({index:e8,range:r},(e,t,r)=>{t.userId===this.userId&&(E(t.batchId>=n,47524,{tr:n}),s=iR(this.serializer,t)),r.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=eK;return o_(e).ee({index:e8,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,eK],[this.userId,Number.POSITIVE_INFINITY]);return o_(e).J(e8,t).next(e=>e.map(e=>iR(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=e7(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return ob(e).ee({range:r},(n,r,i)=>{const[o,a,c]=n,u=eZ(a);if(o===this.userId&&t.path.isEqual(u))return o_(e).get(c).next(e=>{if(!e)throw b(61480,{nr:n,batchId:c});E(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:c}),s.push(iR(this.serializer,e))});i.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new nt(B);const r=[];return t.forEach(t=>{const s=e7(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=ob(e).ee({range:i},(e,r,s)=>{const[i,o,a]=e,c=eZ(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):s.done()});r.push(o)}),eC.waitFor(r).next(()=>this.rr(e,n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=e7(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new nt(B);return ob(e).ee({range:i},(e,t,s)=>{const[i,a,c]=e,u=eZ(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()}).next(()=>this.rr(e,o))}rr(e,t){const n=[],r=[];return t.forEach(t=>{r.push(o_(e).get(t).next(e=>{if(null===e)throw b(35274,{batchId:t});E(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),n.push(iR(this.serializer,e))}))}),eC.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return oy(e.le,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.ir(t.batchId)}),eC.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}ir(e){delete this.Xn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return eC.resolve();const n=IDBKeyRange.lowerBound(function e(e){return[e]}(this.userId)),r=[];return ob(e).ee({range:n},(e,t,n)=>{if(e[0]===this.userId){const t=eZ(e[1]);r.push(t)}else n.done()}).next(()=>{E(0===r.length,56720,{sr:r.map(e=>e.canonicalString())})})})}containsKey(e,t){return oI(e,this.userId,t)}_r(e){return oT(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:eK,lastStreamToken:""})}}function oI(e,t,n){const r=e7(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return ob(e).ee({range:i,X:!0},(e,n,r)=>{const[i,a,c]=e;i===t&&a===s&&(o=!0),r.done()}).next(()=>o)}function o_(e){return t4(e,e6)}function ob(e){return t4(e,tn)}function oT(e){return t4(e,e4)}class oE{constructor(e){this.ar=e}next(){return this.ar+=2,this.ar}static ur(){return new oE(0)}static cr(){return new oE(-1)}}class oS{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.lr(e).next(t=>{const n=new oE(t.highestTargetId);return t.highestTargetId=n.next(),this.hr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.lr(e).next(e=>ef.fromTimestamp(new ed(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.lr(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.lr(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.hr(e,r)))}addTargetData(e,t){return this.Pr(e,t).next(()=>this.lr(e).next(n=>(n.targetCount+=1,this.Tr(t,n),this.hr(e,n))))}updateTargetData(e,t){return this.Pr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>ox(e).delete(t.targetId)).next(()=>this.lr(e)).next(t=>(E(t.targetCount>0,8065),t.targetCount-=1,this.hr(e,t)))}removeTargets(e,t,n){let r=0;const s=[];return ox(e).ee((i,o)=>{const a=iM(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))}).next(()=>eC.waitFor(s)).next(()=>r)}forEachTarget(e,t){return ox(e).ee((e,n)=>{const r=iM(n);t(r)})}lr(e){return oN(e).get(tw).next(e=>(E(null!==e,2888),e))}hr(e,t){return oN(e).put(tw,t)}Pr(e,t){return ox(e).put(iV(this.serializer,t))}Tr(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.lr(e).next(e=>e.targetCount)}getTargetData(e,t){const n=rp(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return ox(e).ee({range:r,index:td},(e,n,r)=>{const i=iM(n);ry(t,i.target)&&(s=i,r.done())}).next(()=>s)}addMatchingKeys(e,t,n){const r=[],s=oD(e);return t.forEach(t=>{const i=eH(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))}),eC.waitFor(r)}removeMatchingKeys(e,t,n){const r=oD(e);return eC.forEach(t,t=>{const s=eH(t.path);return eC.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){const n=oD(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=oD(e);let s=rY();return r.ee({range:n,X:!0},(e,t,n)=>{const r=eZ(e[1]),i=new Z(r);s=s.add(i)}).next(()=>s)}containsKey(e,t){const n=eH(t.path),r=IDBKeyRange.bound([n],[Q(n)],!1,!0);let s=0;return oD(e).ee({index:tp,X:!0,range:r},([e,t],n,r)=>{0!==e&&(s++,r.done())}).next(()=>s>0)}At(e,t){return ox(e).get(t).next(e=>e?iM(e):null)}}function ox(e){return t4(e,th)}function oN(e){return t4(e,tv)}function oD(e){return t4(e,tm)}const oC="LruGarbageCollector",oA=1048576;function ok([e,t],[n,r]){const s=B(e,n);return 0===s?B(t,r):s}class oR{constructor(e){this.Ir=e,this.buffer=new nt(ok),this.Er=0}dr(){return++this.Er}Ar(e){const t=[e,this.dr()];if(this.buffer.size<this.Ir)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();ok(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class oM{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Rr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Vr(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return null!==this.Rr}Vr(e){w(oC,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eF(e)?w(oC,"Ignoring IndexedDB error during garbage collection: ",e):await eD(e)}await this.Vr(3e5)})}}class oV{constructor(e,t){this.mr=e,this.params=t}calculateTargetCount(e,t){return this.mr.gr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return eC.resolve(eG.ce);const n=new oR(t);return this.mr.forEachTarget(e,e=>n.Ar(e.sequenceNumber)).next(()=>this.mr.pr(e,e=>n.Ar(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.mr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.mr.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(w("LruGarbageCollector","Garbage collection skipped; disabled"),eC.resolve(om)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(w("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),om):this.yr(e,t))}getCacheSize(e){return this.mr.getCacheSize(e)}yr(e,t){let n,r,s,o,a,c,u;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(w("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(s=t,c=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>{if(u=Date.now(),p()<=i.$b.DEBUG){w("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-l}ms
	Determined least recently used ${r} in `+(a-o)+"ms\n"+`	Removed ${s} targets in `+(c-a)+"ms\n"+`	Removed ${e} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-l}ms`)}return eC.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e})})}}function oO(e,t){return new oV(e,t)}class oF{constructor(e,t){this.db=e,this.garbageCollector=oO(this,t)}gr(e){const t=this.wr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}pr(e,t){return this.Sr(e,(e,n)=>t(n))}addReference(e,t,n){return oP(e,n)}removeReference(e,t,n){return oP(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return oP(e,t)}br(e,t){return function e(e,t){let n=!1;return oT(e).te(r=>oI(e,r,t).next(e=>(e&&(n=!0),eC.resolve(!e)))).next(()=>n)}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Sr(e,(i,o)=>{if(o<=t){const t=this.br(e,i).next(t=>{if(!t)return s++,n.getEntry(e,i).next(()=>(n.removeEntry(i,ef.min()),oD(e).delete(function e(e){return[0,eH(e.path)]}(i))))});r.push(t)}}).next(()=>eC.waitFor(r)).next(()=>n.apply(e)).next(()=>s)}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return oP(e,t)}Sr(e,t){const n=oD(e);let r,s=eG.ce;return n.ee({index:tp},([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==eG.ce&&t(new Z(eZ(r)),s),s=o,r=i):s=eG.ce}).next(()=>{s!==eG.ce&&t(new Z(eZ(r)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function oP(e,t){return oD(e).put(function e(e,t){return{targetId:0,path:eH(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class oL{constructor(){this.changes=new rU(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,nZ.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?eC.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class oq{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return o$(e).put(n)}removeEntry(e,t,n){return o$(e).delete(function e(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],iC(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.Dr(e,n)))}getEntry(e,t){let n=nZ.newInvalidDocument(t);return o$(e).ee({index:ti,range:IDBKeyRange.only(oG(t))},(e,r)=>{n=this.Cr(t,r)}).next(()=>n)}vr(e,t){let n={size:0,document:nZ.newInvalidDocument(t)};return o$(e).ee({index:ti,range:IDBKeyRange.only(oG(t))},(e,r)=>{n={document:this.Cr(t,r),size:ow(r)}}).next(()=>n)}getEntries(e,t){let n=rz();return this.Fr(e,t,(e,t)=>{const r=this.Cr(e,t);n=n.insert(e,r)}).next(()=>n)}Mr(e,t){let n=rz(),r=new t9(Z.comparator);return this.Fr(e,t,(e,t)=>{const s=this.Cr(e,t);n=n.insert(e,s),r=r.insert(e,ow(t))}).next(()=>({documents:n,Or:r}))}Fr(e,t,n){if(t.isEmpty())return eC.resolve();let r=new nt(oj);t.forEach(e=>r=r.add(e));const s=IDBKeyRange.bound(oG(r.first()),oG(r.last())),i=r.getIterator();let o=i.getNext();return o$(e).ee({index:ti,range:s},(e,t,r)=>{const s=Z.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&oj(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.j(oG(o)):r.done()}).next(()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,s){const i=t.path,o=[i.popLast().toArray(),i.lastSegment(),iC(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return o$(e).J(IDBKeyRange.bound(o,a,!0)).next(e=>{s?.incrementDocumentReadCount(e.length);let n=rz();for(const s of e){const e=this.Cr(Z.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(rF(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let s=rz();const i=oK(t,n),o=oK(t,eE.max());return o$(e).ee({index:ta,range:IDBKeyRange.bound(i,o,!0)},(e,t,n)=>{const i=this.Cr(Z.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()}).next(()=>s)}newChangeBuffer(e){return new oB(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return oz(e).get(tl).next(e=>(E(!!e,20021),e))}Dr(e,t){return oz(e).put(tl,t)}Cr(e,t){if(t){const e=iN(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(ef.min())))return e}return nZ.newInvalidDocument(e)}}function oU(e){return new oq(e)}class oB extends oL{constructor(e,t){super(),this.Nr=e,this.trackRemovals=t,this.Br=new rU(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){const t=[];let n=0,r=new nt((e,t)=>B(e.canonicalString(),t.canonicalString()));return this.changes.forEach((s,i)=>{const o=this.Br.get(s);if(t.push(this.Nr.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=iD(this.Nr.serializer,i);r=r.add(s.path.popLast());const c=ow(a);n+=c-o.size,t.push(this.Nr.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=iD(this.Nr.serializer,i.convertToNoDocument(ef.min()));t.push(this.Nr.addEntry(e,s,n))}}),r.forEach(n=>{t.push(this.Nr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Nr.updateMetadata(e,n)),eC.waitFor(t)}getFromCache(e,t){return this.Nr.vr(e,t).next(e=>(this.Br.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Nr.Mr(e,t).next(({documents:e,Or:t})=>(t.forEach((t,n)=>{this.Br.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function oz(e){return t4(e,tu)}function o$(e){return t4(e,tr)}function oG(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function oK(e,t){const n=t.documentKey.path.toArray();return[e,iC(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function oj(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=B(n[e],r[e]),s)return s;return s=B(n.length,r.length),s||(s=B(n[n.length-2],r[r.length-2]),s||B(n[n.length-1],r[r.length-1]))}class oQ{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class oW{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&sf(n.mutation,e,ns.empty(),ed.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,rY()).next(()=>t))}getLocalViewOfDocuments(e,t,n=rY()){const r=rj();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=rG();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){const n=rj();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,rY()))}populateOverlays(e,t,n){const r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let s=rz();const i=rW(),o=function e(){return rW()}();return t.forEach((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof sy)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),sf(o.mutation,t,o.mutation.getFieldMask(),ed.now())):i.set(t.key,ns.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>i.set(e,t)),t.forEach((e,t)=>o.set(e,new oQ(t,i.get(e)??null))),o))}recalculateAndSaveOverlays(e,t){const n=rW();let r=new t9((e,t)=>e-t),s=rY();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(const s of e)s.keys().forEach(e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||ns.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||rY()).add(e);r=r.insert(s.batchId,a)})}).next(()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=rQ();c.forEach(e=>{if(!s.has(e)){const r=sh(t.get(e),n.get(e));null!==r&&u.set(e,r),s=s.add(e)}}),i.push(this.documentOverlayCache.saveOverlays(e,a,u))}return eC.waitFor(i)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return function e(e){return Z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):rx(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):eC.resolve(rj());let o=em,a=s;return i.next(t=>eC.forEach(t,(t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?eC.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{a=a.insert(t,e)}))).next(()=>this.populateOverlays(e,t,s)).next(()=>this.computeViews(e,a,t,rY())).next(e=>({batchId:o,changes:rK(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Z(t)).next(e=>{let t=rG();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const s=t.collectionGroup;let i=rG();return this.indexManager.getCollectionParents(e,s).next(o=>eC.forEach(o,o=>{const a=function e(e,t){return new rb(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,o.child(s));return this.getDocumentsMatchingCollectionQuery(e,a,n,r).next(e=>{e.forEach((e,t)=>{i=i.insert(e,t)})})}).next(()=>i))}getDocumentsMatchingCollectionQuery(e,t,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,r))).next(e=>{s.forEach((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,nZ.newInvalidDocument(r)))});let n=rG();return e.forEach((e,r)=>{const i=s.get(e);void 0!==i&&sf(i.mutation,r,ns.empty(),ed.now()),rF(t,r)&&(n=n.insert(e,r))}),n})}}class oJ{constructor(e){this.serializer=e,this.Lr=new Map,this.kr=new Map}getBundleMetadata(e,t){return eC.resolve(this.Lr.get(t))}saveBundleMetadata(e,t){return this.Lr.set(t.id,function e(e){return{id:e.id,version:e.version,createTime:s2(e.createTime)}}(t)),eC.resolve()}getNamedQuery(e,t){return eC.resolve(this.kr.get(t))}saveNamedQuery(e,t){return this.kr.set(t.name,function e(e){return{name:e.name,query:iO(e.bundledQuery),readTime:s2(e.readTime)}}(t)),eC.resolve()}}class oH{constructor(){this.overlays=new t9(Z.comparator),this.qr=new Map}getOverlay(e,t){return eC.resolve(this.overlays.get(t))}getOverlays(e,t){const n=rj();return eC.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.St(e,t,r)}),eC.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.qr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.qr.delete(n)),eC.resolve()}getOverlaysForCollection(e,t,n){const r=rj(),s=t.length+1,i=new Z(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return eC.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new t9((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=rj(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=rj(),a=s.getIterator();for(;a.hasNext();){if(a.getNext().value.forEach((e,t)=>o.set(e,t)),o.size()>=r)break}return eC.resolve(o)}St(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.qr.get(r.largestBatchId).delete(n.key);this.qr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new sS(t,n));let s=this.qr.get(t);void 0===s&&(s=rY(),this.qr.set(t,s)),this.qr.set(t,s.add(n.key))}}class oY{constructor(){this.sessionToken=na.EMPTY_BYTE_STRING}getSessionToken(e){return eC.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,eC.resolve()}}class oX{constructor(){this.Qr=new nt(oZ.$r),this.Ur=new nt(oZ.Kr)}isEmpty(){return this.Qr.isEmpty()}addReference(e,t){const n=new oZ(e,t);this.Qr=this.Qr.add(n),this.Ur=this.Ur.add(n)}Wr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Gr(new oZ(e,t))}zr(e,t){e.forEach(e=>this.removeReference(e,t))}jr(e){const t=new Z(new H([])),n=new oZ(t,e),r=new oZ(t,e+1),s=[];return this.Ur.forEachInRange([n,r],e=>{this.Gr(e),s.push(e.key)}),s}Jr(){this.Qr.forEach(e=>this.Gr(e))}Gr(e){this.Qr=this.Qr.delete(e),this.Ur=this.Ur.delete(e)}Hr(e){const t=new Z(new H([])),n=new oZ(t,e),r=new oZ(t,e+1);let s=rY();return this.Ur.forEachInRange([n,r],e=>{s=s.add(e.key)}),s}containsKey(e){const t=new oZ(e,0),n=this.Qr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class oZ{constructor(e,t){this.key=e,this.Yr=t}static $r(e,t){return Z.comparator(e.key,t.key)||B(e.Yr,t.Yr)}static Kr(e,t){return B(e.Yr,t.Yr)||Z.comparator(e.key,t.key)}}class o0{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.tr=1,this.Zr=new nt(oZ.$r)}checkEmpty(e){return eC.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.tr;this.tr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new sT(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.Zr=this.Zr.add(new oZ(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return eC.resolve(i)}lookupMutationBatch(e,t){return eC.resolve(this.Xr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.ei(n),s=r<0?0:r;return eC.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return eC.resolve(0===this.mutationQueue.length?eK:this.tr-1)}getAllMutationBatches(e){return eC.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new oZ(t,0),r=new oZ(t,Number.POSITIVE_INFINITY),s=[];return this.Zr.forEachInRange([n,r],e=>{const t=this.Xr(e.Yr);s.push(t)}),eC.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new nt(B);return t.forEach(e=>{const t=new oZ(e,0),r=new oZ(e,Number.POSITIVE_INFINITY);this.Zr.forEachInRange([t,r],e=>{n=n.add(e.Yr)})}),eC.resolve(this.ti(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;Z.isDocumentKey(s)||(s=s.child(""));const i=new oZ(new Z(s),0);let o=new nt(B);return this.Zr.forEachWhile(e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.Yr)),!0)},i),eC.resolve(this.ti(o))}ti(e){const t=[];return e.forEach(e=>{const n=this.Xr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){E(0===this.ni(t.batchId,"removed"),55003),this.mutationQueue.shift();let n=this.Zr;return eC.forEach(t.mutations,r=>{const s=new oZ(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Zr=n})}ir(e){}containsKey(e,t){const n=new oZ(t,0),r=this.Zr.firstAfterOrEqual(n);return eC.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,eC.resolve()}ni(e,t){return this.ei(e)}ei(e){if(0===this.mutationQueue.length)return 0;return e-this.mutationQueue[0].batchId}Xr(e){const t=this.ei(e);if(t<0||t>=this.mutationQueue.length)return null;return this.mutationQueue[t]}}class o1{constructor(e){this.ri=e,this.docs=function e(){return new t9(Z.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.ri(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return eC.resolve(n?n.document.mutableCopy():nZ.newInvalidDocument(t))}getEntries(e,t){let n=rz();return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():nZ.newInvalidDocument(e))}),eC.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=rz();const i=t.path,o=new Z(i.child("__id-9223372036854775808__")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||eS(eT(o),n)<=0||(r.has(o.key)||rF(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return eC.resolve(s)}getAllFromCollectionGroup(e,t,n,r){b(9500)}ii(e,t){return eC.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new o2(this)}getSize(e){return eC.resolve(this.size)}}class o2 extends oL{constructor(e){super(),this.Nr=e}applyChanges(e){const t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Nr.addEntry(e,r)):this.Nr.removeEntry(n)}),eC.waitFor(t)}getFromCache(e,t){return this.Nr.getEntry(e,t)}getAllFromCache(e,t){return this.Nr.getEntries(e,t)}}class o4{constructor(e){this.persistence=e,this.si=new rU(e=>rp(e),ry),this.lastRemoteSnapshotVersion=ef.min(),this.highestTargetId=0,this.oi=0,this._i=new oX,this.targetCount=0,this.ai=oE.ur()}forEachTarget(e,t){return this.si.forEach((e,n)=>t(n)),eC.resolve()}getLastRemoteSnapshotVersion(e){return eC.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return eC.resolve(this.oi)}allocateTargetId(e){return this.highestTargetId=this.ai.next(),eC.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.oi&&(this.oi=t),eC.resolve()}Pr(e){this.si.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.ai=new oE(t),this.highestTargetId=t),e.sequenceNumber>this.oi&&(this.oi=e.sequenceNumber)}addTargetData(e,t){return this.Pr(t),this.targetCount+=1,eC.resolve()}updateTargetData(e,t){return this.Pr(t),eC.resolve()}removeTargetData(e,t){return this.si.delete(t.target),this._i.jr(t.targetId),this.targetCount-=1,eC.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.si.forEach((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.si.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)}),eC.waitFor(s).next(()=>r)}getTargetCount(e){return eC.resolve(this.targetCount)}getTargetData(e,t){const n=this.si.get(t)||null;return eC.resolve(n)}addMatchingKeys(e,t,n){return this._i.Wr(t,n),eC.resolve()}removeMatchingKeys(e,t,n){this._i.zr(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach(t=>{s.push(r.markPotentiallyOrphaned(e,t))}),eC.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this._i.jr(t),eC.resolve()}getMatchingKeysForTargetId(e,t){const n=this._i.Hr(t);return eC.resolve(n)}containsKey(e,t){return eC.resolve(this._i.containsKey(t))}}class o3{constructor(e,t){this.ui={},this.overlays={},this.ci=new eG(0),this.li=!1,this.li=!0,this.hi=new oY,this.referenceDelegate=e(this),this.Pi=new o4(this);this.indexManager=new os,this.remoteDocumentCache=function e(e){return new o1(e)}(e=>this.referenceDelegate.Ti(e)),this.serializer=new ix(t),this.Ii=new oJ(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.li=!1,Promise.resolve()}get started(){return this.li}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new oH,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.ui[e.toKey()];return n||(n=new o0(t,this.referenceDelegate),this.ui[e.toKey()]=n),n}getGlobalsCache(){return this.hi}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ii}runTransaction(e,t,n){w("MemoryPersistence","Starting transaction:",e);const r=new o6(this.ci.next());return this.referenceDelegate.Ei(),n(r).next(e=>this.referenceDelegate.di(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ai(e,t){return eC.or(Object.values(this.ui).map(n=>()=>n.containsKey(e,t)))}}class o6 extends eN{constructor(e){super(),this.currentSequenceNumber=e}}class o5{constructor(e){this.persistence=e,this.Ri=new oX,this.Vi=null}static mi(e){return new o5(e)}get fi(){if(this.Vi)return this.Vi;throw b(60996)}addReference(e,t,n){return this.Ri.addReference(n,t),this.fi.delete(n.toString()),eC.resolve()}removeReference(e,t,n){return this.Ri.removeReference(n,t),this.fi.add(n.toString()),eC.resolve()}markPotentiallyOrphaned(e,t){return this.fi.add(t.toString()),eC.resolve()}removeTarget(e,t){this.Ri.jr(t.targetId).forEach(e=>this.fi.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.fi.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Ei(){this.Vi=new Set}di(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return eC.forEach(this.fi,n=>{const r=Z.fromPath(n);return this.gi(e,r).next(e=>{e||t.removeEntry(r,ef.min())})}).next(()=>(this.Vi=null,t.apply(e)))}updateLimboDocument(e,t){return this.gi(e,t).next(e=>{e?this.fi.delete(t.toString()):this.fi.add(t.toString())})}Ti(e){return 0}gi(e,t){return eC.or([()=>eC.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}}class o8{constructor(e,t){this.persistence=e,this.pi=new rU(e=>eH(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=oO(this,t)}static mi(e,t){return new o8(e,t)}Ei(){}di(e){return eC.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}gr(e){const t=this.wr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}pr(e,t){return eC.forEach(this.pi,(n,r)=>this.br(e,n,r).next(e=>e?eC.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.ii(e,r=>this.br(e,r,t).next(e=>{e||(n++,s.removeEntry(r,ef.min()))})).next(()=>s.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.pi.set(t,e.currentSequenceNumber),eC.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.pi.set(n,e.currentSequenceNumber),eC.resolve()}removeReference(e,t,n){return this.pi.set(n,e.currentSequenceNumber),eC.resolve()}updateLimboDocument(e,t){return this.pi.set(t,e.currentSequenceNumber),eC.resolve()}Ti(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=nF(e.data.value)),t}br(e,t,n){return eC.or([()=>this.persistence.Ai(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const e=this.pi.get(t);return eC.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class o9{constructor(e){this.serializer=e}k(e,t,n,r){const s=new ek("createOrUpgrade",t);n<1&&r>=1&&(!function e(e){e.createObjectStore(e1)}(e),function e(e){e.createObjectStore(e4,{keyPath:e3});const t=e.createObjectStore(e6,{keyPath:e5,autoIncrement:!0});t.createIndex(e8,e9,{unique:!0}),e.createObjectStore(tn)}(e),o7(e),function e(e){e.createObjectStore(e0)}(e));let i=eC.resolve();return n<3&&r>=3&&(0!==n&&(!function e(e){e.deleteObjectStore(tm),e.deleteObjectStore(th),e.deleteObjectStore(tv)}(e),o7(e)),i=i.next(()=>(function e(e){const t=e.store(tv),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ef.min().toTimestamp(),targetCount:0};return t.put(tw,n)})(s))),n<4&&r>=4&&(0!==n&&(i=i.next(()=>(function e(e,t){const n=t.store(e6);return n.J().next(n=>{e.deleteObjectStore(e6);e.createObjectStore(e6,{keyPath:e5,autoIncrement:!0}).createIndex(e8,e9,{unique:!0});const r=t.store(e6),s=n.map(e=>r.put(e));return eC.waitFor(s)})})(e,s))),i=i.next(()=>{!function e(e){e.createObjectStore(tb,{keyPath:tT})}(e)})),n<5&&r>=5&&(i=i.next(()=>this.yi(s))),n<6&&r>=6&&(i=i.next(()=>((function e(e){e.createObjectStore(tu)})(e),this.wi(s)))),n<7&&r>=7&&(i=i.next(()=>this.Si(s))),n<8&&r>=8&&(i=i.next(()=>this.bi(e,s))),n<9&&r>=9&&(i=i.next(()=>{!function e(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)})),n<10&&r>=10&&(i=i.next(()=>this.Di(s))),n<11&&r>=11&&(i=i.next(()=>{!function e(e){e.createObjectStore(tE,{keyPath:tS})}(e),function e(e){e.createObjectStore(tx,{keyPath:tN})}(e)})),n<12&&r>=12&&(i=i.next(()=>{!function e(e){const t=e.createObjectStore(tU,{keyPath:tB});t.createIndex(tz,t$,{unique:!1}),t.createIndex(tG,tK,{unique:!1})}(e)})),n<13&&r>=13&&(i=i.next(()=>(function e(e){const t=e.createObjectStore(tr,{keyPath:ts});t.createIndex(ti,to),t.createIndex(ta,tc)})(e)).next(()=>this.Ci(e,s)).next(()=>e.deleteObjectStore(e0))),n<14&&r>=14&&(i=i.next(()=>this.Fi(e,s))),n<15&&r>=15&&(i=i.next(()=>(function e(e){const t=e.createObjectStore(tD,{keyPath:tC,autoIncrement:!0});t.createIndex(tA,tk,{unique:!1});const n=e.createObjectStore(tR,{keyPath:tM});n.createIndex(tV,tO,{unique:!1});const r=e.createObjectStore(tF,{keyPath:tP});r.createIndex(tL,tq,{unique:!1})})(e))),n<16&&r>=16&&(i=i.next(()=>{t.objectStore(tR).clear()}).next(()=>{t.objectStore(tF).clear()})),n<17&&r>=17&&(i=i.next(()=>{!function e(e){e.createObjectStore(tj,{keyPath:tQ})}(e)})),n<18&&r>=18&&(0,o.Ov)()&&(i=i.next(()=>{t.objectStore(tR).clear()}).next(()=>{t.objectStore(tF).clear()})),i}wi(e){let t=0;return e.store(e0).ee((e,n)=>{t+=ow(n)}).next(()=>{const n={byteSize:t};return e.store(tu).put(tl,n)})}yi(e){const t=e.store(e4),n=e.store(e6);return t.J().next(t=>eC.forEach(t,t=>{const r=IDBKeyRange.bound([t.userId,eK],[t.userId,t.lastAcknowledgedBatchId]);return n.J(e8,r).next(n=>eC.forEach(n,n=>{E(n.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:n.batchId});const r=iR(this.serializer,n);return oy(e,t.userId,r).next(()=>{})}))}))}Si(e){const t=e.store(tm),n=e.store(e0);return e.store(tv).get(tw).next(e=>{const r=[];return n.ee((n,s)=>{const i=new H(n),o=function e(e){return[0,eH(e)]}(i);r.push(t.get(o).next(n=>n?eC.resolve():(n=>t.put({targetId:0,path:eH(n),sequenceNumber:e.highestListenSequenceNumber}))(i)))}).next(()=>eC.waitFor(r))})}bi(e,t){e.createObjectStore(tI,{keyPath:t_});const n=t.store(tI),r=new oi,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eH(r)})}};return t.store(e0).ee({X:!0},(e,t)=>{const n=new H(e);return s(n.popLast())}).next(()=>t.store(tn).ee({X:!0},([e,t,n],r)=>{const i=eZ(t);return s(i.popLast())}))}Di(e){const t=e.store(th);return t.ee((e,n)=>{const r=iM(n),s=iV(this.serializer,r);return t.put(s)})}Ci(e,t){const n=t.store(e0),r=[];return n.ee((e,n)=>{const s=t.store(tr),i=(function e(e){return e.document?new Z(H.fromString(e.document.name).popFirst(5)):e.noDocument?Z.fromSegments(e.noDocument.path):e.unknownDocument?Z.fromSegments(e.unknownDocument.path):b(36783)})(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))}).next(()=>eC.waitFor(r))}Fi(e,t){const n=t.store(e6),r=oU(this.serializer),s=new o3(o5.mi,this.serializer.yt);return n.J().next(e=>{const n=new Map;return e.forEach(e=>{let t=n.get(e.userId)??rY();iR(this.serializer,e).keys().forEach(e=>t=t.add(e)),n.set(e.userId,t)}),eC.forEach(n,(e,n)=>{const i=new f(n),o=iz.wt(this.serializer,i),a=s.getIndexManager(i),c=ov.wt(i,this.serializer,a,s.referenceDelegate);return new oW(r,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new t2(t,eG.ce),e).next()})})}}function o7(e){e.createObjectStore(tm,{keyPath:tg}).createIndex(tp,ty,{unique:!0});e.createObjectStore(th,{keyPath:"targetId"}).createIndex(td,tf,{unique:!0}),e.createObjectStore(tv)}const ae="IndexedDbPersistence",at=18e5,an=5e3,ar="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",as="main";class ai{constructor(e,t,n,r,s,i,o,a,c,u,l=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Mi=s,this.window=i,this.document=o,this.xi=c,this.Oi=u,this.Ni=l,this.ci=null,this.li=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Bi=null,this.inForeground=!1,this.Li=null,this.ki=null,this.qi=Number.NEGATIVE_INFINITY,this.Qi=e=>Promise.resolve(),!ai.v())throw new D(N.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new oF(this,r),this.$i=t+as,this.serializer=new ix(a),this.Ui=new eR(this.$i,this.Ni,new o9(this.serializer)),this.hi=new iG,this.Pi=new oS(this.referenceDelegate,this.serializer),this.remoteDocumentCache=oU(this.serializer),this.Ii=new iq,this.window&&this.window.localStorage?this.Ki=this.window.localStorage:(this.Ki=null,!1===u&&v(ae,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new D(N.FAILED_PRECONDITION,ar);return this.Gi(),this.zi(),this.ji(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Pi.getHighestSequenceNumber(e))}).then(e=>{this.ci=new eG(e,this.xi)}).then(()=>{this.li=!0}).catch(e=>(this.Ui&&this.Ui.close(),Promise.reject(e)))}Ji(e){return this.Qi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ui.$(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Mi.enqueueAndForget(async()=>{this.started&&await this.Wi()}))}Wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>aa(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Hi(e).next(e=>{e||(this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)))})}).next(()=>this.Yi(e)).next(t=>this.isPrimary&&!t?this.Zi(e).next(()=>!1):!!t&&this.Xi(e).next(()=>!0))).catch(e=>{if(eF(e))return w(ae,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return w(ae,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Mi.enqueueRetryable(()=>this.Qi(e)),this.isPrimary=e})}Hi(e){return ao(e).get(e2).next(e=>eC.resolve(this.es(e)))}ts(e){return aa(e).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.rs(this.qi,at)){this.qi=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const t=t4(e,tb);return t.J().next(e=>{const n=this.ss(e,at),r=e.filter(e=>-1===n.indexOf(e));return eC.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Ki)for(const t of e)this.Ki.removeItem(this._s(t.clientId))}}ji(){this.ki=this.Mi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Wi().then(()=>this.ns()).then(()=>this.ji()))}es(e){return!!e&&e.ownerId===this.clientId}Yi(e){if(this.Oi)return eC.resolve(!0);return ao(e).get(e2).next(t=>{if(null!==t&&this.rs(t.leaseTimestampMs,an)&&!this.us(t.ownerId)){if(this.es(t)&&this.networkEnabled)return!0;if(!this.es(t)){if(!t.allowTabSynchronization)throw new D(N.FAILED_PRECONDITION,ar);return!1}}return!(!this.networkEnabled||!this.inForeground)||aa(e).J().next(e=>void 0===this.ss(e,an).find(e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&w(ae,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.li=!1,this.cs(),this.ki&&(this.ki.cancel(),this.ki=null),this.ls(),this.hs(),await this.Ui.runTransaction("shutdown","readwrite",[e1,tb],e=>{const t=new t2(e,eG.ce);return this.Zi(t).next(()=>this.ts(t))}),this.Ui.close(),this.Ps()}ss(e,t){return e.filter(e=>this.rs(e.updateTimeMs,t)&&!this.us(e.clientId))}Ts(){return this.runTransaction("getActiveClients","readonly",e=>aa(e).J().next(e=>this.ss(e,at).map(e=>e.clientId)))}get started(){return this.li}getGlobalsCache(){return this.hi}getMutationQueue(e,t){return ov.wt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new oc(e,this.serializer.yt.databaseId)}getDocumentOverlayCache(e){return iz.wt(this.serializer,e)}getBundleCache(){return this.Ii}runTransaction(e,t,n){w(ae,"Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=function e(e){return 18===e?t1:17===e?t0:16===e?tZ:15===e?tX:14===e?tY:13===e?tH:12===e?tJ:11===e?tW:void b(60245)}(this.Ni);let i;return this.Ui.runTransaction(e,r,s,r=>(i=new t2(r,this.ci?this.ci.next():eG.ce),"readwrite-primary"===t?this.Hi(i).next(e=>!!e||this.Yi(i)).next(t=>{if(!t)throw v(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)),new D(N.FAILED_PRECONDITION,ex);return n(i)}).next(e=>this.Xi(i).next(()=>e)):this.Is(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Is(e){return ao(e).get(e2).next(e=>{if(null!==e&&this.rs(e.leaseTimestampMs,an)&&!this.us(e.ownerId)&&!this.es(e)&&!(this.Oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new D(N.FAILED_PRECONDITION,ar)})}Xi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return ao(e).put(e2,t)}static v(){return eR.v()}Zi(e){const t=ao(e);return t.get(e2).next(e=>this.es(e)?(w(ae,"Releasing primary lease."),t.delete(e2)):eC.resolve())}rs(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(v(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Li=()=>{this.Mi.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Wi()))},this.document.addEventListener("visibilitychange",this.Li),this.inForeground="visible"===this.document.visibilityState)}ls(){this.Li&&(this.document.removeEventListener("visibilitychange",this.Li),this.Li=null)}zi(){"function"==typeof this.window?.addEventListener&&(this.Bi=()=>{this.cs();const e=/(?:Version|Mobile)\/1[456]/;(0,o.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Mi.enterRestrictedMode(!0),this.Mi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Bi))}hs(){this.Bi&&(this.window.removeEventListener("pagehide",this.Bi),this.Bi=null)}us(e){try{const t=null!==this.Ki?.getItem(this._s(e));return w(ae,`Client '${e}' ${t?"is":"is not"} zombied in LocalStorage`),t}catch(e){return v(ae,"Failed to get zombied client id.",e),!1}}cs(){if(this.Ki)try{this.Ki.setItem(this._s(this.clientId),String(Date.now()))}catch(e){v("Failed to set zombie client id.",e)}}Ps(){if(this.Ki)try{this.Ki.removeItem(this._s(this.clientId))}catch(e){}}_s(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function ao(e){return t4(e,e1)}function aa(e){return t4(e,tb)}function ac(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class au{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Es=n,this.ds=r}static As(e,t){let n=rY(),r=rY();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new au(e,t.fromCache,n,r)}}class al{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class ah{constructor(){this.Rs=!1,this.Vs=!1,this.fs=100,this.gs=function e(){return(0,o.nr)()?8:eM((0,o.ZQ)())>0?6:4}()}initialize(e,t){this.ps=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,n,r){const s={result:null};return this.ys(e,t).next(e=>{s.result=e}).next(()=>{if(!s.result)return this.ws(e,t,r,n).next(e=>{s.result=e})}).next(()=>{if(s.result)return;const n=new al;return this.Ss(e,t,n).next(r=>{if(s.result=r,this.Vs)return this.bs(e,t,n,r.size)})}).next(()=>s.result)}bs(e,t,n,r){return n.documentReadCount<this.fs?(p()<=i.$b.DEBUG&&w("QueryEngine","SDK will not create cache indexes for query:",rO(t),"since it only creates cache indexes for collection contains","more than or equal to",this.fs,"documents"),eC.resolve()):(p()<=i.$b.DEBUG&&w("QueryEngine","Query:",rO(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.gs*r?(p()<=i.$b.DEBUG&&w("QueryEngine","The SDK decides to create cache indexes for query:",rO(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,rD(t))):eC.resolve())}ys(e,t){if(rS(t))return eC.resolve(null);let n=rD(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(t=rR(t,null,"F"),n=rD(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{const s=rY(...r);return this.ps.getDocuments(e,s).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{const i=this.Ds(t,r);return this.Cs(t,i,s,n.readTime)?this.ys(e,rR(t,null,"F")):this.vs(e,i,t,n)}))})))}ws(e,t,n,r){return rS(t)||r.isEqual(ef.min())?eC.resolve(null):this.ps.getDocuments(e,n).next(s=>{const o=this.Ds(t,s);return this.Cs(t,o,n,r)?eC.resolve(null):(p()<=i.$b.DEBUG&&w("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),rO(t)),this.vs(e,o,t,eb(r,em)).next(e=>e))})}Ds(e,t){let n=new nt(rL(e));return t.forEach((t,r)=>{rF(e,r)&&(n=n.add(r))}),n}Cs(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ss(e,t,n){return p()<=i.$b.DEBUG&&w("QueryEngine","Using full collection scan to execute query:",rO(t)),this.ps.getDocumentsMatchingQuery(e,t,eE.min(),n)}vs(e,t,n,r){return this.ps.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}const ad="LocalStore",af=3e8;class am{constructor(e,t,n,r){this.persistence=e,this.Fs=t,this.serializer=r,this.Ms=new t9(B),this.xs=new rU(e=>rp(e),ry),this.Os=new Map,this.Ns=e.getRemoteDocumentCache(),this.Pi=e.getTargetCache(),this.Ii=e.getBundleCache(),this.Bs(n)}Bs(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new oW(this.Ns,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ns.setIndexManager(this.indexManager),this.Fs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ms))}}function ag(e,t,n,r){return new am(e,t,n,r)}async function ap(e,t){const n=x(e);return await n.persistence.runTransaction("Handle user change","readonly",e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next(s=>(r=s,n.Bs(t),n.mutationQueue.getAllMutationBatches(e))).next(t=>{const s=[],i=[];let o=rY();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next(e=>({Ls:e,removedBatchIds:s,addedBatchIds:i}))})})}function ay(e,t){const n=x(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const r=t.batch.keys(),s=n.Ns.newChangeBuffer({trackRemovals:!0});return(function e(e,t,n,r){const s=n.batch,i=s.keys();let o=eC.resolve();return i.forEach(e=>{o=o.next(()=>r.getEntry(t,e)).next(t=>{const i=n.docVersions.get(e);E(null!==i,48541),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),o.next(()=>e.mutationQueue.removeMutationBatch(t,s))})(n,e,t,s).next(()=>s.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function e(e){let t=rY();for(let n=0;n<e.mutationResults.length;++n){e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key))}return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))})}function aw(e){const t=x(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Pi.getLastRemoteSnapshotVersion(e))}function av(e,t){const n=x(e),r=t.snapshotVersion;let s=n.Ms;return n.persistence.runTransaction("Apply remote event","readwrite-primary",e=>{const i=n.Ns.newChangeBuffer({trackRemovals:!0});s=n.Ms;const o=[];t.targetChanges.forEach((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.Pi.removeMatchingKeys(e,i.removedDocuments,a).next(()=>n.Pi.addMatchingKeys(e,i.addedDocuments,a)));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?u=u.withResumeToken(na.EMPTY_BYTE_STRING,ef.min()).withLastLimboFreeSnapshotVersion(ef.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function e(e,t,n){if(0===e.resumeToken.approximateByteSize())return!0;const r=t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds();if(r>=af)return!0;const s=n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size;return s>0}(c,u,i)&&o.push(n.Pi.updateTargetData(e,u))});let a=rz(),c=rY();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))}),o.push(aI(e,i,t.documentUpdates).next(e=>{a=e.ks,c=e.qs})),!r.isEqual(ef.min())){const t=n.Pi.getLastRemoteSnapshotVersion(e).next(t=>n.Pi.setTargetsMetadata(e,e.currentSequenceNumber,r));o.push(t)}return eC.waitFor(o).next(()=>i.apply(e)).next(()=>n.localDocuments.getLocalViewOfDocuments(e,a,c)).next(()=>a)}).then(e=>(n.Ms=s,e))}function aI(e,t,n){let r=rY(),s=rY();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=rz();return n.forEach((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(ef.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):w(ad,"Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)}),{ks:r,qs:s}})}function a_(e,t){const n=x(e);return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=eK),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}function ab(e,t){const n=x(e);return n.persistence.runTransaction("Allocate target","readwrite",e=>{let r;return n.Pi.getTargetData(e,t).next(s=>s?(r=s,eC.resolve(r)):n.Pi.allocateTargetId(e).next(s=>(r=new iS(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Pi.addTargetData(e,r).next(()=>r))))}).then(e=>{const r=n.Ms.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Ms=n.Ms.insert(e.targetId,e),n.xs.set(t,e.targetId)),e})}async function aT(e,t,n){const r=x(e),s=r.Ms.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!eF(e))throw e;w(ad,`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ms=r.Ms.remove(t),r.xs.delete(s.target)}function aE(e,t,n){const r=x(e);let s=ef.min(),i=rY();return r.persistence.runTransaction("Execute query","readwrite",e=>(function e(e,t,n){const r=x(e),s=r.xs.get(n);return void 0!==s?eC.resolve(r.Ms.get(s)):r.Pi.getTargetData(t,n)})(r,e,rD(t)).next(t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Pi.getMatchingKeysForTargetId(e,t.targetId).next(e=>{i=e})}).next(()=>r.Fs.getDocumentsMatchingQuery(e,t,n?s:ef.min(),n?i:rY())).next(e=>(aN(r,rP(t),e),{documents:e,Qs:i})))}function aS(e,t){const n=x(e),r=x(n.Pi),s=n.Ms.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.At(e,t).next(e=>e?e.target:null))}function ax(e,t){const n=x(e),r=n.Os.get(t)||ef.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Ns.getAllFromCollectionGroup(e,t,eb(r,em),Number.MAX_SAFE_INTEGER)).then(e=>(aN(n,t,e),e))}function aN(e,t,n){let r=e.Os.get(t)||ef.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Os.set(t,r)}async function aD(e,t,n,r){const s=x(e);let i=rY(),o=rz();for(const e of n){const n=t.$s(e.metadata.name);e.document&&(i=i.add(n));const r=t.Us(e);r.setReadTime(t.Ks(e.metadata.readTime)),o=o.insert(n,r)}const a=s.Ns.newChangeBuffer({trackRemovals:!0}),c=await ab(s,function e(e){return rD(rE(H.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",e=>aI(e,a,o).next(t=>(a.apply(e),t)).next(t=>s.Pi.removeMatchingKeysForTargetId(e,c.targetId).next(()=>s.Pi.addMatchingKeys(e,i,c.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(e,t.ks,t.qs)).next(()=>t.ks)))}async function aC(e,t,n=rY()){const r=await ab(e,rD(iO(t.bundledQuery))),s=x(e);return s.persistence.runTransaction("Save named query","readwrite",e=>{const i=s2(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ii.saveNamedQuery(e,t);const o=r.withResumeToken(na.EMPTY_BYTE_STRING,i);return s.Ms=s.Ms.insert(o.targetId,o),s.Pi.updateTargetData(e,o).next(()=>s.Pi.removeMatchingKeysForTargetId(e,r.targetId)).next(()=>s.Pi.addMatchingKeys(e,n,r.targetId)).next(()=>s.Ii.saveNamedQuery(e,t))})}const aA="firestore_clients";function ak(e,t){return`${aA}_${e}_${t}`}const aR="firestore_mutations";function aM(e,t,n){let r=`${aR}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}const aV="firestore_targets";function aO(e,t){return`${aV}_${e}_${t}`}const aF="SharedClientState";class aP{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ws(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new D(r.error.code,r.error.message))),i?new aP(e,t,r.state,s):(v(aF,`Failed to parse mutation state for ID '${t}': ${n}`),null)}Gs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class aL{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ws(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new D(n.error.code,n.error.message))),s?new aL(e,n.state,r):(v(aF,`Failed to parse target state for ID '${e}': ${t}`),null)}Gs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class aq{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ws(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=rZ();for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eW(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new aq(e,s):(v(aF,`Failed to parse client data for instance '${e}': ${t}`),null)}}class aU{constructor(e,t){this.clientId=e,this.onlineState=t}static Ws(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new aU(t.clientId,t.onlineState):(v(aF,`Failed to parse online state: ${e}`),null)}}class aB{constructor(){this.activeTargetIds=rZ()}zs(e){this.activeTargetIds=this.activeTargetIds.add(e)}js(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Gs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class az{constructor(e,t,n,r,s){this.window=e,this.Mi=t,this.persistenceKey=n,this.Js=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Hs=this.Ys.bind(this),this.Zs=new t9(B),this.started=!1,this.Xs=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.eo=ak(this.persistenceKey,this.Js),this.no=function e(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.Zs=this.Zs.insert(this.Js,new aB),this.ro=new RegExp(`^${aA}_${i}_([^_]*)$`),this.io=new RegExp(`^${aR}_${i}_(\\d+)(?:_(.*))?$`),this.so=new RegExp(`^${aV}_${i}_(\\d+)$`),this.oo=function e(e){return`firestore_online_state_${e}`}(this.persistenceKey),this._o=function e(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.Hs)}static v(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Ts();for(const t of e){if(t===this.Js)continue;const e=this.getItem(ak(this.persistenceKey,t));if(e){const n=aq.Ws(t,e);n&&(this.Zs=this.Zs.insert(n.clientId,n))}}this.ao();const t=this.storage.getItem(this.oo);if(t){const e=this.uo(t);e&&this.co(e)}for(const e of this.Xs)this.Ys(e);this.Xs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.no,JSON.stringify(e))}getAllActiveQueryTargets(){return this.lo(this.Zs)}isActiveQueryTarget(e){let t=!1;return this.Zs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.ho(e,"pending")}updateMutationState(e,t,n){this.ho(e,t,n),this.Po(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){const t=this.storage.getItem(aO(this.persistenceKey,e));if(t){const r=aL.Ws(e,t);r&&(n=r.state)}}return t&&this.To.zs(e),this.ao(),n}removeLocalQueryTarget(e){this.To.js(e),this.ao()}isLocalQueryTarget(e){return this.To.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(aO(this.persistenceKey,e))}updateQueryState(e,t,n){this.Io(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Po(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Eo(e)}notifyBundleLoaded(e){this.Ao(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Hs),this.removeItem(this.eo),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return w(aF,"READ",e,t),t}setItem(e,t){w(aF,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){w(aF,"REMOVE",e),this.storage.removeItem(e)}Ys(e){const t=e;if(t.storageArea===this.storage){if(w(aF,"EVENT",t.key,t.newValue),t.key===this.eo)return void v("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Mi.enqueueRetryable(async()=>{if(this.started){if(null!==t.key){if(this.ro.test(t.key)){if(null==t.newValue){const e=this.Ro(t.key);return this.Vo(e,null)}{const e=this.mo(t.key,t.newValue);if(e)return this.Vo(e.clientId,e)}}else if(this.io.test(t.key)){if(null!==t.newValue){const e=this.fo(t.key,t.newValue);if(e)return this.po(e)}}else if(this.so.test(t.key)){if(null!==t.newValue){const e=this.yo(t.key,t.newValue);if(e)return this.wo(e)}}else if(t.key===this.oo){if(null!==t.newValue){const e=this.uo(t.newValue);if(e)return this.co(e)}}else if(t.key===this.no){const e=function e(e){let t=eG.ce;if(null!=e)try{const n=JSON.parse(e);E("number"==typeof n,30636,{So:e}),t=n}catch(e){v(aF,"Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==eG.ce&&this.sequenceNumberHandler(e)}else if(t.key===this._o){const e=this.bo(t.newValue);await Promise.all(e.map(e=>this.syncEngine.Do(e)))}}}else this.Xs.push(t)})}}get To(){return this.Zs.get(this.Js)}ao(){this.setItem(this.eo,this.To.Gs())}ho(e,t,n){const r=new aP(this.currentUser,e,t,n),s=aM(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Gs())}Po(e){const t=aM(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Eo(e){const t={clientId:this.Js,onlineState:e};this.storage.setItem(this.oo,JSON.stringify(t))}Io(e,t,n){const r=aO(this.persistenceKey,e),s=new aL(e,t,n);this.setItem(r,s.Gs())}Ao(e){const t=JSON.stringify(Array.from(e));this.setItem(this._o,t)}Ro(e){const t=this.ro.exec(e);return t?t[1]:null}mo(e,t){const n=this.Ro(e);return aq.Ws(n,t)}fo(e,t){const n=this.io.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return aP.Ws(new f(s),r,t)}yo(e,t){const n=this.so.exec(e),r=Number(n[1]);return aL.Ws(r,t)}uo(e){return aU.Ws(e)}bo(e){return JSON.parse(e)}async po(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Co(e.batchId,e.state,e.error);w(aF,`Ignoring mutation for non-active user ${e.user.uid}`)}wo(e){return this.syncEngine.vo(e.targetId,e.state,e.error)}Vo(e,t){const n=t?this.Zs.insert(e,t):this.Zs.remove(e),r=this.lo(this.Zs),s=this.lo(n),i=[],o=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||o.push(e)}),this.syncEngine.Fo(i,o).then(()=>{this.Zs=n})}co(e){this.Zs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}lo(e){let t=rZ();return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class a${constructor(){this.Mo=new aB,this.xo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.Mo.zs(e),this.xo[e]||"not-current"}updateQueryState(e,t,n){this.xo[e]=t}removeLocalQueryTarget(e){this.Mo.js(e)}isLocalQueryTarget(e){return this.Mo.activeTargetIds.has(e)}clearQueryState(e){delete this.xo[e]}getAllActiveQueryTargets(){return this.Mo.activeTargetIds}isActiveQueryTarget(e){return this.Mo.activeTargetIds.has(e)}start(){return this.Mo=new aB,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class aG{Oo(e){}shutdown(){}}const aK="ConnectivityMonitor";class aj{constructor(){this.No=()=>this.Bo(),this.Lo=()=>this.ko(),this.qo=[],this.Qo()}Oo(e){this.qo.push(e)}shutdown(){window.removeEventListener("online",this.No),window.removeEventListener("offline",this.Lo)}Qo(){window.addEventListener("online",this.No),window.addEventListener("offline",this.Lo)}Bo(){w(aK,"Network connectivity changed: AVAILABLE");for(const e of this.qo)e(0)}ko(){w(aK,"Network connectivity changed: UNAVAILABLE");for(const e of this.qo)e(1)}static v(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let aQ=null;function aW(){return null===aQ?aQ=function e(){return 0x10000000+Math.round(0x80000000*Math.random())}():aQ++,"0x"+aQ.toString(16)}const aJ="RestConnection",aH={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class aY{get $o(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Uo=t+"://"+e.host,this.Ko=`projects/${n}/databases/${r}`,this.Wo=this.databaseId.database===nI?`project_id=${n}`:`project_id=${n}&database_id=${r}`}Go(e,t,n,r,s){const i=aW(),a=this.zo(e,t.toUriEncodedString());w(aJ,`Sending RPC '${e}' ${i}:`,a,n);const c={"google-cloud-resource-prefix":this.Ko,"x-goog-request-params":this.Wo};this.jo(c,r,s);const{host:u}=new URL(a),l=(0,o.zJ)(u);return this.Jo(e,a,c,n,l).then(t=>(w(aJ,`Received RPC '${e}' ${i}: `,t),t),t=>{throw I(aJ,`RPC '${e}' ${i} failed with error: `,t,"url: ",a,"request:",n),t})}Ho(e,t,n,r,s,i){return this.Go(e,t,n,r,s)}jo(e,t,n){e["X-Goog-Api-Client"]=function e(){return"gl-js/ fire/"+m}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}zo(e,t){const n=aH[e];return`${this.Uo}/v1/${t}:${n}`}terminate(){}}class aX{constructor(e){this.Yo=e.Yo,this.Zo=e.Zo}Xo(e){this.e_=e}t_(e){this.n_=e}r_(e){this.i_=e}onMessage(e){this.s_=e}close(){this.Zo()}send(e){this.Yo(e)}o_(){this.e_()}__(){this.n_()}a_(e){this.i_(e)}u_(e){this.s_(e)}}const aZ="WebChannelConnection";class a0 extends aY{constructor(e){super(e),this.c_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,n,r,s){const i=aW();return new Promise((s,o)=>{const a=new c.ZS;a.setWithCredentials(!0),a.listenOnce(c.Bx.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case c.O4.NO_ERROR:const t=a.getResponseJson();w(aZ,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case c.O4.TIMEOUT:w(aZ,`RPC '${e}' ${i} timed out`),o(new D(N.DEADLINE_EXCEEDED,"Request time out"));break;case c.O4.HTTP_ERROR:const n=a.getStatus();if(w(aZ,`RPC '${e}' ${i} failed with status:`,n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=e?.error;if(t&&t.status&&t.message){const e=function e(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(N).indexOf(t)>=0?t:N.UNKNOWN}(t.status);o(new D(e,t.message))}else o(new D(N.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new D(N.UNAVAILABLE,"Connection failed."));break;default:b(9055,{l_:e,streamId:i,h_:a.getLastErrorCode(),P_:a.getLastError()})}}finally{w(aZ,`RPC '${e}' ${i} completed.`)}});const u=JSON.stringify(r);w(aZ,`RPC '${e}' ${i} sending request:`,r),a.send(t,"POST",u,n,15)})}T_(e,t,n){const r=aW(),s=[this.Uo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=(0,c.fF)(),o=(0,c.Ao)(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(a.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(a.useFetchStreams=!0),this.jo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const l=s.join("");w(aZ,`Creating RPC '${e}' stream ${r}: ${l}`,a);const h=i.createWebChannel(l,a);this.I_(h);let d=!1,f=!1;const m=new aX({Yo:t=>{f?w(aZ,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(w(aZ,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),w(aZ,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},Zo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return g(h,c.iO.EventType.OPEN,()=>{f||(w(aZ,`RPC '${e}' stream ${r} transport opened.`),m.o_())}),g(h,c.iO.EventType.CLOSE,()=>{f||(f=!0,w(aZ,`RPC '${e}' stream ${r} transport closed`),m.a_(),this.E_(h))}),g(h,c.iO.EventType.ERROR,t=>{f||(f=!0,I(aZ,`RPC '${e}' stream ${r} transport errored. Name:`,t.name,"Message:",t.message),m.a_(new D(N.UNAVAILABLE,"The operation could not be completed")))}),g(h,c.iO.EventType.MESSAGE,t=>{if(!f){const n=t.data[0];E(!!n,16349);const s=n,i=s?.error||s[0]?.error;if(i){w(aZ,`RPC '${e}' stream ${r} received error:`,i);const t=i.status;let n=function e(e){const t=sD[e];if(void 0!==t)return sk(t)}(t),s=i.message;void 0===n&&(n=N.INTERNAL,s="Unknown error status: "+t+" with message "+i.message),f=!0,m.a_(new D(n,s)),h.close()}else w(aZ,`RPC '${e}' stream ${r} received:`,n),m.u_(n)}}),g(o,c.Jh.STAT_EVENT,t=>{t.stat===c.ro.PROXY?w(aZ,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===c.ro.NOPROXY&&w(aZ,`RPC '${e}' stream ${r} detected no buffering proxy`)}),setTimeout(()=>{m.__()},0),m}terminate(){this.c_.forEach(e=>e.close()),this.c_=[]}I_(e){this.c_.push(e)}E_(e){this.c_=this.c_.filter(t=>t===e)}}function a1(){return"undefined"!=typeof window?window:null}function a2(){return"undefined"!=typeof document?document:null}function a4(e){return new sY(e,!0)}class a3{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Mi=e,this.timerId=t,this.d_=n,this.A_=r,this.R_=s,this.V_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.V_=0}g_(){this.V_=this.R_}p_(e){this.cancel();const t=Math.floor(this.V_+this.y_()),n=Math.max(0,Date.now()-this.f_),r=Math.max(0,t-n);r>0&&w("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.V_} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.m_=this.Mi.enqueueAfterDelay(this.timerId,r,()=>(this.f_=Date.now(),e())),this.V_*=this.A_,this.V_<this.d_&&(this.V_=this.d_),this.V_>this.R_&&(this.V_=this.R_)}w_(){null!==this.m_&&(this.m_.skipDelay(),this.m_=null)}cancel(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.V_}}const a6="PersistentStream";class a5{constructor(e,t,n,r,s,i,o,a){this.Mi=e,this.S_=n,this.b_=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new a3(e,t)}x_(){return 1===this.state||5===this.state||this.O_()}O_(){return 2===this.state||3===this.state}start(){this.F_=0,4!==this.state?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&null===this.C_&&(this.C_=this.Mi.enqueueAfterDelay(this.S_,6e4,()=>this.k_()))}q_(e){this.Q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}Q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.Q_(),this.U_(),this.M_.cancel(),this.D_++,4!==e?this.M_.reset():t&&t.code===N.RESOURCE_EXHAUSTED?(v(t.toString()),v("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===N.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.K_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.r_(t)}K_(){}auth(){this.state=1;const e=this.W_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.D_===t&&this.G_(e,n)},t=>{e(()=>{const e=new D(N.UNKNOWN,"Fetching auth token failed: "+t.message);return this.z_(e)})})}G_(e,t){const n=this.W_(this.D_);this.stream=this.j_(e,t),this.stream.Xo(()=>{n(()=>this.listener.Xo())}),this.stream.t_(()=>{n(()=>(this.state=2,this.v_=this.Mi.enqueueAfterDelay(this.b_,1e4,()=>(this.O_()&&(this.state=3),Promise.resolve())),this.listener.t_()))}),this.stream.r_(e=>{n(()=>this.z_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.F_?this.J_(e):this.onNext(e))})}N_(){this.state=5,this.M_.p_(async()=>{this.state=0,this.start()})}z_(e){return w(a6,`close with error: ${e}`),this.stream=null,this.close(4,e)}W_(e){return t=>{this.Mi.enqueueAndForget(()=>this.D_===e?t():(w(a6,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class a8 extends a5{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}j_(e,t){return this.connection.T_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.M_.reset();const t=io(this.serializer,e),n=function e(e){if(!("targetChange"in e))return ef.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?ef.min():t.readTime?s2(t.readTime):ef.min()}(e);return this.listener.H_(t,n)}Y_(e){const t={};t.database=ie(this.serializer),t.addTarget=function e(e,t){let n;const r=t.target;if(n=rw(r)?{documents:il(e,r)}:{query:ih(e,r).ft},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=s0(e,t.resumeToken);const r=sX(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(ef.min())>0){n.readTime=sZ(e,t.snapshotVersion.toTimestamp());const r=sX(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=ig(this.serializer,e);n&&(t.labels=n),this.q_(t)}Z_(e){const t={};t.database=ie(this.serializer),t.removeTarget=e,this.q_(t)}}class a9 extends a5{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}get X_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}K_(){this.X_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}J_(e){return E(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,E(!e.writeResults||0===e.writeResults.length,55816),this.listener.ta()}onNext(e){E(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();const t=iu(e.writeResults,e.commitTime),n=s2(e.commitTime);return this.listener.na(n,t)}ra(){const e={};e.database=ie(this.serializer),this.q_(e)}ea(e){const t={streamToken:this.lastStreamToken,writes:e.map(e=>ia(this.serializer,e))};this.q_(t)}}class a7{}class ce extends a7{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.ia=!1}sa(){if(this.ia)throw new D(N.FAILED_PRECONDITION,"The client has already been terminated.")}Go(e,t,n,r){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,i])=>this.connection.Go(e,s3(t,n),r,s,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===N.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new D(N.UNKNOWN,e.toString())})}Ho(e,t,n,r,s){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,o])=>this.connection.Ho(e,s3(t,n),r,i,o,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===N.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new D(N.UNKNOWN,e.toString())})}terminate(){this.ia=!0,this.connection.terminate()}}class ct{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){0===this.oa&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve())))}ha(e){"Online"===this.state?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,"Online"===e&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){const t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(v(t),this.aa=!1):w("OnlineStateTracker",t)}Pa(){null!==this._a&&(this._a.cancel(),this._a=null)}}const cn="RemoteStore";class cr{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.da=[],this.Aa=s,this.Aa.Oo(e=>{n.enqueueAndForget(async()=>{cd(this)&&(w(cn,"Restarting streams for network reachability change."),await async function e(e){const t=x(e);t.Ea.add(4),await ci(t),t.Ra.set("Unknown"),t.Ea.delete(4),await cs(t)}(this))})}),this.Ra=new ct(n,r)}}async function cs(e){if(cd(e))for(const t of e.da)await t(!0)}async function ci(e){for(const t of e.da)await t(!1)}function co(e,t){const n=x(e);n.Ia.has(t.targetId)||(n.Ia.set(t.targetId,t),ch(n)?cl(n):ck(n).O_()&&cc(n,t))}function ca(e,t){const n=x(e),r=ck(n);n.Ia.delete(t),r.O_()&&cu(n,t),0===n.Ia.size&&(r.O_()?r.L_():cd(n)&&n.Ra.set("Unknown"))}function cc(e,t){if(e.Va.Ue(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(ef.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}ck(e).Y_(t)}function cu(e,t){e.Va.Ue(t),ck(e).Z_(t)}function cl(e){e.Va=new sK({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),At:t=>e.Ia.get(t)||null,ht:()=>e.datastore.serializer.databaseId}),ck(e).start(),e.Ra.ua()}function ch(e){return cd(e)&&!ck(e).x_()&&e.Ia.size>0}function cd(e){return 0===x(e).Ea.size}function cf(e){e.Va=void 0}async function cm(e){e.Ra.set("Online")}async function cg(e){e.Ia.forEach((t,n)=>{cc(e,t)})}async function cp(e,t){cf(e),ch(e)?(e.Ra.ha(t),cl(e)):e.Ra.set("Unknown")}async function cy(e,t,n){if(e.Ra.set("Online"),t instanceof s$&&2===t.state&&t.cause)try{await async function e(e,t){const n=t.cause;for(const r of t.targetIds)e.Ia.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Ia.delete(r),e.Va.removeTarget(r))}(e,t)}catch(n){w(cn,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await cw(e,n)}else if(t instanceof sB?e.Va.Ze(t):t instanceof sz?e.Va.st(t):e.Va.tt(t),!n.isEqual(ef.min()))try{const t=await aw(e.localStore);n.compareTo(t)>=0&&await function e(e,t){const n=e.Va.Tt(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.Ia.get(r);s&&e.Ia.set(r,s.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{const r=e.Ia.get(t);if(!r)return;e.Ia.set(t,r.withResumeToken(na.EMPTY_BYTE_STRING,r.snapshotVersion)),cu(e,t);const s=new iS(r.target,t,n,r.sequenceNumber);cc(e,s)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){w(cn,"Failed to raise snapshot:",t),await cw(e,t)}}async function cw(e,t,n){if(!eF(t))throw t;e.Ea.add(1),await ci(e),e.Ra.set("Offline"),n||(n=()=>aw(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{w(cn,"Retrying IndexedDB access"),await n(),e.Ea.delete(1),await cs(e)})}function cv(e,t){return t().catch(n=>cw(e,n,t))}async function cI(e){const t=x(e),n=cR(t);let r=t.Ta.length>0?t.Ta[t.Ta.length-1].batchId:eK;for(;c_(t);)try{const e=await a_(t.localStore,r);if(null===e){0===t.Ta.length&&n.L_();break}r=e.batchId,cb(t,e)}catch(e){await cw(t,e)}cT(t)&&cE(t)}function c_(e){return cd(e)&&e.Ta.length<10}function cb(e,t){e.Ta.push(t);const n=cR(e);n.O_()&&n.X_&&n.ea(t.mutations)}function cT(e){return cd(e)&&!cR(e).x_()&&e.Ta.length>0}function cE(e){cR(e).start()}async function cS(e){cR(e).ra()}async function cx(e){const t=cR(e);for(const n of e.Ta)t.ea(n.mutations)}async function cN(e,t,n){const r=e.Ta.shift(),s=sE.from(r,t,n);await cv(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await cI(e)}async function cD(e,t){t&&cR(e).X_&&await async function e(e,t){if(function e(e){return sA(e)&&e!==N.ABORTED}(t.code)){const n=e.Ta.shift();cR(e).B_(),await cv(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await cI(e)}}(e,t),cT(e)&&cE(e)}async function cC(e,t){const n=x(e);n.asyncQueue.verifyOperationInProgress(),w(cn,"RemoteStore received new credentials");const r=cd(n);n.Ea.add(3),await ci(n),r&&n.Ra.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.Ea.delete(3),await cs(n)}async function cA(e,t){const n=x(e);t?(n.Ea.delete(2),await cs(n)):t||(n.Ea.add(2),await ci(n),n.Ra.set("Unknown"))}function ck(e){return e.ma||(e.ma=function e(e,t,n){const r=x(e);return r.sa(),new a8(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Xo:cm.bind(null,e),t_:cg.bind(null,e),r_:cp.bind(null,e),H_:cy.bind(null,e)}),e.da.push(async t=>{t?(e.ma.B_(),ch(e)?cl(e):e.Ra.set("Unknown")):(await e.ma.stop(),cf(e))})),e.ma}function cR(e){return e.fa||(e.fa=function e(e,t,n){const r=x(e);return r.sa(),new a9(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Xo:()=>Promise.resolve(),t_:cS.bind(null,e),r_:cD.bind(null,e),ta:cx.bind(null,e),na:cN.bind(null,e)}),e.da.push(async t=>{t?(e.fa.B_(),await cI(e)):(await e.fa.stop(),e.Ta.length>0&&(w(cn,`Stopping write stream with ${e.Ta.length} pending writes`),e.Ta=[]))})),e.fa}class cM{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new C,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new cM(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new D(N.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function cV(e,t){if(v("AsyncQueue",`${t}: ${e}`),eF(e))return new D(N.UNAVAILABLE,`${t}: ${e}`);throw e}class cO{static emptySet(e){return new cO(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||Z.comparator(t.key,n.key):(e,t)=>Z.comparator(e.key,t.key),this.keyedMap=rG(),this.sortedSet=new t9(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof cO))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new cO;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class cF{constructor(){this.ga=new t9(Z.comparator)}track(e){const t=e.doc.key,n=this.ga.get(t);n?0!==e.type&&3===n.type?this.ga=this.ga.insert(t,e):3===e.type&&1!==n.type?this.ga=this.ga.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.ga=this.ga.remove(t):1===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):b(63341,{Rt:e,pa:n}):this.ga=this.ga.insert(t,e)}ya(){const e=[];return this.ga.inorderTraversal((t,n)=>{e.push(n)}),e}}class cP{constructor(e,t,n,r,s,i,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new cP(e,t,cO.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&rM(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class cL{constructor(){this.wa=void 0,this.Sa=[]}ba(){return this.Sa.some(e=>e.Da())}}class cq{constructor(){this.queries=cU(),this.onlineState="Unknown",this.Ca=new Set}terminate(){!function e(e,t){const n=x(e),r=n.queries;n.queries=cU(),r.forEach((e,n)=>{for(const e of n.Sa)e.onError(t)})}(this,new D(N.ABORTED,"Firestore shutting down"))}}function cU(){return new rU(e=>rV(e),rM)}async function cB(e,t){const n=x(e);let r=3;const s=t.query;let i=n.queries.get(s);i?!i.ba()&&t.Da()&&(r=2):(i=new cL,r=t.Da()?0:1);try{switch(r){case 0:i.wa=await n.onListen(s,!0);break;case 1:i.wa=await n.onListen(s,!1);break;case 2:await n.onFirstRemoteStoreListen(s)}}catch(n){const e=cV(n,`Initialization of query '${rO(t.query)}' failed`);return void t.onError(e)}if(n.queries.set(s,i),i.Sa.push(t),t.va(n.onlineState),i.wa){t.Fa(i.wa)&&cK(n)}}async function cz(e,t){const n=x(e),r=t.query;let s=3;const i=n.queries.get(r);if(i){const e=i.Sa.indexOf(t);e>=0&&(i.Sa.splice(e,1),0===i.Sa.length?s=t.Da()?0:1:!i.ba()&&t.Da()&&(s=2))}switch(s){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function c$(e,t){const n=x(e);let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.Sa)t.Fa(e)&&(r=!0);s.wa=e}}r&&cK(n)}function cG(e,t,n){const r=x(e),s=r.queries.get(t);if(s)for(const e of s.Sa)e.onError(n);r.queries.delete(t)}function cK(e){e.Ca.forEach(e=>{e.next()})}var cj,cQ;(cQ=cj||(cj={})).Ma="default",cQ.Cache="cache";class cW{constructor(e,t,n){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=n||{}}Fa(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new cP(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){if(!e.fromCache)return!0;if(!this.Da())return!0;const n="Offline"!==t;return(!this.options.qa||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Ba(e){if(e.docChanges.length>0)return!0;const t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}ka(e){e=cP.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==cj.Cache}}class cJ{constructor(e,t){this.Qa=e,this.byteLength=t}$a(){return"metadata"in this.Qa}}class cH{constructor(e){this.serializer=e}$s(e){return s8(this.serializer,e)}Us(e){return e.metadata.exists?is(this.serializer,e.document,!1):nZ.newNoDocument(this.$s(e.metadata.name),this.Ks(e.metadata.readTime))}Ks(e){return s2(e)}}class cY{constructor(e,t){this.Ua=e,this.serializer=t,this.Ka=[],this.Wa=[],this.collectionGroups=new Set,this.progress=cX(e)}get queries(){return this.Ka}get documents(){return this.Wa}Ga(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Qa.namedQuery)this.Ka.push(e.Qa.namedQuery);else if(e.Qa.documentMetadata){this.Wa.push({metadata:e.Qa.documentMetadata}),e.Qa.documentMetadata.exists||++t;const n=H.fromString(e.Qa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Qa.document&&(this.Wa[this.Wa.length-1].document=e.Qa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,{...this.progress}):null}za(e){const t=new Map,n=new cH(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.$s(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||rY()).add(e);t.set(n,r)}}return t}async ja(e){const t=await aD(e,new cH(this.serializer),this.Wa,this.Ua.id),n=this.za(this.documents);for(const t of this.Ka)await aC(e,t,n.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Ja:this.collectionGroups,Ha:t}}}function cX(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class cZ{constructor(e){this.key=e}}class c0{constructor(e){this.key=e}}class c1{constructor(e,t){this.query=e,this.Ya=t,this.Za=null,this.hasCachedResults=!1,this.current=!1,this.Xa=rY(),this.mutatedKeys=rY(),this.eu=rL(e),this.tu=new cO(this.eu)}get nu(){return this.Ya}ru(e,t){const n=t?t.iu:new cF,r=t?t.tu:this.tu;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{const u=r.get(e),l=rF(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;if(u&&l){u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.su(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.eu(l,a)>0||c&&this.eu(l,c)<0)&&(o=!0))}else!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0));f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))}),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{tu:i,iu:n,Cs:o,mutatedKeys:s}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const s=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;const i=e.iu.ya();i.sort((e,t)=>(function e(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return b(20277,{Rt:e})}};return n(e)-n(t)})(e.type,t.type)||this.eu(e.doc,t.doc)),this.ou(n),r=r??!1;const o=t&&!r?this._u():[],a=0===this.Xa.size&&this.current&&!r?1:0,c=a!==this.Za;if(this.Za=a,0!==i.length||c){return{snapshot:new cP(this.query,e.tu,s,i,e.mutatedKeys,0===a,c,!1,!!n&&n.resumeToken.approximateByteSize()>0),au:o}}return{au:o}}va(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({tu:this.tu,iu:new cF,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{au:[]}}uu(e){return!this.Ya.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach(e=>this.Ya=this.Ya.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ya=this.Ya.delete(e)),this.current=e.current)}_u(){if(!this.current)return[];const e=this.Xa;this.Xa=rY(),this.tu.forEach(e=>{this.uu(e.key)&&(this.Xa=this.Xa.add(e.key))});const t=[];return e.forEach(e=>{this.Xa.has(e)||t.push(new c0(e))}),this.Xa.forEach(n=>{e.has(n)||t.push(new cZ(n))}),t}cu(e){this.Ya=e.Qs,this.Xa=rY();const t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return cP.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,0===this.Za,this.hasCachedResults)}}const c2="SyncEngine";class c4{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class c3{constructor(e){this.key=e,this.hu=!1}}class c6{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Pu={},this.Tu=new rU(e=>rV(e),rM),this.Iu=new Map,this.Eu=new Set,this.du=new t9(Z.comparator),this.Au=new Map,this.Ru=new oX,this.Vu={},this.mu=new Map,this.fu=oE.cr(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return!0===this.gu}}async function c5(e,t,n=!0){const r=uD(e);let s;const i=r.Tu.get(t);return i?(r.sharedClientState.addLocalQueryTarget(i.targetId),s=i.view.lu()):s=await c9(r,t,n,!0),s}async function c8(e,t){const n=uD(e);await c9(n,t,!0,!1)}async function c9(e,t,n,r){const s=await ab(e.localStore,rD(t)),i=s.targetId,o=e.sharedClientState.addLocalQueryTarget(i,n);let a;return r&&(a=await c7(e,t,i,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&co(e.remoteStore,s),a}async function c7(e,t,n,r,s){e.pu=(t,n,r)=>(async function e(e,t,n,r){let s=t.view.ru(n);s.Cs&&(s=await aE(e.localStore,t.query,!1).then(({documents:e})=>t.view.ru(e,s)));const i=r&&r.targetChanges.get(t.targetId),o=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(s,e.isPrimaryClient,i,o);return uf(e,t.targetId,a.au),a.snapshot})(e,t,n,r);const i=await aE(e.localStore,t,!0),o=new c1(t,i.Qs),a=o.ru(i.documents),c=sU.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),u=o.applyChanges(a,e.isPrimaryClient,c);uf(e,n,u.au);const l=new c4(t,n,o);return e.Tu.set(t,l),e.Iu.has(n)?e.Iu.get(n).push(t):e.Iu.set(n,[t]),u.snapshot}async function ue(e,t,n){const r=x(e),s=r.Tu.get(t),i=r.Iu.get(s.targetId);if(i.length>1)return r.Iu.set(s.targetId,i.filter(e=>!rM(e,t))),void r.Tu.delete(t);if(r.isPrimaryClient){r.sharedClientState.removeLocalQueryTarget(s.targetId);r.sharedClientState.isActiveQueryTarget(s.targetId)||await aT(r.localStore,s.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(s.targetId),n&&ca(r.remoteStore,s.targetId),uh(r,s.targetId)}).catch(eD)}else uh(r,s.targetId),await aT(r.localStore,s.targetId,!0)}async function ut(e,t){const n=x(e),r=n.Tu.get(t),s=n.Iu.get(r.targetId);n.isPrimaryClient&&1===s.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),ca(n.remoteStore,r.targetId))}async function un(e,t,n){const r=uC(e);try{const e=await function e(e,t){const n=x(e),r=ed.now(),s=t.reduce((e,t)=>e.add(t.key),rY());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",e=>{let a=rz(),c=rY();return n.Ns.getEntries(e,s).next(e=>{a=e,a.forEach((e,t)=>{t.isValidDocument()||(c=c.add(e))})}).next(()=>n.localDocuments.getOverlayedDocuments(e,a)).next(s=>{i=s;const o=[];for(const e of t){const t=sm(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new sy(e.key,t,nX(t.value.mapValue),sc.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)}).next(t=>{o=t;const r=t.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)})}).then(()=>({batchId:o.batchId,changes:rK(i)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function e(e,t,n){let r=e.Vu[e.currentUser.toKey()];r||(r=new t9(B));r=r.insert(t,n),e.Vu[e.currentUser.toKey()]=r}(r,e.batchId,n),await up(r,e.changes),await cI(r.remoteStore)}catch(t){const e=cV(t,"Failed to persist write");n.reject(e)}}async function ur(e,t){const n=x(e);try{const e=await av(n.localStore,t);t.targetChanges.forEach((e,t)=>{const r=n.Au.get(t);r&&(E(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,22616),e.addedDocuments.size>0?r.hu=!0:e.modifiedDocuments.size>0?E(r.hu,14607):e.removedDocuments.size>0&&(E(r.hu,42227),r.hu=!1))}),await up(n,e,t)}catch(e){await eD(e)}}function us(e,t,n){const r=x(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.Tu.forEach((n,r)=>{const s=r.view.va(t);s.snapshot&&e.push(s.snapshot)}),function e(e,t){const n=x(e);n.onlineState=t;let r=!1;n.queries.forEach((e,n)=>{for(const e of n.Sa)e.va(t)&&(r=!0)}),r&&cK(n)}(r.eventManager,t),e.length&&r.Pu.H_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function ui(e,t,n){const r=x(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Au.get(t),i=s&&s.key;if(i){let e=new t9(Z.comparator);e=e.insert(i,nZ.newNoDocument(i,ef.min()));const n=rY().add(i),s=new sq(ef.min(),new Map,new t9(B),e,n);await ur(r,s),r.du=r.du.remove(i),r.Au.delete(t),ug(r)}else await aT(r.localStore,t,!1).then(()=>uh(r,t,n)).catch(eD)}async function uo(e,t){const n=x(e),r=t.batch.batchId;try{const e=await ay(n.localStore,t);ul(n,r,null),uu(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await up(n,e)}catch(e){await eD(e)}}async function ua(e,t,n){const r=x(e);try{const e=await function e(e,t){const n=x(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next(t=>(E(null!==t,37113),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t))).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)).next(()=>n.localDocuments.getDocuments(e,r))})}(r.localStore,t);ul(r,t,n),uu(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await up(r,e)}catch(e){await eD(e)}}async function uc(e,t){const n=x(e);cd(n.remoteStore)||w(c2,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function e(e){const t=x(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}(n.localStore);if(e===eK)return void t.resolve();const r=n.mu.get(e)||[];r.push(t),n.mu.set(e,r)}catch(n){const e=cV(n,"Initialization of waitForPendingWrites() operation failed");t.reject(e)}}function uu(e,t){(e.mu.get(t)||[]).forEach(e=>{e.resolve()}),e.mu.delete(t)}function ul(e,t,n){const r=x(e);let s=r.Vu[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Vu[r.currentUser.toKey()]=s}}function uh(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Iu.get(t))e.Tu.delete(r),n&&e.Pu.yu(r,n);if(e.Iu.delete(t),e.isPrimaryClient){e.Ru.jr(t).forEach(t=>{e.Ru.containsKey(t)||ud(e,t)})}}function ud(e,t){e.Eu.delete(t.path.canonicalString());const n=e.du.get(t);null!==n&&(ca(e.remoteStore,n),e.du=e.du.remove(t),e.Au.delete(n),ug(e))}function uf(e,t,n){for(const r of n)if(r instanceof cZ)e.Ru.addReference(r.key,t),um(e,r);else if(r instanceof c0){w(c2,"Document no longer in limbo: "+r.key),e.Ru.removeReference(r.key,t);e.Ru.containsKey(r.key)||ud(e,r.key)}else b(19791,{wu:r})}function um(e,t){const n=t.key,r=n.path.canonicalString();e.du.get(n)||e.Eu.has(r)||(w(c2,"New document in limbo: "+n),e.Eu.add(r),ug(e))}function ug(e){for(;e.Eu.size>0&&e.du.size<e.maxConcurrentLimboResolutions;){const t=e.Eu.values().next().value;e.Eu.delete(t);const n=new Z(H.fromString(t)),r=e.fu.next();e.Au.set(r,new c3(n)),e.du=e.du.insert(n,r),co(e.remoteStore,new iS(rD(rE(n.path)),r,"TargetPurposeLimboResolution",eG.ce))}}async function up(e,t,n){const r=x(e),s=[],i=[],o=[];r.Tu.isEmpty()||(r.Tu.forEach((e,a)=>{o.push(r.pu(a,t,n).then(e=>{if((e||n)&&r.isPrimaryClient){const t=e?!e.fromCache:n?.targetChanges.get(a.targetId)?.current;r.sharedClientState.updateQueryState(a.targetId,t?"current":"not-current")}if(e){s.push(e);const t=au.As(a.targetId,e);i.push(t)}}))}),await Promise.all(o),r.Pu.H_(s),await async function e(e,t){const n=x(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",e=>eC.forEach(t,t=>eC.forEach(t.Es,r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r)).next(()=>eC.forEach(t.ds,r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))}catch(e){if(!eF(e))throw e;w(ad,"Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.Ms.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.Ms=n.Ms.insert(t,s)}}}(r.localStore,i))}async function uy(e,t){const n=x(e);if(!n.currentUser.isEqual(t)){w(c2,"User change. New user:",t.toKey());const e=await ap(n.localStore,t);n.currentUser=t,function e(e,t){e.mu.forEach(e=>{e.forEach(e=>{e.reject(new D(N.CANCELLED,t))})}),e.mu.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await up(n,e.Ls)}}function uw(e,t){const n=x(e),r=n.Au.get(t);if(r&&r.hu)return rY().add(r.key);{let e=rY();const r=n.Iu.get(t);if(!r)return e;for(const t of r){const r=n.Tu.get(t);e=e.unionWith(r.view.nu)}return e}}async function uv(e,t){const n=x(e),r=await aE(n.localStore,t.query,!0),s=t.view.cu(r);return n.isPrimaryClient&&uf(n,t.targetId,s.au),s}async function uI(e,t){const n=x(e);return ax(n.localStore,t).then(e=>up(n,e))}async function u_(e,t,n,r){const s=x(e),i=await function e(e,t){const n=x(e),r=x(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",e=>r.er(e,t).next(t=>t?n.localDocuments.getDocuments(e,t):eC.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await cI(s.remoteStore):"acknowledged"===n||"rejected"===n?(ul(s,t,r||null),uu(s,t),function e(e,t){x(x(e).mutationQueue).ir(t)}(s.localStore,t)):b(6720,"Unknown batchState",{Su:n}),await up(s,i)):w(c2,"Cannot apply mutation batch with id: "+t)}async function ub(e,t){const n=x(e);if(uD(n),uC(n),!0===t&&!0!==n.gu){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await uT(n,e.toArray());n.gu=!0,await cA(n.remoteStore,!0);for(const e of t)co(n.remoteStore,e)}else if(!1===t&&!1!==n.gu){const e=[];let t=Promise.resolve();n.Iu.forEach((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then(()=>(uh(n,s),aT(n.localStore,s,!0))),ca(n.remoteStore,s)}),await t,await uT(n,e),function e(e){const t=x(e);t.Au.forEach((e,n)=>{ca(t.remoteStore,n)}),t.Ru.Jr(),t.Au=new Map,t.du=new t9(Z.comparator)}(n),n.gu=!1,await cA(n.remoteStore,!1)}}async function uT(e,t,n){const r=x(e),s=[],i=[];for(const e of t){let t;const n=r.Iu.get(e);if(n&&0!==n.length){t=await ab(r.localStore,rD(n[0]));for(const e of n){const t=r.Tu.get(e),n=await uv(r,t);n.snapshot&&i.push(n.snapshot)}}else{const n=await aS(r.localStore,e);t=await ab(r.localStore,n),await c7(r,uE(n),e,!1,t.resumeToken)}s.push(t)}return r.Pu.H_(i),s}function uE(e){return rT(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function uS(e){return function e(e){return x(x(e).persistence).Ts()}(x(e).localStore)}async function ux(e,t,n,r){const s=x(e);if(s.gu)return void w(c2,"Ignoring unexpected query state notification.");const i=s.Iu.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await ax(s.localStore,rP(i[0])),r=sq.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,na.EMPTY_BYTE_STRING);await up(s,e,r);break}case"rejected":await aT(s.localStore,t,!0),uh(s,t,r);break;default:b(64155,n)}}async function uN(e,t,n){const r=uD(e);if(r.gu){for(const e of t){if(r.Iu.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){w(c2,"Adding an already active target "+e);continue}const t=await aS(r.localStore,e),n=await ab(r.localStore,t);await c7(r,uE(t),n.targetId,!1,n.resumeToken),co(r.remoteStore,n)}for(const e of n)r.Iu.has(e)&&await aT(r.localStore,e,!1).then(()=>{ca(r.remoteStore,e),uh(r,e)}).catch(eD)}}function uD(e){const t=x(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=ur.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=uw.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=ui.bind(null,t),t.Pu.H_=c$.bind(null,t.eventManager),t.Pu.yu=cG.bind(null,t.eventManager),t}function uC(e){const t=x(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=uo.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=ua.bind(null,t),t}function uA(e,t,n){const r=x(e);(async function e(e,t,n){try{const r=await t.getMetadata();if(await function e(e,t){const n=x(e),r=s2(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ii.getBundleMetadata(e,t.id)).then(e=>!!e&&e.createTime.compareTo(r)>=0)}(e.localStore,r))return await t.close(),n._completeWith(function e(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(cX(r));const s=new cY(r,t.serializer);let i=await t.bu();for(;i;){const e=await s.Ga(i);e&&n._updateProgress(e),i=await t.bu()}const o=await s.ja(e.localStore);return await up(e,o.Ha,void 0),await function e(e,t){const n=x(e);return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ii.saveBundleMetadata(e,t))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Ja)}catch(e){return I(c2,`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}class uk{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=a4(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){return ag(this.persistence,new ah,e.initialUser,this.serializer)}Cu(e){return new o3(o5.mi,this.serializer)}Du(e){return new a$}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}uk.provider={build:()=>new uk};class uR extends uk{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){E(this.persistence.referenceDelegate instanceof o8,46915);const n=this.persistence.referenceDelegate.garbageCollector;return new oM(n,e.asyncQueue,t)}Cu(e){const t=void 0!==this.cacheSizeBytes?op.withCacheSize(this.cacheSizeBytes):op.DEFAULT;return new o3(e=>o8.mi(e,t),this.serializer)}}class uM extends uk{constructor(e,t,n){super(),this.xu=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xu.initialize(this,e),await uC(this.xu.syncEngine),await cI(this.xu.remoteStore),await this.persistence.Ji(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}vu(e){return ag(this.persistence,new ah,e.initialUser,this.serializer)}Fu(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new oM(n,e.asyncQueue,t)}Mu(e,t){const n=new e$(t,this.persistence);return new ez(e.asyncQueue,n)}Cu(e){const t=ac(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?op.withCacheSize(this.cacheSizeBytes):op.DEFAULT;return new ai(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,a1(),a2(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Du(e){return new a$}}class uV extends uM{constructor(e,t){super(e,t,!1),this.xu=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.xu.syncEngine;this.sharedClientState instanceof az&&(this.sharedClientState.syncEngine={Co:u_.bind(null,t),vo:ux.bind(null,t),Fo:uN.bind(null,t),Ts:uS.bind(null,t),Do:uI.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ji(async e=>{await ub(this.xu.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Du(e){const t=a1();if(!az.v(t))throw new D(N.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=ac(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new az(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class uO{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>us(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=uy.bind(null,this.syncEngine),await cA(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return function e(){return new cq}()}createDatastore(e){const t=a4(e.databaseInfo.databaseId),n=function e(e){return new a0(e)}(e.databaseInfo);return function e(e,t,n,r){return new ce(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function e(e,t,n,r,s){return new cr(e,t,n,r,s)}(this.localStore,this.datastore,e.asyncQueue,e=>us(this.syncEngine,e,0),function e(){return aj.v()?new aj:new aG}())}createSyncEngine(e,t){return function e(e,t,n,r,s,i,o){const a=new c6(e,t,n,r,s,i);return o&&(a.gu=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){await async function e(e){const t=x(e);w(cn,"RemoteStore shutting down."),t.Ea.add(5),await ci(t),t.Aa.shutdown(),t.Ra.set("Unknown")}(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}}uO.provider={build:()=>new uO};function uF(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class uP{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):v("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class uL{constructor(e,t){this.Bu=e,this.serializer=t,this.metadata=new C,this.buffer=new Uint8Array,this.Lu=function e(){return new TextDecoder("utf-8")}(),this.ku().then(e=>{e&&e.$a()?this.metadata.resolve(e.Qa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(e?.Qa)}`))},e=>this.metadata.reject(e))}close(){return this.Bu.cancel()}async getMetadata(){return this.metadata.promise}async bu(){return await this.getMetadata(),this.ku()}async ku(){const e=await this.qu();if(null===e)return null;const t=this.Lu.decode(e),n=Number(t);isNaN(n)&&this.Qu(`length string (${t}) is not valid number`);const r=await this.$u(n);return new cJ(JSON.parse(r),e.length+n)}Uu(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async qu(){for(;this.Uu()<0;){if(await this.Ku())break}if(0===this.buffer.length)return null;const e=this.Uu();e<0&&this.Qu("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async $u(e){for(;this.buffer.length<e;){await this.Ku()&&this.Qu("Reached the end of bundle when more is expected.")}const t=this.Lu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Qu(e){throw this.Bu.cancel(),new Error(`Invalid bundle format: ${e}`)}async Ku(){const e=await this.Bu.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class uq{constructor(e,t){this.bundleData=e,this.serializer=t,this.cursor=0,this.elements=[];let n=this.bu();if(!n||!n.$a())throw new Error(`The first element of the bundle is not a metadata object, it is
         ${JSON.stringify(n?.Qa)}`);this.metadata=n;do{n=this.bu(),null!==n&&this.elements.push(n)}while(null!==n)}getMetadata(){return this.metadata}Wu(){return this.elements}bu(){if(this.cursor===this.bundleData.length)return null;const e=this.qu(),t=this.$u(e);return new cJ(JSON.parse(t),e)}$u(e){if(this.cursor+e>this.bundleData.length)throw new D(N.INTERNAL,"Reached the end of bundle when more is expected.");return this.bundleData.slice(this.cursor,this.cursor+=e)}qu(){const e=this.cursor;let t=this.cursor;for(;t<this.bundleData.length;){if("{"===this.bundleData[t]){if(t===e)throw new Error("First character is a bracket and not a number");return this.cursor=t,Number(this.bundleData.slice(e,t))}t++}throw new Error("Reached the end of bundle when more is expected.")}}class uU{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new D(N.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function e(e,t){const n=x(e),r={documents:t.map(e=>s5(n.serializer,e))},s=await n.Ho("BatchGetDocuments",n.serializer.databaseId,H.emptyPath(),r,t.length),i=new Map;s.forEach(e=>{const t=ii(n.serializer,e);i.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{const t=i.get(e.toString());E(!!t,55234,{key:e}),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new s_(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{const n=Z.fromPath(t);this.mutations.push(new sb(n,this.precondition(n)))}),await async function e(e,t){const n=x(e),r={writes:t.map(e=>ia(n.serializer,e))};await n.Go("Commit",n.serializer.databaseId,H.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw b(50498,{Gu:e.constructor.name});t=ef.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new D(N.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(ef.min())?sc.exists(!1):sc.updateTime(t):sc.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(ef.min()))throw new D(N.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return sc.updateTime(t)}return sc.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class uB{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.zu=n.maxAttempts,this.M_=new a3(this.asyncQueue,"transaction_retry")}ju(){this.zu-=1,this.Ju()}Ju(){this.M_.p_(async()=>{const e=new uU(this.datastore),t=this.Hu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.Yu(e)}))}).catch(e=>{this.Yu(e)})})}Hu(e){try{const t=this.updateFunction(e);return!ej(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Yu(e){this.zu>0&&this.Zu(e)?(this.zu-=1,this.asyncQueue.enqueueAndForget(()=>(this.Ju(),Promise.resolve()))):this.deferred.reject(e)}Zu(e){if("FirebaseError"===e?.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!sA(t)}return!1}}const uz="FirestoreClient";class u${constructor(e,t,n,r,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=f.UNAUTHENTICATED,this.clientId=U.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,async e=>{w(uz,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(w(uz,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new C;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){const t=cV(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function uG(e,t){e.asyncQueue.verifyOperationInProgress(),w(uz,"Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await ap(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function uK(e,t){e.asyncQueue.verifyOperationInProgress();const n=await uj(e);w(uz,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>cC(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>cC(t.remoteStore,n)),e._onlineComponents=t}async function uj(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){w(uz,"Using user provided OfflineComponentProvider");try{await uG(e,e._uninitializedComponentsProvider._offline)}catch(n){const t=n;if(!function e(e){return"FirebaseError"===e.name?e.code===N.FAILED_PRECONDITION||e.code===N.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}(t))throw t;I("Error using user provided cache. Falling back to memory cache: "+t),await uG(e,new uk)}}else w(uz,"Using default OfflineComponentProvider"),await uG(e,new uR(void 0));return e._offlineComponents}async function uQ(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(w(uz,"Using user provided OnlineComponentProvider"),await uK(e,e._uninitializedComponentsProvider._online)):(w(uz,"Using default OnlineComponentProvider"),await uK(e,new uO))),e._onlineComponents}function uW(e){return uj(e).then(e=>e.persistence)}function uJ(e){return uj(e).then(e=>e.localStore)}function uH(e){return uQ(e).then(e=>e.remoteStore)}function uY(e){return uQ(e).then(e=>e.syncEngine)}function uX(e){return uQ(e).then(e=>e.datastore)}async function uZ(e){const t=await uQ(e),n=t.eventManager;return n.onListen=c5.bind(null,t.syncEngine),n.onUnlisten=ue.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=c8.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=ut.bind(null,t.syncEngine),n}function u0(e){return e.asyncQueue.enqueue(async()=>{const t=await uW(e),n=await uH(e);return t.setNetworkEnabled(!0),function e(e){const t=x(e);return t.Ea.delete(0),cs(t)}(n)})}function u1(e){return e.asyncQueue.enqueue(async()=>{const t=await uW(e),n=await uH(e);return t.setNetworkEnabled(!1),async function e(e){const t=x(e);t.Ea.add(0),await ci(t),t.Ra.set("Offline")}(n)})}function u2(e,t){const n=new C;return e.asyncQueue.enqueueAndForget(async()=>(async function e(e,t,n){try{const r=await function e(e,t){const n=x(e);return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new D(N.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(r){const e=cV(r,`Failed to get document '${t} from cache`);n.reject(e)}})(await uJ(e),t,n)),n.promise}function u4(e,t,n={}){const r=new C;return e.asyncQueue.enqueueAndForget(async()=>(function e(e,t,n,r,s){const i=new uP({next:a=>{i.Nu(),t.enqueueAndForget(()=>cz(e,o));const c=a.docs.has(n);!c&&a.fromCache?s.reject(new D(N.UNAVAILABLE,"Failed to get document because the client is offline.")):c&&a.fromCache&&r&&"server"===r.source?s.reject(new D(N.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(a)},error:e=>s.reject(e)}),o=new cW(rE(n.path),i,{includeMetadataChanges:!0,qa:!0});return cB(e,o)})(await uZ(e),e.asyncQueue,t,n,r)),r.promise}function u3(e,t){const n=new C;return e.asyncQueue.enqueueAndForget(async()=>(async function e(e,t,n){try{const r=await aE(e,t,!0),s=new c1(t,r.Qs),i=s.ru(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(r){const e=cV(r,`Failed to execute query '${t} against cache`);n.reject(e)}})(await uJ(e),t,n)),n.promise}function u6(e,t,n={}){const r=new C;return e.asyncQueue.enqueueAndForget(async()=>(function e(e,t,n,r,s){const i=new uP({next:n=>{i.Nu(),t.enqueueAndForget(()=>cz(e,o)),n.fromCache&&"server"===r.source?s.reject(new D(N.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new cW(n,i,{includeMetadataChanges:!0,qa:!0});return cB(e,o)})(await uZ(e),e.asyncQueue,t,n,r)),r.promise}function u5(e,t,n){const r=new C;return e.asyncQueue.enqueueAndForget(async()=>{try{const s=await uX(e);r.resolve(async function e(e,t,n){const r=x(e),{request:s,gt:i,parent:o}=id(r.serializer,rC(t),n);r.connection.$o||delete s.parent;const a=(await r.Ho("RunAggregationQuery",r.serializer.databaseId,o,s,1)).filter(e=>!!e.result);E(1===a.length,64727);const c=a[0].result?.aggregateFields;return Object.keys(c).reduce((e,t)=>(e[i[t]]=c[t],e),{})}(s,t,n))}catch(e){r.reject(e)}}),r.promise}function u8(e,t){const n=new uP(t);return e.asyncQueue.enqueueAndForget(async()=>(function e(e,t){x(e).Ca.add(t),t.next()})(await uZ(e),n)),()=>{n.Nu(),e.asyncQueue.enqueueAndForget(async()=>(function e(e,t){x(e).Ca.delete(t)})(await uZ(e),n))}}function u9(e,t,n,r){const s=function e(e,t){let n;n="string"==typeof e?sM().encode(e):e;return function e(e,t){return new uL(e,t)}(function e(e,t){if(e instanceof Uint8Array)return uF(e,t);if(e instanceof ArrayBuffer)return uF(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,a4(t));e.asyncQueue.enqueueAndForget(async()=>{uA(await uY(e),s,r)})}function u7(e,t){return e.asyncQueue.enqueue(async()=>(function e(e,t){const n=x(e);return n.persistence.runTransaction("Get named query","readonly",e=>n.Ii.getNamedQuery(e,t))})(await uJ(e),t))}function le(e,t){return function e(e,t){return new uq(e,t)}(e,t)}function lt(e,t){return e.asyncQueue.enqueue(async()=>(async function e(e,t){const n=x(e),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",e=>r.getFieldIndexes(e).next(n=>(function e(e,t,n,r,s){e=[...e],t=[...t],e.sort(n),t.sort(n);const i=e.length,o=t.length;let a=0,c=0;for(;a<o&&c<i;){const i=n(e[c],t[a]);i<0?s(e[c++]):i>0?r(t[a++]):(a++,c++)}for(;a<o;)r(t[a++]);for(;c<i;)s(e[c++])})(n,t,ew,t=>{s.push(r.addFieldIndex(e,t))},t=>{s.push(r.deleteFieldIndex(e,t))})).next(()=>eC.waitFor(s)))})(await uJ(e),t))}function ln(e,t){return e.asyncQueue.enqueue(async()=>(function e(e,t){x(e).Fs.Vs=t})(await uJ(e),t))}function lr(e){return e.asyncQueue.enqueue(async()=>(function e(e){const t=x(e),n=t.indexManager;return t.persistence.runTransaction("Delete All Indexes","readwrite",e=>n.deleteAllFieldIndexes(e))})(await uJ(e)))}function ls(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const li=new Map;const lo="firestore.googleapis.com",la=!0;class lc{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new D(N.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=lo,this.ssl=la}else this.host=e.host,this.ssl=e.ssl??la;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=og;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<oA)throw new D(N.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}et("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=true:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=ls(e.experimentalLongPollingOptions??{}),function e(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new D(N.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new D(N.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new D(N.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function e(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class lu{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new lc({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new D(N.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new D(N.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new lc(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function e(e){if(!e)return new k;switch(e.type){case"firstParty":return new O(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new D(N.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function e(e){const t=li.get(e);t&&(w("ComponentProvider","Removing Datastore"),li.delete(e),t.terminate())}(this),Promise.resolve()}}function ll(e,t,n,r={}){e=eo(e,lu);const s=(0,o.zJ)(t),i=e._getSettings(),a={...i,emulatorOptions:e._getEmulatorOptions()},c=`${t}:${n}`;s&&((0,o.gE)(`https://${c}`),(0,o.P1)("Firestore",!0)),i.host!==lo&&i.host!==c&&I("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const u={...i,host:c,ssl:s,emulatorOptions:r};if(!(0,o.bD)(u,a)&&(e._setSettings(u),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=f.MOCK_USER;else{t=(0,o.Fy)(r.mockUserToken,e._app?.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new D(N.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new f(s)}e._authCredentials=new R(new A(t,n))}}class lh{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new lh(this.firestore,e,this._query)}}class ld{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lf(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new ld(this.firestore,e,this._key)}toJSON(){return{type:ld._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,n){if(eu(t,ld._jsonSchema))return new ld(e,n||null,new Z(H.fromString(t.referencePath)))}}ld._jsonSchemaVersion="firestore/documentReference/1.0",ld._jsonSchema={type:ec("string",ld._jsonSchemaVersion),referencePath:ec("string")};class lf extends lh{constructor(e,t,n){super(e,t,rE(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new ld(this.firestore,null,new Z(e))}withConverter(e){return new lf(this.firestore,e,this._path)}}function lm(e,t,...n){if(e=getModularInstance(e),ee("collection","path",t),e instanceof lu){const r=H.fromString(t,...n);return er(r),new lf(e,null,r)}{if(!(e instanceof ld||e instanceof lf))throw new D(N.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(H.fromString(t,...n));return er(r),new lf(e.firestore,null,r)}}function lg(e,t){if(e=eo(e,lu),ee("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new D(N.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new lh(e,null,function e(e){return new rb(H.emptyPath(),e)}(t))}function lp(e,t,...n){if(e=(0,o.Ku)(e),1===arguments.length&&(t=U.newId()),ee("doc","path",t),e instanceof lu){const r=H.fromString(t,...n);return en(r),new ld(e,null,new Z(r))}{if(!(e instanceof ld||e instanceof lf))throw new D(N.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(H.fromString(t,...n));return en(r),new ld(e.firestore,e instanceof lf?e.converter:null,new Z(r))}}function ly(e,t){return e=getModularInstance(e),t=getModularInstance(t),(e instanceof ld||e instanceof lf)&&(t instanceof ld||t instanceof lf)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function lw(e,t){return e=getModularInstance(e),t=getModularInstance(t),e instanceof lh&&t instanceof lh&&e.firestore===t.firestore&&rM(e._query,t._query)&&e.converter===t.converter}const lv="AsyncQueue";class lI{constructor(e=Promise.resolve()){this.Xu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new a3(this,"async_queue_retry"),this._c=()=>{const e=a2();e&&w(lv,"Visibility state changed to "+e.visibilityState),this.M_.w_()},this.ac=e;const t=a2();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;const t=a2();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise(()=>{});const t=new C;return this.cc(()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Xu.push(e),this.lc()))}async lc(){if(0!==this.Xu.length){try{await this.Xu[0](),this.Xu.shift(),this.M_.reset()}catch(e){if(!eF(e))throw e;w(lv,"Operation failed with retryable error: "+e)}this.Xu.length>0&&this.M_.p_(()=>this.lc())}}cc(e){const t=this.ac.then(()=>(this.rc=!0,e().catch(e=>{this.nc=e,this.rc=!1;throw v("INTERNAL UNHANDLED ERROR: ",l_(e)),e}).then(e=>(this.rc=!1,e))));return this.ac=t,t}enqueueAfterDelay(e,t,n){this.uc(),this.oc.indexOf(e)>-1&&(t=0);const r=cM.createAndSchedule(this,e,t,n,e=>this.hc(e));return this.tc.push(r),r}uc(){this.nc&&b(47125,{Pc:l_(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do{e=this.ac,await e}while(e!==this.ac)}Ic(e){for(const t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then(()=>{this.tc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const t of this.tc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Tc()})}dc(e){this.oc.push(e)}hc(e){const t=this.tc.indexOf(e);this.tc.splice(t,1)}}function l_(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}function lb(e){return function e(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const e of t)if(e in n&&"function"==typeof n[e])return!0;return!1}(e,["next","error","complete"])}class lT{constructor(){this._progressObserver={},this._taskCompletionResolver=new C,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const lE=null&&-1;class lS extends lu{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new lI,this._persistenceKey=r?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new lI(e),this._firestoreClient=void 0,await e}}}function lx(e,t,n){n||(n=nI);const r=_getProvider(e,"firestore");if(r.isInitialized(n)){const e=r.getImmediate({identifier:n}),s=r.getOptions(n);if(deepEqual(s,t))return e;throw new D(N.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new D(N.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<oA)throw new D(N.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return t.host&&isCloudWorkstation(t.host)&&pingServer(t.host),r.initialize({options:t,instanceIdentifier:n})}function lN(e,t){const n="object"==typeof e?e:(0,r.Sx)(),s="string"==typeof e?e:t||nI,i=(0,r.j6)(n,"firestore").getImmediate({identifier:s});if(!i._initialized){const e=(0,o.yU)("firestore");e&&ll(i,...e)}return i}function lD(e){if(e._terminated)throw new D(N.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||lC(e),e._firestoreClient}function lC(e){const t=e._freezeSettings(),n=function e(e,t,n,r){return new nv(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,ls(r.experimentalLongPollingOptions),r.useFetchStreams,r.isUsingEmulator)}(e._databaseId,e._app?.options.appId||"",e._persistenceKey,t);e._componentsProvider||t.localCache?._offlineComponentProvider&&t.localCache?._onlineComponentProvider&&(e._componentsProvider={_offline:t.localCache._offlineComponentProvider,_online:t.localCache._onlineComponentProvider}),e._firestoreClient=new u$(e._authCredentials,e._appCheckCredentials,e._queue,n,e._componentsProvider&&function e(e){const t=e?._online.build();return{_offline:e?._offline.build(t),_online:t}}(e._componentsProvider))}function lA(e,t){I("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings();return lR(e,uO.provider,{build:e=>new uM(e,n.cacheSizeBytes,t?.forceOwnership)}),Promise.resolve()}async function lk(e){I("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=e._freezeSettings();lR(e,uO.provider,{build:e=>new uV(e,t.cacheSizeBytes)})}function lR(e,t,n){if((e=eo(e,lS))._firestoreClient||e._terminated)throw new D(N.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new D(N.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},lC(e)}function lM(e){if(e._initialized&&!e._terminated)throw new D(N.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new C;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function e(e){if(!eR.v())return Promise.resolve();const t=e+as;await eR.delete(t)}(ac(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}function lV(e){return function e(e){const t=new C;return e.asyncQueue.enqueueAndForget(async()=>uc(await uY(e),t)),t.promise}(lD(e=eo(e,lS)))}function lO(e){return u0(lD(e=eo(e,lS)))}function lF(e){return u1(lD(e=eo(e,lS)))}function lP(e){return _removeServiceInstance(e.app,"firestore",e._databaseId.database),e._delete()}function lL(e,t){const n=lD(e=eo(e,lS)),r=new lT;return u9(n,e._databaseId,t,r),r}function lq(e,t){return u7(lD(e=eo(e,lS)),t).then(t=>t?new lh(e,null,t.query):null)}class lU{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class lB{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class lz{constructor(e){this._byteString=e}static fromBase64String(e){try{return new lz(na.fromBase64String(e))}catch(e){throw new D(N.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new lz(na.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:lz._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(eu(e,lz._jsonSchema))return lz.fromBase64String(e.bytes)}}lz._jsonSchemaVersion="firestore/bytes/1.0",lz._jsonSchema={type:ec("string",lz._jsonSchemaVersion),bytes:ec("string")};class l${constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new D(N.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new X(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}function lG(){return new l$(W)}class lK{constructor(e){this._methodName=e}}class lj{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new D(N.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new D(N.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return B(this._lat,e._lat)||B(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:lj._jsonSchemaVersion}}static fromJSON(e){if(eu(e,lj._jsonSchema))return new lj(e.latitude,e.longitude)}}lj._jsonSchemaVersion="firestore/geoPoint/1.0",lj._jsonSchema={type:ec("string",lj._jsonSchemaVersion),latitude:ec("number"),longitude:ec("number")};class lQ{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function e(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}toJSON(){return{type:lQ._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(eu(e,lQ._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every(e=>"number"==typeof e))return new lQ(e.vectorValues);throw new D(N.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}lQ._jsonSchemaVersion="firestore/vectorValue/1.0",lQ._jsonSchema={type:ec("string",lQ._jsonSchemaVersion),vectorValues:ec("object")};const lW=/^__.*__$/;class lJ{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new sy(e,this.data,this.fieldMask,t,this.fieldTransforms):new sp(e,this.data,t,this.fieldTransforms)}}class lH{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new sy(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function lY(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw b(40011,{Ac:e})}}class lX{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Rc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Ac(){return this.settings.Ac}Vc(e){return new lX({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}mc(e){const t=this.path?.child(e),n=this.Vc({path:t,fc:!1});return n.gc(e),n}yc(e){const t=this.path?.child(e),n=this.Vc({path:t,fc:!1});return n.Rc(),n}wc(e){return this.Vc({path:void 0,fc:!0})}Sc(e){return hc(e,this.settings.methodName,this.settings.bc||!1,this.path,this.settings.Dc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Rc(){if(this.path)for(let e=0;e<this.path.length;e++)this.gc(this.path.get(e))}gc(e){if(0===e.length)throw this.Sc("Document fields must not be empty");if(lY(this.Ac)&&lW.test(e))throw this.Sc('Document fields cannot begin and end with "__"')}}class lZ{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||a4(e)}Cc(e,t,n,r=!1){return new lX({Ac:e,methodName:t,Dc:n,path:X.emptyPath(),fc:!1,bc:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function l0(e){const t=e._freezeSettings(),n=a4(e._databaseId);return new lZ(e._databaseId,!!t.ignoreUndefinedProperties,n)}function l1(e,t,n,r,s,i={}){const o=e.Cc(i.merge||i.mergeFields?2:0,t,n,s);hs("Data must be an object, but it was:",o,r);const a=hn(r,o);let c,u;if(i.merge)c=new ns(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=hi(t,r,n);if(!o.contains(s))throw new D(N.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);hu(e,s)||e.push(s)}c=new ns(e),u=o.fieldTransforms.filter(e=>c.covers(e.field))}else c=null,u=o.fieldTransforms;return new lJ(new nY(a),c,u)}class l2 extends lK{_toFieldTransform(e){if(2!==e.Ac)throw 1===e.Ac?e.Sc(`${this._methodName}() can only appear at the top level of your update data`):e.Sc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof l2}}function l4(e,t,n){return new lX({Ac:3,Dc:t.settings.Dc,methodName:e._methodName,fc:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class l3 extends(null&&lK){_toFieldTransform(e){return new si(e.path,new r8)}isEqual(e){return e instanceof l3}}class l6 extends lK{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){const t=l4(this,e,!0),n=this.vc.map(e=>ht(e,t)),r=new r9(n);return new si(e.path,r)}isEqual(e){return e instanceof l6&&(0,o.bD)(this.vc,e.vc)}}class l5 extends lK{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){const t=l4(this,e,!0),n=this.vc.map(e=>ht(e,t)),r=new se(n);return new si(e.path,r)}isEqual(e){return e instanceof l5&&(0,o.bD)(this.vc,e.vc)}}class l8 extends lK{constructor(e,t){super(e),this.Fc=t}_toFieldTransform(e){const t=new sn(e.serializer,r2(e.serializer,this.Fc));return new si(e.path,t)}isEqual(e){return e instanceof l8&&this.Fc===e.Fc}}function l9(e,t,n,r){const s=e.Cc(1,t,n);hs("Data must be an object, but it was:",s,r);const i=[],a=nY.empty();t6(r,(e,r)=>{const c=ha(t,e,n);r=(0,o.Ku)(r);const u=s.yc(c);if(r instanceof l2)i.push(c);else{const e=ht(r,u);null!=e&&(i.push(c),a.set(c,e))}});const c=new ns(i);return new lH(a,c,s.fieldTransforms)}function l7(e,t,n,r,s,i){const a=e.Cc(1,t,n),c=[hi(t,r,n)],u=[s];if(i.length%2!=0)throw new D(N.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)c.push(hi(t,i[e])),u.push(i[e+1]);const l=[],h=nY.empty();for(let e=c.length-1;e>=0;--e)if(!hu(l,c[e])){const t=c[e];let n=u[e];n=(0,o.Ku)(n);const r=a.yc(t);if(n instanceof l2)l.push(t);else{const e=ht(n,r);null!=e&&(l.push(t),h.set(t,e))}}const d=new ns(l);return new lH(h,d,a.fieldTransforms)}function he(e,t,n,r=!1){return ht(n,e.Cc(r?4:3,t))}function ht(e,t){if(hr(e=(0,o.Ku)(e)))return hs("Unsupported field value:",t,e),hn(e,t);if(e instanceof lK)return function e(e,t){if(!lY(t.Ac))throw t.Sc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Sc(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.fc&&4!==t.Ac)throw t.Sc("Nested arrays are not supported");return function e(e,t){const n=[];let r=0;for(const s of e){let e=ht(s,t.wc(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function e(e,t){if(null===(e=(0,o.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return r2(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=ed.fromDate(e);return{timestampValue:sZ(t.serializer,n)}}if(e instanceof ed){const n=new ed(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:sZ(t.serializer,n)}}if(e instanceof lj)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof lz)return{bytesValue:s0(t.serializer,e._byteString)};if(e instanceof ld){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Sc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:s4(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof lQ)return function e(e,t){const n={fields:{[nb]:{stringValue:nS},[nx]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Sc("VectorValues must only contain numeric values.");return r0(t.serializer,e)})}}}};return{mapValue:n}}(e,t);throw t.Sc(`Unsupported field value: ${ei(e)}`)}(e,t)}function hn(e,t){const n={};return t8(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):t6(e,(e,r)=>{const s=ht(r,t.mc(e));null!=s&&(n[e]=s)}),{mapValue:{fields:n}}}function hr(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ed||e instanceof lj||e instanceof lz||e instanceof ld||e instanceof lK||e instanceof lQ)}function hs(e,t,n){if(!hr(n)||!es(n)){const r=ei(n);throw"an object"===r?t.Sc(e+" a custom object"):t.Sc(e+" "+r)}}function hi(e,t,n){if((t=(0,o.Ku)(t))instanceof l$)return t._internalPath;if("string"==typeof t)return ha(e,t);throw hc("Field path arguments must be of type string or ",e,!1,void 0,n)}const ho=new RegExp("[~\\*/\\[\\]]");function ha(e,t,n){if(t.search(ho)>=0)throw hc(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new l$(...t.split("."))._internalPath}catch(r){throw hc(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function hc(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new D(N.INVALID_ARGUMENT,a+e+c)}function hu(e,t){return e.some(e=>e.isEqual(t))}class hl{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new ld(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new hh(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(hd("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class hh extends hl{data(){return super.data()}}function hd(e,t){return"string"==typeof t?ha(e,t):t instanceof l$?t._internalPath:t._delegate._internalPath}function hf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new D(N.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class hm{}class hg extends hm{}function hp(e,t,...n){let r=[];t instanceof hm&&r.push(t),r=r.concat(n),function e(e){const t=e.filter(e=>e instanceof hv).length,n=e.filter(e=>e instanceof hy).length;if(t>1||t>0&&n>0)throw new D(N.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class hy extends hg{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new hy(e,t,n)}_apply(e){const t=this._parse(e);return hF(e._query,t),new lh(e.firestore,e.converter,rk(e._query,t))}_parse(e){const t=l0(e.firestore),n=function e(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new D(N.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){hO(o,i);const t=[];for(const n of o)t.push(hV(r,e,n));a={arrayValue:{values:t}}}else a=hV(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||hO(o,i),a=he(n,t,o,"in"===i||"not-in"===i);const c=n5.create(s,i,a);return c}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function hw(e,t,n){const r=t,s=hd("where",e);return hy._create(s,r,n)}class hv extends hm{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new hv(e,t)}_parse(e){const t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:n8.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function e(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)hF(n,e),n=rk(n,e)}(e._query,t),new lh(e.firestore,e.converter,rk(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function hI(...e){return e.forEach(e=>hP("or",e)),hv._create("or",e)}function h_(...e){return e.forEach(e=>hP("and",e)),hv._create("and",e)}class hb extends hg{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new hb(e,t)}_apply(e){const t=function e(e,t,n){if(null!==e.startAt)throw new D(N.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new D(N.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new n4(t,n);return r}(e._query,this._field,this._direction);return new lh(e.firestore,e.converter,function e(e,t){const n=e.explicitOrderBy.concat([t]);return new rb(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function hT(e,t="asc"){const n=t,r=hd("orderBy",e);return hb._create(r,n)}class hE extends hg{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new hE(e,t,n)}_apply(e){return new lh(e.firestore,e.converter,rR(e._query,this._limit,this._limitType))}}function hS(e){return ea("limit",e),hE._create("limit",e,"F")}function hx(e){return ea("limitToLast",e),hE._create("limitToLast",e,"L")}class hN extends hg{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new hN(e,t,n)}_apply(e){const t=hM(e,this.type,this._docOrFields,this._inclusive);return new lh(e.firestore,e.converter,function e(e,t){return new rb(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function hD(...e){return hN._create("startAt",e,!0)}function hC(...e){return hN._create("startAfter",e,!1)}class hA extends hg{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new hA(e,t,n)}_apply(e){const t=hM(e,this.type,this._docOrFields,this._inclusive);return new lh(e.firestore,e.converter,function e(e,t){return new rb(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function hk(...e){return hA._create("endBefore",e,!1)}function hR(...e){return hA._create("endAt",e,!0)}function hM(e,t,n,r){if(n[0]=(0,o.Ku)(n[0]),n[0]instanceof hl)return function e(e,t,n,r,s){if(!r)throw new D(N.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of rN(e))if(n.field.isKeyField())i.push(nP(t,r.key));else{const e=r.data.field(n.field);if(np(e))throw new D(N.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new D(N.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new n0(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=l0(e.firestore);return function e(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new D(N.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const c=s[i];if(o[i].field.isKeyField()){if("string"!=typeof c)throw new D(N.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!rx(e)&&-1!==c.indexOf("/"))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(H.fromString(c));if(!Z.isDocumentKey(n))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new Z(n);a.push(nP(t,s))}else{const e=he(n,r,c);a.push(e)}}return new n0(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function hV(e,t,n){if("string"==typeof(n=(0,o.Ku)(n))){if(""===n)throw new D(N.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!rx(t)&&-1!==n.indexOf("/"))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(H.fromString(n));if(!Z.isDocumentKey(r))throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return nP(e,new Z(r))}if(n instanceof ld)return nP(e,n._key);throw new D(N.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ei(n)}.`)}function hO(e,t){if(!Array.isArray(e)||0===e.length)throw new D(N.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function hF(e,t){const n=function e(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function e(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new D(N.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new D(N.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function hP(e,t){if(!(t instanceof hy||t instanceof hv))throw new D(N.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class hL{convertValue(e,t="none"){switch(nD(e)){case 0:return null;case 1:return e.booleanValue;case 2:return nl(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(nh(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw b(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return t6(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){const t=e.fields?.[nx].arrayValue?.values?.map(e=>nl(e.doubleValue));return new lQ(t)}convertGeoPoint(e){return new lj(nl(e.latitude),nl(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":const n=ny(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(nw(e));default:return null}}convertTimestamp(e){const t=nu(e);return new ed(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=H.fromString(e);E(iE(n),9688,{name:e});const r=new n_(n.get(1),n.get(3)),s=new Z(n.popFirst(5));return r.isEqual(t)||v(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function hq(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class hU extends hL{constructor(e){super(),this.firestore=e}convertBytes(e){return new lz(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new ld(this.firestore,null,t)}}function hB(e){return new lU("sum",hi("sum",e))}function hz(e){return new lU("avg",hi("average",e))}function h$(){return new lU("count")}function hG(e,t){return e instanceof lU&&t instanceof lU&&e.aggregateType===t.aggregateType&&e._internalFieldPath?.canonicalString()===t._internalFieldPath?.canonicalString()}function hK(e,t){return lw(e.query,t.query)&&deepEqual(e.data(),t.data())}const hj="NOT SUPPORTED";class hQ{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class hW extends hl{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new hH(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(hd("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new D(N.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const e=this._document,t={};if(t.type=hW._jsonSchemaVersion,t.bundle="",t.bundleSource="DocumentSnapshot",t.bundleName=this._key.toString(),!e||!e.isValidDocument()||!e.isFoundDocument())return t;this._userDataWriter.convertObjectMap(e.data.value.mapValue.fields,"previous");return t.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),t}}function hJ(e,t,n){if(eu(t,hW._jsonSchema)){if(t.bundle===hj)throw new D(N.INVALID_ARGUMENT,"The provided JSON object was created in a client environment, which is not supported.");const r=a4(e._databaseId),s=le(t.bundle,r),i=s.Wu(),o=new cY(s.getMetadata(),r);for(const e of i)o.Ga(e);const a=o.documents;if(1!==a.length)throw new D(N.INVALID_ARGUMENT,`Expected bundle data to contain 1 document, but it contains ${a.length} documents.`);const c=is(r,a[0].document),u=new Z(H.fromString(t.bundleName));return new hW(e,new hU(e),u,c,new hQ(!1,!1),n||null)}}hW._jsonSchemaVersion="firestore/documentSnapshot/1.0",hW._jsonSchema={type:ec("string",hW._jsonSchemaVersion),bundleSource:ec("string","DocumentSnapshot"),bundleName:ec("string"),bundle:ec("string")};class hH extends hW{data(e={}){return super.data(e)}}class hY{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new hQ(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new hH(this._firestore,this._userDataWriter,n.key,n,new hQ(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new D(N.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function e(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{const r=new hH(e._firestore,e._userDataWriter,n.doc.key,n.doc,new hQ(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{const r=new hH(e._firestore,e._userDataWriter,t.doc.key,t.doc,new hQ(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:hZ(t.type),doc:r,oldIndex:s,newIndex:i}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new D(N.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const e={};e.type=hY._jsonSchemaVersion,e.bundleSource="QuerySnapshot",e.bundleName=U.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const t=[],n=[],r=[];return this.docs.forEach(e=>{null!==e._document&&(t.push(e._document),n.push(this._userDataWriter.convertObjectMap(e._document.data.value.mapValue.fields,"previous")),r.push(e.ref.path))}),e.bundle=(this._firestore,this.query._query,e.bundleName,"NOT SUPPORTED"),e}}function hX(e,t,n){if(eu(t,hY._jsonSchema)){if(t.bundle===hj)throw new D(N.INVALID_ARGUMENT,"The provided JSON object was created in a client environment, which is not supported.");const r=a4(e._databaseId),s=le(t.bundle,r),i=s.Wu(),o=new cY(s.getMetadata(),r);for(const e of i)o.Ga(e);if(1!==o.queries.length)throw new D(N.INVALID_ARGUMENT,`Snapshot data expected 1 query but found ${o.queries.length} queries.`);const a=iO(o.queries[0].bundledQuery),c=o.documents;let u=new cO;c.map(e=>{const t=is(r,e.document);u=u.add(t)});const l=cP.fromInitialDocuments(a,u,rY(),!1,!1),h=new lh(e,n||null,a);return new hY(e,new hU(e),h,l)}}function hZ(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return b(61501,{type:e})}}function h0(e,t){return e instanceof hW&&t instanceof hW?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof hY&&t instanceof hY&&e._firestore===t._firestore&&lw(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function h1(e){e=eo(e,ld);const t=eo(e.firestore,lS);return u4(lD(t),e._key).then(n=>da(t,e,n))}hY._jsonSchemaVersion="firestore/querySnapshot/1.0",hY._jsonSchema={type:ec("string",hY._jsonSchemaVersion),bundleSource:ec("string","QuerySnapshot"),bundleName:ec("string"),bundle:ec("string")};class h2 extends hL{constructor(e){super(),this.firestore=e}convertBytes(e){return new lz(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new ld(this.firestore,null,t)}}function h4(e){e=eo(e,ld);const t=eo(e.firestore,lS),n=lD(t),r=new h2(t);return u2(n,e._key).then(n=>new hW(t,r,e._key,n,new hQ(null!==n&&n.hasLocalMutations,!0),e.converter))}function h3(e){e=eo(e,ld);const t=eo(e.firestore,lS);return u4(lD(t),e._key,{source:"server"}).then(n=>da(t,e,n))}function h6(e){e=eo(e,lh);const t=eo(e.firestore,lS),n=lD(t),r=new h2(t);return hf(e._query),u6(n,e._query).then(n=>new hY(t,r,e,n))}function h5(e){e=eo(e,lh);const t=eo(e.firestore,lS),n=lD(t),r=new h2(t);return u3(n,e._query).then(n=>new hY(t,r,e,n))}function h8(e){e=eo(e,lh);const t=eo(e.firestore,lS),n=lD(t),r=new h2(t);return u6(n,e._query,{source:"server"}).then(n=>new hY(t,r,e,n))}function h9(e,t,n){e=eo(e,ld);const r=eo(e.firestore,lS),s=hq(e.converter,t,n);return di(r,[l1(l0(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,sc.none())])}function h7(e,t,n,...r){e=eo(e,ld);const s=eo(e.firestore,lS),i=l0(s);let o;o="string"==typeof(t=getModularInstance(t))||t instanceof l$?l7(i,"updateDoc",e._key,t,n,r):l9(i,"updateDoc",e._key,t);return di(s,[o.toMutation(e._key,sc.exists(!0))])}function de(e){return di(eo(e.firestore,lS),[new s_(e._key,sc.none())])}function dt(e,t){const n=eo(e.firestore,lS),r=lp(e),s=hq(e.converter,t);return di(n,[l1(l0(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,sc.exists(!1))]).then(()=>r)}function dn(e,...t){e=getModularInstance(e);let n={includeMetadataChanges:!1,source:"default"},r=0;"object"!=typeof t[r]||lb(t[r])||(n=t[r++]);const s={includeMetadataChanges:n.includeMetadataChanges,source:n.source};if(lb(t[r])){const e=t[r];t[r]=e.next?.bind(e),t[r+1]=e.error?.bind(e),t[r+2]=e.complete?.bind(e)}let i,o,a;if(e instanceof ld)o=eo(e.firestore,lS),a=rE(e._key.path),i={next:n=>{t[r]&&t[r](da(o,e,n))},error:t[r+1],complete:t[r+2]};else{const n=eo(e,lh);o=eo(n.firestore,lS),a=n._query;const s=new h2(o);i={next:e=>{t[r]&&t[r](new hY(o,s,n,e))},error:t[r+1],complete:t[r+2]},hf(e._query)}return function e(e,t,n,r){const s=new uP(r),i=new cW(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>cB(await uZ(e),i)),()=>{s.Nu(),e.asyncQueue.enqueueAndForget(async()=>cz(await uZ(e),i))}}(lD(o),a,s,i)}function dr(e,t,...n){const r=getModularInstance(e),s=function e(e){const t={bundle:"",bundleName:"",bundleSource:""},n=["bundle","bundleName","bundleSource"];for(const r of n){if(!(r in e)){t.error=`snapshotJson missing required field: ${r}`;break}const n=e[r];if("string"!=typeof n){t.error=`snapshotJson field '${r}' must be a string.`;break}if(0===n.length){t.error=`snapshotJson field '${r}' cannot be an empty string.`;break}"bundle"===r?t.bundle=n:"bundleName"===r?t.bundleName=n:"bundleSource"===r&&(t.bundleSource=n)}return t}(t);if(s.error)throw new D(N.INVALID_ARGUMENT,s.error);let i,o=0;if("object"!=typeof n[o]||lb(n[o])||(i=n[o++]),"QuerySnapshot"===s.bundleSource){let e=null;if("object"==typeof n[o]&&lb(n[o])){const t=n[o++];e={next:t.next,error:t.error,complete:t.complete}}else e={next:n[o++],error:n[o++],complete:n[o++]};return function e(e,t,n,r,s){let i,o=!1;const a=lL(e,t.bundle);return a.then(()=>lq(e,t.bundleName)).then(e=>{if(e&&!o){s&&e.withConverter(s),i=dn(e,n||{},r)}}).catch(e=>(r.error&&r.error(e),()=>{})),()=>{o||(o=!0,i&&i())}}(r,s,i,e,n[o])}if("DocumentSnapshot"===s.bundleSource){let e=null;if("object"==typeof n[o]&&lb(n[o])){const t=n[o++];e={next:t.next,error:t.error,complete:t.complete}}else e={next:n[o++],error:n[o++],complete:n[o++]};return function e(e,t,n,r,s){let i,o=!1;const a=lL(e,t.bundle);return a.then(()=>{if(!o){const o=new ld(e,s||null,Z.fromPath(t.bundleName));i=dn(o,n||{},r)}}).catch(e=>(r.error&&r.error(e),()=>{})),()=>{o||(o=!0,i&&i())}}(r,s,i,e,n[o])}throw new D(N.INVALID_ARGUMENT,`unsupported bundle source: ${s.bundleSource}`)}function ds(e,t){return u8(lD(e=eo(e,lS)),lb(t)?t:{next:t})}function di(e,t){return function e(e,t){const n=new C;return e.asyncQueue.enqueueAndForget(async()=>un(await uY(e),t,n)),n.promise}(lD(e),t)}function da(e,t,n){const r=n.docs.get(t._key),s=new h2(e);return new hW(e,s,t._key,r,new hQ(n.hasPendingWrites,n.fromCache),t.converter)}function dc(e){return du(e,{count:h$()})}function du(e,t){const n=eo(e.firestore,lS),r=lD(n),s=t5(t,(e,t)=>new sx(t,e.aggregateType,e._internalFieldPath));return u5(r,e._query,s).then(t=>(function e(e,t,n){const r=new h2(e),s=new lB(t,r,n);return s})(n,e,t))}class dl{constructor(e){this.kind="memory",this._onlineComponentProvider=uO.provider,this._offlineComponentProvider=e?.garbageCollector?e.garbageCollector._offlineComponentProvider:{build:()=>new uR(void 0)}}toJSON(){return{kind:this.kind}}}class dh{constructor(e){let t;this.kind="persistent",e?.tabManager?(e.tabManager._initialize(e),t=e.tabManager):(t=dI(void 0),t._initialize(e)),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class dd{constructor(){this.kind="memoryEager",this._offlineComponentProvider=uk.provider}toJSON(){return{kind:this.kind}}}class df{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new uR(e)}}toJSON(){return{kind:this.kind}}}function dm(){return new dd}function dg(e){return new df(e?.cacheSizeBytes)}function dp(e){return new dl(e)}function dy(e){return new dh(e)}class dw{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=uO.provider,this._offlineComponentProvider={build:t=>new uM(t,e?.cacheSizeBytes,this.forceOwnership)}}}class dv{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=uO.provider,this._offlineComponentProvider={build:t=>new uV(t,e?.cacheSizeBytes)}}}function dI(e){return new dw(e?.forceOwnership)}function d_(){return new dv}const db={maxAttempts:5};class dT{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=l0(e)}set(e,t,n){this._verifyNotCommitted();const r=dE(e,this._firestore),s=hq(r.converter,t,n),i=l1(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,sc.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=dE(e,this._firestore);let i;return i="string"==typeof(t=getModularInstance(t))||t instanceof l$?l7(this._dataReader,"WriteBatch.update",s._key,t,n,r):l9(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,sc.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=dE(e,this._firestore);return this._mutations=this._mutations.concat(new s_(t._key,sc.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new D(N.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function dE(e,t){if((e=(0,o.Ku)(e)).firestore!==t)throw new D(N.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class dS{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=l0(e)}get(e){const t=dE(e,this._firestore),n=new hU(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return b(24041);const r=e[0];if(r.isFoundDocument())return new hl(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new hl(this._firestore,n,t._key,null,t.converter);throw b(18433,{doc:r})})}set(e,t,n){const r=dE(e,this._firestore),s=hq(r.converter,t,n),i=l1(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=dE(e,this._firestore);let i;return i="string"==typeof(t=(0,o.Ku)(t))||t instanceof l$?l7(this._dataReader,"Transaction.update",s._key,t,n,r):l9(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=dE(e,this._firestore);return this._transaction.delete(t._key),this}}class dx extends dS{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=dE(e,this._firestore),n=new h2(this._firestore);return super.get(e).then(e=>new hW(this._firestore,n,t._key,e._document,new hQ(!1,!1),t.converter))}}function dN(e,t,n){e=eo(e,lS);const r={...db,...n};!function e(e){if(e.maxAttempts<1)throw new D(N.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r);return function e(e,t,n){const r=new C;return e.asyncQueue.enqueueAndForget(async()=>{const s=await uX(e);new uB(e.asyncQueue,s,n,t,r).ju()}),r.promise}(lD(e),n=>t(new dx(e,n)),r)}function dD(){return new l2("deleteField")}function dC(){return new l3("serverTimestamp")}function dA(...e){return new l6("arrayUnion",e)}function dk(...e){return new l5("arrayRemove",e)}function dR(e){return new l8("increment",e)}function dM(e){return new lQ(e)}function dV(e){return lD(e=eo(e,lS)),new dT(e,t=>di(e,t))}function dO(e,t){const n=lD(e=eo(e,lS));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return I("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function e(e){const t="string"==typeof e?function e(e){try{return JSON.parse(e)}catch(e){throw new D(N.INVALID_ARGUMENT,"Failed to parse JSON: "+e?.message)}}(e):e,n=[];if(Array.isArray(t.indexes))for(const e of t.indexes){const t=dF(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(const t of e.fields){const e=ha("setIndexConfiguration",dF(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new ev(e,2)):"ASCENDING"===t.order?r.push(new ev(e,0)):"DESCENDING"===t.order&&r.push(new ev(e,1))}n.push(new eg(eg.UNKNOWN_ID,t,r,e_.empty()))}return n}(t);return lt(n,r)}function dF(e,t){if("string"!=typeof e[t])throw new D(N.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class dP{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function dL(e){e=eo(e,lS);const t=d$.get(e);if(t)return t;const n=lD(e);if("persistent"!==n._uninitializedComponentsProvider?._offline.kind)return null;const r=new dP(e);return d$.set(e,r),r}function dq(e){dz(e,!0)}function dU(e){dz(e,!1)}function dB(e){lr(lD(e._firestore)).then(e=>w("deleting all persistent cache indexes succeeded")).catch(e=>I("deleting all persistent cache indexes failed",e))}function dz(e,t){ln(lD(e._firestore),t).then(e=>w(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>I(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}const d$=new WeakMap;function dG(e){const t=lD(eo(e.firestore,lS)),n=t._onlineComponents?.datastore.serializer;return void 0===n?null:ih(n,rD(e._query)).ft}function dK(e,t){const n=t5(t,(e,t)=>new sx(t,e.aggregateType,e._internalFieldPath)),r=lD(eo(e.firestore,lS)),s=r._onlineComponents?.datastore.serializer;return void 0===s?null:id(s,rC(e._query),n,!0).request}class dj{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return dQ.instance.onExistenceFilterMismatch(e)}}class dQ{constructor(){this.Mc=new Map}static get instance(){return dW||(dW=new dQ,function e(e){if(sR)throw new Error("a TestingHooksSpi instance is already set");sR=e}(dW)),dW}lt(e){this.Mc.forEach(t=>t(e))}onExistenceFilterMismatch(e){const t=Symbol(),n=this.Mc;return n.set(t,e),()=>n.delete(t)}}let dW=null;!function e(t,n=!0){!function e(e){m=e}(r.MF),(0,r.om)(new s.uA("firestore",(e,{instanceIdentifier:t,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new lS(new M(e.getProvider("auth-internal")),new P(s,e.getProvider("app-check-internal")),function e(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new D(N.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new n_(e.options.projectId,t)}(s,t),s);return r={useFetchStreams:n,...r},i._setSettings(r),i},"PUBLIC").setMultipleInstances(!0)),(0,r.KO)(h,d,t),(0,r.KO)(h,d,"esm2020")}()}}]);