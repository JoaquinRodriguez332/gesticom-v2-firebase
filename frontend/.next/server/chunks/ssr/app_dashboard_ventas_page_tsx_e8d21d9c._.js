module.exports=[97064,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944);a.i(79973);var e=a.i(38422),f=a.i(40695),g=a.i(5522),h=a.i(3130),i=a.i(54161),j=a.i(65733),k=a.i(77687),l=a.i(87532),m=a.i(38784),n=a.i(15618),o=a.i(70106);let p=(0,o.default)("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);var q=a.i(81560),r=a.i(90166),s=a.i(83497);let t=(0,o.default)("Scan",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]),u=(0,o.default)("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]),v=(0,o.default)("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),w=(0,o.default)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),x=(0,o.default)("Receipt",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z",key:"q3az6g"}],["path",{d:"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8",key:"1h4pet"}],["path",{d:"M12 17.5v-11",key:"1jc1ny"}]]);var y=a.i(210);let z=(0,o.default)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);var A=a.i(69265),B=a.i(53250),C=a.i(11339);function D(){let{usuario:a,isAuthenticated:o,isLoading:D,hasRole:E}=(0,e.useAuth)(),F=(0,d.useRouter)(),[G,H]=(0,c.useState)([]),[I,J]=(0,c.useState)([]),[K,L]=(0,c.useState)([]),[M,N]=(0,c.useState)(""),[O,P]=(0,c.useState)(""),[Q,R]=(0,c.useState)("venta"),[S,T]=(0,c.useState)(!1),[U,V]=(0,c.useState)(null),[W,X]=(0,c.useState)(!1);(0,c.useEffect)(()=>{D||o?o&&Y():F.push("/login")},[o,D,F]);let Y=async()=>{try{let[a,b]=await Promise.all([B.productosApi.getAll(),B.ventasApi.getAll()]);H(a),L(b)}catch(a){console.error("Error cargando datos:",a),(0,k.toast)({title:"Error",description:"No se pudieron cargar los datos.",variant:"destructive"})}},Z=()=>{if(!O.trim())return;let a=G.find(a=>a.codigo===O.trim());a?(_(a),P(""),(0,k.toast)({title:"Producto agregado",description:a.nombre})):(0,k.toast)({title:"No encontrado",description:"Código no registrado",variant:"destructive"})},$=G.filter(a=>a.nombre.toLowerCase().includes(M.toLowerCase())||a.codigo.includes(M)),_=a=>{if(a.stock<=0)return void(0,k.toast)({title:"Sin stock",description:`No queda stock de ${a.nombre}`,variant:"destructive"});let b=I.find(b=>b.producto.id===a.id);if(b){if(b.cantidad>=a.stock)return void(0,k.toast)({title:"Stock insuficiente",description:"No puedes agregar más unidades de las disponibles.",variant:"destructive"});aa(a.id,b.cantidad+1)}else J([...I,{producto:a,cantidad:1,subtotal:a.precio}])},aa=(a,b)=>{if(b<=0)return void ab(a);let c=G.find(b=>b.id===a);c&&b>c.stock?(0,k.toast)({title:"Stock límite alcanzado",variant:"destructive"}):J(I.map(c=>c.producto.id===a?{...c,cantidad:b,subtotal:c.producto.precio*b}:c))},ab=a=>{J(I.filter(b=>b.producto.id!==a))},ac=()=>I.reduce((a,b)=>a+b.subtotal,0),ad=async()=>{if(0===I.length)return void(0,k.toast)({title:"Carrito vacío",description:"Agrega productos antes de procesar.",variant:"destructive"});T(!0);try{let b=ac(),c=await B.ventasApi.create({total:b,fecha:new Date().toISOString(),vendedor_email:a?.email||"desconocido",estado:"completada",items:I.map(a=>({producto_id:a.producto.id,producto_nombre:a.producto.nombre,cantidad:a.cantidad,precio_unitario:a.producto.precio,subtotal:a.subtotal}))});V(c),X(!0),J([]),Y(),(0,k.toast)({title:"Venta exitosa",description:"La venta se ha registrado correctamente."})}catch(a){console.error("Error al procesar venta:",a),(0,k.toast)({title:"Error",description:"Hubo un problema al procesar la venta.",variant:"destructive"})}finally{T(!1)}},ae=async a=>{if(!E("admin"))return void(0,k.toast)({title:"Permiso denegado",description:"Solo administradores pueden anular ventas",variant:"destructive"});if(confirm("¿Estás seguro de anular esta venta? El stock será devuelto."))try{await B.ventasApi.anular(a),(0,k.toast)({title:"Venta anulada",description:"El stock ha sido restaurado."}),Y()}catch(a){console.error(a),(0,k.toast)({title:"Error",description:"No se pudo anular la venta.",variant:"destructive"})}};return D?null:(0,b.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,b.jsx)(A.default,{}),(0,b.jsxs)("main",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 space-y-6",children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)(f.Button,{variant:"outline",size:"icon",onClick:()=>F.push("/dashboard"),children:(0,b.jsx)(y.ArrowLeft,{className:"h-4 w-4"})}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[(0,b.jsx)(m.ShoppingCart,{className:"h-6 w-6"}),"Punto de Venta"]}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"Gestiona ventas y devoluciones"})]})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsxs)(f.Button,{variant:"venta"===Q?"default":"outline",onClick:()=>R("venta"),children:[(0,b.jsx)(m.ShoppingCart,{className:"h-4 w-4 mr-2"}),"Nueva Venta"]}),(0,b.jsxs)(f.Button,{variant:"historial"===Q?"default":"outline",onClick:()=>R("historial"),children:[(0,b.jsx)(u,{className:"h-4 w-4 mr-2"}),"Historial"]})]})]}),"venta"===Q?(0,b.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,b.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,b.jsxs)(h.Card,{children:[(0,b.jsx)(h.CardHeader,{className:"pb-3",children:(0,b.jsxs)(h.CardTitle,{className:"text-base flex items-center",children:[(0,b.jsx)(t,{className:"h-4 w-4 mr-2"})," Escáner"]})}),(0,b.jsx)(h.CardContent,{children:(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)(g.Input,{placeholder:"Código de barras...",value:O,onChange:a=>P(a.target.value),onKeyDown:a=>"Enter"===a.key&&Z(),autoFocus:!0}),(0,b.jsx)(f.Button,{onClick:Z,children:(0,b.jsx)(l.Search,{className:"h-4 w-4"})})]})})]}),(0,b.jsxs)(h.Card,{className:"flex-1",children:[(0,b.jsx)(h.CardHeader,{className:"pb-3",children:(0,b.jsxs)(h.CardTitle,{className:"text-base flex items-center",children:[(0,b.jsx)(s.Package,{className:"h-4 w-4 mr-2"})," Catálogo"]})}),(0,b.jsxs)(h.CardContent,{children:[(0,b.jsx)(g.Input,{placeholder:"Filtrar productos...",value:M,onChange:a=>N(a.target.value),className:"mb-4"}),(0,b.jsxs)("div",{className:"h-[400px] overflow-y-auto pr-2 space-y-2",children:[$.map(a=>(0,b.jsxs)("div",{onClick:()=>_(a),className:"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer transition-all active:scale-[0.99]",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-medium text-sm",children:a.nombre}),(0,b.jsx)("p",{className:"text-xs text-gray-500 font-mono",children:a.codigo})]}),(0,b.jsxs)("div",{className:"text-right",children:[(0,b.jsx)("p",{className:"font-bold text-sm",children:(0,C.formatearPrecio)(a.precio)}),(0,b.jsxs)(i.Badge,{variant:a.stock>0?"secondary":"destructive",className:"text-xs",children:["Stock: ",a.stock]})]})]},a.id)),0===$.length&&(0,b.jsx)("p",{className:"text-center text-gray-400 py-8",children:"No se encontraron productos"})]})]})]})]}),(0,b.jsx)("div",{className:"space-y-6",children:(0,b.jsxs)(h.Card,{className:"h-full flex flex-col border-primary/20 shadow-md",children:[(0,b.jsx)(h.CardHeader,{className:"bg-primary/5 pb-3",children:(0,b.jsxs)(h.CardTitle,{className:"flex justify-between items-center text-base",children:[(0,b.jsx)("span",{children:"Carrito"}),(0,b.jsxs)(i.Badge,{variant:"default",children:[I.length," Items"]})]})}),(0,b.jsxs)(h.CardContent,{className:"flex-1 flex flex-col p-0",children:[0===I.length?(0,b.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 p-8 min-h-[300px]",children:[(0,b.jsx)(m.ShoppingCart,{className:"h-12 w-12 mb-2 opacity-20"}),(0,b.jsx)("p",{children:"Carrito vacío"})]}):(0,b.jsx)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 min-h-[300px]",children:I.map(a=>(0,b.jsxs)("div",{className:"flex justify-between items-start border-b pb-3 last:border-0",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("p",{className:"text-sm font-medium",children:a.producto.nombre}),(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:[(0,C.formatearPrecio)(a.producto.precio)," c/u"]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,b.jsx)(f.Button,{variant:"outline",size:"icon",className:"h-6 w-6",onClick:()=>aa(a.producto.id,a.cantidad-1),children:(0,b.jsx)(p,{className:"h-3 w-3"})}),(0,b.jsx)("span",{className:"text-sm w-8 text-center",children:a.cantidad}),(0,b.jsx)(f.Button,{variant:"outline",size:"icon",className:"h-6 w-6",onClick:()=>aa(a.producto.id,a.cantidad+1),children:(0,b.jsx)(n.Plus,{className:"h-3 w-3"})})]})]}),(0,b.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,b.jsx)("span",{className:"font-bold text-sm",children:(0,C.formatearPrecio)(a.subtotal)}),(0,b.jsx)(f.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-400 hover:text-red-600",onClick:()=>ab(a.producto.id),children:(0,b.jsx)(q.Trash2,{className:"h-4 w-4"})})]})]},a.producto.id))}),(0,b.jsxs)("div",{className:"p-4 bg-gray-50 border-t mt-auto",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center mb-4 text-xl font-bold",children:[(0,b.jsx)("span",{children:"Total"}),(0,b.jsx)("span",{children:(0,C.formatearPrecio)(ac())})]}),(0,b.jsx)(f.Button,{className:"w-full h-12 text-lg",disabled:0===I.length||S,onClick:ad,children:S?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(z,{className:"h-5 w-5 mr-2 animate-spin"})," Procesando..."]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(r.DollarSign,{className:"h-5 w-5 mr-2"})," Pagar"]})})]})]})]})})]}):(0,b.jsxs)(h.Card,{children:[(0,b.jsx)(h.CardHeader,{children:(0,b.jsxs)(h.CardTitle,{className:"flex items-center gap-2",children:[(0,b.jsx)(u,{className:"h-5 w-5"})," Últimas Ventas"]})}),(0,b.jsx)(h.CardContent,{children:(0,b.jsxs)("div",{className:"space-y-4",children:[K.map(a=>(0,b.jsxs)("div",{className:"border rounded-lg p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:bg-gray-50 transition-colors",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,b.jsxs)("span",{className:"font-bold text-gray-900",children:["#",a.id.slice(0,8),"..."]}),(0,b.jsx)(i.Badge,{variant:"anulada"===a.estado?"destructive":"default",children:a.estado})]}),(0,b.jsxs)("p",{className:"text-xs text-gray-500 flex items-center gap-2",children:[new Date(a.fecha).toLocaleString("es-CL"),(0,b.jsx)("span",{children:"•"}),a.vendedor_email]}),(0,b.jsx)("div",{className:"mt-2 text-sm text-gray-600",children:a.items.map((a,c)=>(0,b.jsxs)("span",{className:"mr-3 block sm:inline",children:[a.cantidad,"x ",a.producto_nombre]},c))})]}),(0,b.jsxs)("div",{className:"flex flex-col items-end gap-2 w-full md:w-auto",children:[(0,b.jsx)("span",{className:"text-xl font-bold",children:(0,C.formatearPrecio)(a.total)}),E("admin")&&"completada"===a.estado&&(0,b.jsx)(f.Button,{variant:"outline",size:"sm",className:"text-red-600 hover:bg-red-50 hover:text-red-700",onClick:()=>ae(a.id),children:"Anular Venta"})]})]},a.id)),0===K.length&&(0,b.jsx)("div",{className:"text-center text-gray-500 py-8",children:"No hay ventas registradas"})]})})]})]}),(0,b.jsx)(j.Dialog,{open:W,onOpenChange:X,children:(0,b.jsxs)(j.DialogContent,{className:"sm:max-w-md",children:[(0,b.jsx)(j.DialogHeader,{children:(0,b.jsxs)(j.DialogTitle,{className:"flex items-center text-green-600 gap-2",children:[(0,b.jsx)(w,{className:"h-6 w-6"})," Venta Completada"]})}),U&&(0,b.jsxs)("div",{className:"space-y-6 py-4",children:[(0,b.jsxs)("div",{className:"text-center bg-green-50 p-6 rounded-xl border border-green-100",children:[(0,b.jsx)("p",{className:"text-sm text-green-800 font-medium mb-1",children:"Total Pagado"}),(0,b.jsx)("p",{className:"text-4xl font-bold text-green-700",children:(0,C.formatearPrecio)(U.total)})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,b.jsxs)(f.Button,{className:"w-full",variant:"outline",onClick:()=>{if(!U)return;let a=window.open("","_blank");if(!a)return;let b=`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Boleta #${U.id.slice(0,8)}</title>
        <style>
          body { font-family: 'Courier New', monospace; width: 300px; margin: 0; padding: 20px; }
          .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
          .item { display: flex; justify-content: space-between; margin: 5px 0; }
          .total { border-top: 2px solid #000; padding-top: 10px; margin-top: 15px; font-weight: bold; }
          .footer { text-align: center; margin-top: 20px; font-size: 12px; }
        </style>
      </head>
      <body>
        <div class="header">
          <h2>GESTICOM</h2>
          <p>Boleta de Venta</p>
          <p>Ref: ${U.id.slice(0,8)}</p>
          <p>${new Date(U.fecha).toLocaleString("es-CL")}</p>
          <p>Vendedor: ${U.vendedor_email}</p>
        </div>
        
        <div class="items">
          ${U.items.map(a=>`
            <div class="item">
              <span>${a.cantidad}x ${a.producto_nombre}</span>
              <span>${(0,C.formatearPrecio)(a.subtotal)}</span>
            </div>
          `).join("")}
        </div>
        
        <div class="total">
          <div class="item">
            <span>TOTAL:</span>
            <span>${(0,C.formatearPrecio)(U.total)}</span>
          </div>
        </div>
        
        <div class="footer">
          <p>\xa1Gracias por su compra!</p>
        </div>
      </body>
      </html>
    `;a.document.write(b),a.document.close(),a.print()},children:[(0,b.jsx)(v,{className:"h-4 w-4 mr-2"})," Imprimir"]}),(0,b.jsxs)(f.Button,{className:"w-full",onClick:()=>X(!1),children:[(0,b.jsx)(x,{className:"h-4 w-4 mr-2"})," Nueva Venta"]})]})]})]})})]})}a.s(["default",()=>D],97064)}];

//# sourceMappingURL=app_dashboard_ventas_page_tsx_e8d21d9c._.js.map